# 修复图片上传路径问题

## 问题分析

用户上传图片后，后端返回的路径是：
```
http://localhost:8080/image?imageName=file17669247184001003bottle.tif
```

但前端无法访问，因为：
1. 前端运行在服务器上，无法访问 `localhost:8080`
2. 应该使用 `/api/image?imageName=xxx` 通过 Nginx 代理

## 解决方案

### 方案 1：修改后端返回相对路径（推荐）

修改后端代码，返回相对路径而不是完整 URL。

**修改 `FileController.java`**：

```java
// 将
return ResultVo.success(baseUrl+"/image?imageName="+fileName);

// 改为
return ResultVo.success("/api/image?imageName="+fileName);
```

### 方案 2：通过环境变量配置 baseUrl

在 `docker-compose.prod.yml` 中添加环境变量：

```yaml
environment:
  - BASE_URL=/api
  # 或者使用服务器IP
  - BASE_URL=http://你的服务器IP:8080
```

然后修改 `application.properties`：

```properties
# 使用环境变量，如果没有则使用默认值
baseUrl=${BASE_URL:http://localhost:8080}
```

### 方案 3：修改后端代码使用环境变量

修改 `FileController.java`：

```java
@Value("${baseUrl:}")
private String baseUrl;

public ResultVo uploadFile(...) {
    // ...
    String imageUrl = baseUrl.isEmpty() 
        ? "/api/image?imageName=" + fileName
        : baseUrl + "/image?imageName=" + fileName;
    return ResultVo.success(imageUrl);
}
```

## 立即修复（临时方案）

在服务器上更新已上传的图片路径：

```bash
cd /opt/campus-trading-platform

# 更新数据库中的图片路径
sudo docker compose exec mysql mysql -u root -proot123456 second_hand_trading << 'EOF'
UPDATE sh_idle_item 
SET picture_list = REPLACE(picture_list, 'http://localhost:8080', '/api')
WHERE picture_list LIKE '%localhost%';

UPDATE sh_idle_item 
SET picture_list = REPLACE(picture_list, 'http://Localhost:8080', '/api')
WHERE picture_list LIKE '%Localhost%';
EOF

# 验证
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "USE second_hand_trading; SELECT id, picture_list FROM sh_idle_item WHERE picture_list LIKE '%localhost%' LIMIT 5;" 2>&1
```

## 永久修复（修改代码）

需要修改后端代码，让上传时返回正确的路径。

