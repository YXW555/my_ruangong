{"remainingRequest":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\src\\components\\page\\chat.vue?vue&type=style&index=0&id=810d4210&scoped=true&lang=css&","dependencies":[{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\src\\components\\page\\chat.vue","mtime":1767248562324},{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\css-loader\\index.js","mtime":1678197338000},{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":1678197338000},{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\postcss-loader\\src\\index.js","mtime":1678197338000},{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1678197338000},{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\vue-loader\\lib\\index.js","mtime":1678197338000}],"contextDependencies":[],"result":["\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n.chat-container {\n    height: 85vh;\n    display: flex;\n    border: 1px solid #ebeef5;\n    border-radius: 8px;\n    overflow: hidden;\n}\n\n.chat-session-list {\n    width: 320px;\n    overflow-y: auto;\n    border-right: 1px solid #ebeef5;\n    background-color: #f5f7fa;\n    display: flex;\n    flex-direction: column;\n}\n\n.session-list-header {\n    padding: 16px;\n    font-size: 16px;\n    font-weight: 600;\n    border-bottom: 1px solid #ebeef5;\n    background-color: #e6f7ff;\n    color: #1890ff;\n}\n\n.session-empty {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: #909399;\n    font-size: 13px;\n    padding: 20px;\n    text-align: center;\n}\n\n.session-item {\n    display: flex;\n    padding: 12px 16px;\n    cursor: pointer;\n    transition: background-color 0.2s;\n    border-bottom: 1px solid #f0f0f0;\n}\n\n.session-item:hover {\n    background-color: #f0f8ff;\n}\n\n.session-item.active {\n    background-color: #1890ff;\n    color: white;\n}\n\n.session-item.active .session-name,\n.session-item.active .session-time,\n.session-item.active .session-last,\n.session-item.active .session-goods-name {\n    color: white;\n}\n\n.session-avatar {\n    width: 46px;\n    height: 46px;\n    border-radius: 50%;\n    border: 2px solid #e6f7ff;\n}\n\n.session-item.active .session-avatar {\n    border-color: white;\n}\n\n.session-info {\n    flex: 1;\n    margin-left: 12px;\n    display: flex;\n    flex-direction: column;\n    justify-content: center;\n}\n\n.session-top {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 6px;\n}\n\n.session-name {\n    font-size: 14px;\n    font-weight: 600;\n    color: #303133;\n    max-width: 140px;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n}\n\n.session-time {\n    font-size: 12px;\n    color: #909399;\n}\n\n.session-bottom {\n    font-size: 13px;\n    color: #606266;\n    display: flex;\n    align-items: center;\n}\n\n.session-last {\n    max-width: 170px;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n}\n\n.session-goods-name {\n    margin-left: 4px;\n    color: #909399;\n    max-width: 110px;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n}\n\n.chat-session-panel {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    background-color: #f8fafc;\n    overflow: hidden; /* 防止子元素溢出 */\n}\n\n.chat-header {\n    height: 68px;\n    border-bottom: 1px solid #e8e8e8;\n    display: flex;\n    align-items: center;\n    padding: 0 20px;\n    background-color: white;\n    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);\n}\n\n.chat-header-left {\n    display: flex;\n    align-items: center;\n}\n\n.chat-header-text {\n    margin-left: 12px;\n}\n\n.chat-header-name {\n    font-size: 16px;\n    font-weight: 600;\n    color: #303133;\n}\n\n.chat-header-sub {\n    margin-top: 4px;\n    font-size: 13px;\n    color: #666;\n}\n\n.chat-header-empty {\n    font-size: 14px;\n    color: #909399;\n    text-align: center;\n    width: 100%;\n}\n\n.chat-message-list {\n    flex: 1;\n    padding: 20px;\n    overflow-y: auto; /* 消息列表独立滚动 */\n    background-color: #f8fafc;\n    background-image:\n        radial-gradient(#e3e8f1 1px, transparent 1px),\n        radial-gradient(#e3e8f1 1px, transparent 1px);\n    background-size: 20px 20px;\n    background-position: 0 0, 10px 10px;\n}\n\n.chat-message-empty {\n    height: 100%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: #909399;\n    font-size: 14px;\n    background: rgba(255, 255, 255, 0.8);\n    border-radius: 8px;\n    padding: 30px;\n    backdrop-filter: blur(2px);\n}\n\n.chat-message-row {\n    display: flex;\n    margin-bottom: 16px;\n    animation: fadeIn 0.3s ease-out;\n}\n\n@keyframes fadeIn {\n    from {\n        opacity: 0;\n        transform: translateY(10px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n.chat-message-row.self {\n    flex-direction: row-reverse;\n}\n\n.chat-message-avatar {\n    margin: 0 10px;\n    border: 2px solid white;\n    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n}\n\n.chat-message-bubble {\n    max-width: 65%;\n    padding: 12px 16px;\n    border-radius: 12px;\n    background-color: white;\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\n    position: relative;\n}\n\n.chat-message-row.other .chat-message-bubble {\n    background-color: #ffffff;\n    border: 1px solid #e8e8e8;\n}\n\n.chat-message-row.self .chat-message-bubble {\n    background: linear-gradient(135deg, #1890ff, #096dd9);\n    color: white;\n    box-shadow: 0 2px 8px rgba(24, 144, 255, 0.3);\n}\n\n/* 添加小箭头效果 */\n.chat-message-row.other .chat-message-bubble::before {\n    content: '';\n    position: absolute;\n    left: -6px;\n    top: 12px;\n    width: 0;\n    height: 0;\n    border-top: 6px solid transparent;\n    border-bottom: 6px solid transparent;\n    border-right: 6px solid white;\n}\n\n.chat-message-row.self .chat-message-bubble::before {\n    content: '';\n    position: absolute;\n    right: -6px;\n    top: 12px;\n    width: 0;\n    height: 0;\n    border-top: 6px solid transparent;\n    border-bottom: 6px solid transparent;\n    border-left: 6px solid #1890ff;\n}\n\n.chat-message-content {\n    font-size: 14px;\n    line-height: 1.5;\n    word-break: break-word;\n}\n\n.chat-message-row.self .chat-message-content {\n    color: white;\n}\n\n.chat-message-time {\n    margin-top: 6px;\n    font-size: 11px;\n    color: #999;\n    text-align: right;\n    opacity: 0.8;\n}\n\n.chat-message-row.self .chat-message-time {\n    color: rgba(255, 255, 255, 0.85);\n}\n\n.chat-image {\n    max-width: 200px;\n    max-height: 200px;\n    border-radius: 8px;\n    cursor: pointer;\n}\n\n.chat-input-bar {\n    border-top: 1px solid #e8e8e8;\n    padding: 16px 20px;\n    background-color: white;\n    box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.05);\n}\n\n/* 优化文本输入框 */\n.el-textarea {\n    border-radius: 8px;\n    overflow: hidden;\n}\n\n.el-textarea >>> .el-textarea__inner {\n    border: 1px solid #d9d9d9;\n    border-radius: 8px;\n    padding: 12px;\n    font-size: 14px;\n    transition: all 0.3s;\n    background-color: #fafafa;\n}\n\n.el-textarea >>> .el-textarea__inner:focus {\n    border-color: #1890ff;\n    box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);\n    background-color: white;\n}\n\n.el-textarea >>> .el-input__count {\n    background: transparent;\n    color: #999;\n}\n\n.chat-input-actions {\n    display: flex;\n    justify-content: flex-end;\n    margin-top: 12px;\n}\n\n/* 优化发送按钮 */\n.el-button--primary {\n    background: linear-gradient(135deg, #1890ff, #096dd9);\n    border: none;\n    border-radius: 6px;\n    padding: 10px 24px;\n    font-weight: 500;\n    transition: all 0.3s;\n}\n\n.el-button--primary:hover {\n    background: linear-gradient(135deg, #40a9ff, #1890ff);\n    box-shadow: 0 4px 12px rgba(24, 144, 255, 0.3);\n    transform: translateY(-1px);\n}\n\n.el-button--primary:active {\n    transform: translateY(0);\n}\n\n.el-button--primary.is-disabled {\n    background: #f5f5f5;\n    color: #bfbfbf;\n    cursor: not-allowed;\n    transform: none;\n    box-shadow: none;\n}\n\n/* 滚动条优化 */\n.chat-session-list,\n.chat-message-list {\n    scrollbar-width: thin;\n    scrollbar-color: #c1c1c1 #f5f5f5;\n}\n\n.chat-session-list::-webkit-scrollbar,\n.chat-message-list::-webkit-scrollbar {\n    width: 6px;\n}\n\n.chat-session-list::-webkit-scrollbar-track,\n.chat-message-list::-webkit-scrollbar-track {\n    background: #f5f5f5;\n}\n\n.chat-session-list::-webkit-scrollbar-thumb,\n.chat-message-list::-webkit-scrollbar-thumb {\n    background-color: #c1c1c1;\n    border-radius: 3px;\n}\n\n.chat-session-list::-webkit-scrollbar-thumb:hover,\n.chat-message-list::-webkit-scrollbar-thumb:hover {\n    background-color: #a8a8a8;\n}\n\n@media (max-width: 900px) {\n    .chat-container {\n        flex-direction: column;\n    }\n\n    .chat-session-list {\n        width: 100%;\n        border-right: none;\n        border-bottom: 1px solid #ebeef5;\n        max-height: 300px;\n        overflow-y: auto;\n    }\n\n    .chat-message-bubble {\n        max-width: 75%;\n    }\n}\n",{"version":3,"sources":["chat.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAmWA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA","file":"chat.vue","sourceRoot":"src/components/page","sourcesContent":["<template>\n    <div>\n        <app-head></app-head>\n        <app-body>\n            <div class=\"chat-container\">\n                <!-- 会话列表 -->\n                <div class=\"chat-session-list\">\n                    <div class=\"session-list-header\">\n                        <span>消息</span>\n                    </div>\n                    <div v-if=\"sessionList.length === 0\" class=\"session-empty\">\n                        暂无会话，去商品页发起私聊吧～\n                    </div>\n                    <div v-else>\n                        <div\n                                v-for=\"(session,index) in sessionList\"\n                                :key=\"session.id\"\n                                :class=\"['session-item', currentSessionKey === getSessionKey(session) ? 'active' : '']\"\n                                @click=\"selectSession(session)\"\n                        >\n                            <el-image\n                                    class=\"session-avatar\"\n                                    :src=\"getDisplayUser(session).avatar\"\n                                    fit=\"cover\"\n                            ></el-image>\n                            <div class=\"session-info\">\n                                <div class=\"session-top\">\n                                    <span class=\"session-name\">{{ getDisplayUser(session).nickname }}</span>\n                                    <span class=\"session-time\">{{ formatTime(session.createTime) }}</span>\n                                </div>\n                                <div class=\"session-bottom\">\n                                    <span class=\"session-last\">{{ session.content }}</span>\n                                    <span v-if=\"session.idle\" class=\"session-goods-name\">\n                                        · {{ session.idle.idleName }}\n                                    </span>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- 聊天窗口 -->\n                <div class=\"chat-session-panel\">\n                    <div class=\"chat-header\" v-if=\"currentChatTarget\">\n                        <div class=\"chat-header-left\">\n                            <el-avatar :size=\"40\" :src=\"currentChatTarget.avatar\"></el-avatar>\n                            <div class=\"chat-header-text\">\n                                <div class=\"chat-header-name\">{{ currentChatTarget.nickname }}</div>\n                                <div class=\"chat-header-sub\" v-if=\"currentIdle\">\n                                    正在沟通：{{ currentIdle.idleName }}\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"chat-header\" v-else>\n                        <div class=\"chat-header-empty\">\n                            请选择左侧的会话或从商品详情页点击\"私聊\"发起会话\n                        </div>\n                    </div>\n\n                    <div class=\"chat-message-list\" ref=\"messageListRef\">\n                        <div v-if=\"messageList.length === 0\" class=\"chat-message-empty\">\n                            暂无聊天记录\n                        </div>\n                        <div\n                                v-else\n                                v-for=\"msg in messageList\"\n                                :key=\"msg.id\"\n                                :class=\"['chat-message-row', msg.fromUser == currentUserId ? 'self' : 'other']\"\n                        >\n                            <el-avatar\n                                    :size=\"32\"\n                                    :src=\"msg.fromU && msg.fromU.avatar\"\n                                    class=\"chat-message-avatar\"\n                            ></el-avatar>\n                            <div class=\"chat-message-bubble\">\n                                <template v-if=\"msg.imageUrl\">\n                                    <el-image\n                                            class=\"chat-image\"\n                                            :src=\"msg.imageUrl\"\n                                            :preview-src-list=\"[msg.imageUrl]\"\n                                            fit=\"cover\"\n                                    ></el-image>\n                                </template>\n                                <template v-else>\n                                    <div class=\"chat-message-content\" v-html=\"msg.content\"></div>\n                                </template>\n                                <div class=\"chat-message-time\">{{ formatTime(msg.createTime) }}</div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"chat-input-bar\">\n                        <el-input\n                                type=\"textarea\"\n                                :rows=\"3\"\n                                placeholder=\"请输入要发送的内容...\"\n                                v-model=\"inputContent\"\n                                maxlength=\"200\"\n                                show-word-limit\n                                @keyup.enter.native.exact.prevent=\"handleSend\"\n                        ></el-input>\n                        <div class=\"chat-input-actions\">\n                            <el-upload\n                                    class=\"image-uploader\"\n                                    :action=\"'/api/file'\"\n                                    :show-file-list=\"false\"\n                                    :on-success=\"handleUploadSuccess\"\n                                    :on-error=\"handleUploadError\"\n                                    :before-upload=\"beforeUpload\"\n                                    accept=\"image/*\">\n                                <el-button icon=\"el-icon-picture-outline\" title=\"发送图片\"></el-button>\n                            </el-upload>\n                            <el-button type=\"primary\" icon=\"el-icon-s-promotion\" @click=\"handleSend\" :disabled=\"!currentTargetUserId\">\n                                发送\n                            </el-button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            <app-foot></app-foot>\n        </app-body>\n    </div>\n</template>\n\n<script>\n    import AppHead from '../common/AppHeader.vue';\n    import AppBody from '../common/AppPageBody.vue';\n    import AppFoot from '../common/AppFoot.vue';\n\n    export default {\n        name: \"chat\",\n        components: {\n            AppHead,\n            AppBody,\n            AppFoot\n        },\n        data() {\n            return {\n                sessionList: [],\n                messageList: [],\n                inputContent: '',\n                currentUserId: null,\n                currentSessionKey: '',\n                currentTargetUserId: null,\n                currentIdleId: null,\n                currentChatTarget: null,\n                currentIdle: null\n            };\n        },\n        created() {\n            this.currentUserId = this.getCookie('shUserId');\n            const targetUserId = this.$route.query.targetUserId;\n            const idleId = this.$route.query.idleId;\n            this.loadSessionList().then(() => {\n                if (targetUserId) {\n                    this.openSessionByTarget(targetUserId, idleId);\n                }\n            });\n        },\n        methods: {\n            getCookie(cname) {\n                const name = cname + \"=\";\n                const ca = document.cookie.split(';');\n                for (let i = 0; i < ca.length; i++) {\n                    let c = ca[i].trim();\n                    if (c.indexOf(name) === 0) return c.substring(name.length, c.length);\n                }\n                return \"\";\n            },\n            formatTime(timeStr) {\n                if (!timeStr) return '';\n                return timeStr.toString().substring(0, 16);\n            },\n            getSessionKey(session) {\n                const from = session.fromUser;\n                const to = session.toUser;\n                const idleId = session.idleId || 0;\n                const small = from < to ? from : to;\n                const big = from < to ? to : from;\n                return `${small}_${big}_${idleId}`;\n            },\n            getDisplayUser(session) {\n                if (!session) return {};\n                if (!this.currentUserId) return session.toU || session.fromU || {};\n                if (session.fromUser == this.currentUserId) {\n                    return session.toU || {};\n                }\n                return session.fromU || {};\n            },\n            async loadSessionList() {\n                try {\n                    const res = await this.$api.getChatSessionList();\n                    if (res.status_code === 1 && res.data) {\n                        this.sessionList = res.data;\n                    }\n                } catch (e) {\n                }\n            },\n            async loadSessionDetail(targetUserId, idleId) {\n                try {\n                    const res = await this.$api.getChatSessionDetail({\n                        targetUserId: targetUserId,\n                        idleId: idleId\n                    });\n                    if (res.status_code === 1 && res.data) {\n                        this.messageList = res.data;\n                        this.$nextTick(() => {\n                            this.scrollToBottom();\n                        });\n                    }\n                } catch (e) {\n                }\n            },\n            selectSession(session) {\n                this.currentSessionKey = this.getSessionKey(session);\n                this.currentTargetUserId = (session.fromUser == this.currentUserId) ? session.toUser : session.fromUser;\n                this.currentIdleId = session.idleId || null;\n                this.currentChatTarget = this.getDisplayUser(session);\n                this.currentIdle = session.idle || null;\n                this.loadSessionDetail(this.currentTargetUserId, this.currentIdleId);\n            },\n            openSessionByTarget(targetUserId, idleId) {\n                // 尝试在现有会话中找到\n                let found = null;\n                for (let i = 0; i < this.sessionList.length; i++) {\n                    const s = this.sessionList[i];\n                    const otherId = (s.fromUser == this.currentUserId) ? s.toUser : s.fromUser;\n                    const idle = s.idleId || null;\n                    if (otherId == targetUserId && (idleId == null || idle == idleId)) {\n                        found = s;\n                        break;\n                    }\n                }\n                if (found) {\n                    this.selectSession(found);\n                } else {\n                    // 没有历史记录时，仅设置当前会话上下文，等待第一条消息发送\n                    this.currentTargetUserId = Number(targetUserId);\n                    this.currentIdleId = idleId ? Number(idleId) : null;\n                    this.currentChatTarget = null;\n                    this.currentIdle = null;\n                    this.messageList = [];\n                }\n            },\n            scrollToBottom() {\n                const box = this.$refs.messageListRef;\n                if (box) {\n                    box.scrollTop = box.scrollHeight;\n                }\n            },\n            async handleSend() {\n                const content = this.inputContent.trim();\n                if (!content) {\n                    this.$message.error(\"发送内容不能为空！\");\n                    return;\n                }\n                if (!this.currentTargetUserId) {\n                    this.$message.error(\"请选择会话或从商品详情页发起私聊！\");\n                    return;\n                }\n                try {\n                    const contentList = content.split(/\\r?\\n/);\n                    let html = contentList[0];\n                    for (let i = 1; i < contentList.length; i++) {\n                        html += '<br>' + contentList[i];\n                    }\n                    const res = await this.$api.sendChatMessage({\n                        toUser: this.currentTargetUserId,\n                        idleId: this.currentIdleId,\n                        content: html\n                    });\n                    if (res.status_code === 1) {\n                        this.inputContent = '';\n                        await this.loadSessionDetail(this.currentTargetUserId, this.currentIdleId);\n                        await this.loadSessionList();\n                    } else {\n                        this.$message.error(\"发送失败：\" + res.msg);\n                    }\n                } catch (e) {\n                    this.$message.error(\"发送失败！\");\n                }\n            },\n            beforeUpload(file) {\n                const isLt2M = file.size / 1024 / 1024 < 2;\n                if (!isLt2M) {\n                    this.$message.error('上传图片大小不能超过 2MB!');\n                }\n                return isLt2M;\n            },\n            handleUploadSuccess(res, file) {\n                console.log('Upload success response:', res);\n                console.log('Response type:', typeof res);\n                \n                let responseData = res;\n                // el-upload有时会返回字符串，需要手动解析\n                if (typeof res === 'string') {\n                    try {\n                        responseData = JSON.parse(res);\n                    } catch (e) {\n                        console.error('Failed to parse response as JSON:', e);\n                        this.$message.error('图片上传失败: 无法解析服务器响应');\n                        return;\n                    }\n                }\n\n                console.log('Parsed response data:', responseData);\n                \n                // 检查响应格式\n                if (responseData && responseData.status_code === 1) {\n                    const imageUrl = responseData.data;\n                    if (imageUrl) {\n                        console.log('Image URL extracted:', imageUrl);\n                        this.$message.success('图片上传成功!');\n                        this.sendImage(imageUrl);\n                    } else {\n                        console.error('No image URL in response data');\n                        this.$message.error('图片上传失败: 服务器返回数据中无URL');\n                    }\n                } else {\n                    console.error('Upload failed:', responseData);\n                    this.$message.error('图片上传失败: ' + (responseData && responseData.msg || '服务器返回格式错误'));\n                }\n            },\n            handleUploadError(err, file, fileList) {\n                console.error('Upload error:', err);\n                this.$message.error('图片上传失败，请检查网络或联系管理员。');\n            },\n            async sendImage(imageUrl) {\n                if (!this.currentTargetUserId) {\n                    this.$message.error('请选择会话！');\n                    return;\n                }\n                try {\n                    const res = await this.$api.sendChatImage({\n                        toUser: this.currentTargetUserId,\n                        idleId: this.currentIdleId,\n                        imageUrl: imageUrl,\n                        content: '' // 图片消息内容可为空\n                    });\n                    if (res.status_code === 1) {\n                        await this.loadSessionDetail(this.currentTargetUserId, this.currentIdleId);\n                        await this.loadSessionList();\n                    } else {\n                        this.$message.error(\"图片发送失败：\" + res.msg);\n                    }\n                } catch (e) {\n                    this.$message.error(\"图片发送失败！\");\n                }\n            }\n        }\n    }\n</script>\n\n<style scoped>\n    .chat-container {\n        height: 85vh;\n        display: flex;\n        border: 1px solid #ebeef5;\n        border-radius: 8px;\n        overflow: hidden;\n    }\n\n    .chat-session-list {\n        width: 320px;\n        overflow-y: auto;\n        border-right: 1px solid #ebeef5;\n        background-color: #f5f7fa;\n        display: flex;\n        flex-direction: column;\n    }\n\n    .session-list-header {\n        padding: 16px;\n        font-size: 16px;\n        font-weight: 600;\n        border-bottom: 1px solid #ebeef5;\n        background-color: #e6f7ff;\n        color: #1890ff;\n    }\n\n    .session-empty {\n        flex: 1;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        color: #909399;\n        font-size: 13px;\n        padding: 20px;\n        text-align: center;\n    }\n\n    .session-item {\n        display: flex;\n        padding: 12px 16px;\n        cursor: pointer;\n        transition: background-color 0.2s;\n        border-bottom: 1px solid #f0f0f0;\n    }\n\n    .session-item:hover {\n        background-color: #f0f8ff;\n    }\n\n    .session-item.active {\n        background-color: #1890ff;\n        color: white;\n    }\n\n    .session-item.active .session-name,\n    .session-item.active .session-time,\n    .session-item.active .session-last,\n    .session-item.active .session-goods-name {\n        color: white;\n    }\n\n    .session-avatar {\n        width: 46px;\n        height: 46px;\n        border-radius: 50%;\n        border: 2px solid #e6f7ff;\n    }\n\n    .session-item.active .session-avatar {\n        border-color: white;\n    }\n\n    .session-info {\n        flex: 1;\n        margin-left: 12px;\n        display: flex;\n        flex-direction: column;\n        justify-content: center;\n    }\n\n    .session-top {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        margin-bottom: 6px;\n    }\n\n    .session-name {\n        font-size: 14px;\n        font-weight: 600;\n        color: #303133;\n        max-width: 140px;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n    }\n\n    .session-time {\n        font-size: 12px;\n        color: #909399;\n    }\n\n    .session-bottom {\n        font-size: 13px;\n        color: #606266;\n        display: flex;\n        align-items: center;\n    }\n\n    .session-last {\n        max-width: 170px;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n    }\n\n    .session-goods-name {\n        margin-left: 4px;\n        color: #909399;\n        max-width: 110px;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n    }\n\n    .chat-session-panel {\n        flex: 1;\n        display: flex;\n        flex-direction: column;\n        background-color: #f8fafc;\n        overflow: hidden; /* 防止子元素溢出 */\n    }\n\n    .chat-header {\n        height: 68px;\n        border-bottom: 1px solid #e8e8e8;\n        display: flex;\n        align-items: center;\n        padding: 0 20px;\n        background-color: white;\n        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);\n    }\n\n    .chat-header-left {\n        display: flex;\n        align-items: center;\n    }\n\n    .chat-header-text {\n        margin-left: 12px;\n    }\n\n    .chat-header-name {\n        font-size: 16px;\n        font-weight: 600;\n        color: #303133;\n    }\n\n    .chat-header-sub {\n        margin-top: 4px;\n        font-size: 13px;\n        color: #666;\n    }\n\n    .chat-header-empty {\n        font-size: 14px;\n        color: #909399;\n        text-align: center;\n        width: 100%;\n    }\n\n    .chat-message-list {\n        flex: 1;\n        padding: 20px;\n        overflow-y: auto; /* 消息列表独立滚动 */\n        background-color: #f8fafc;\n        background-image:\n            radial-gradient(#e3e8f1 1px, transparent 1px),\n            radial-gradient(#e3e8f1 1px, transparent 1px);\n        background-size: 20px 20px;\n        background-position: 0 0, 10px 10px;\n    }\n\n    .chat-message-empty {\n        height: 100%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        color: #909399;\n        font-size: 14px;\n        background: rgba(255, 255, 255, 0.8);\n        border-radius: 8px;\n        padding: 30px;\n        backdrop-filter: blur(2px);\n    }\n\n    .chat-message-row {\n        display: flex;\n        margin-bottom: 16px;\n        animation: fadeIn 0.3s ease-out;\n    }\n\n    @keyframes fadeIn {\n        from {\n            opacity: 0;\n            transform: translateY(10px);\n        }\n        to {\n            opacity: 1;\n            transform: translateY(0);\n        }\n    }\n\n    .chat-message-row.self {\n        flex-direction: row-reverse;\n    }\n\n    .chat-message-avatar {\n        margin: 0 10px;\n        border: 2px solid white;\n        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n    }\n\n    .chat-message-bubble {\n        max-width: 65%;\n        padding: 12px 16px;\n        border-radius: 12px;\n        background-color: white;\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\n        position: relative;\n    }\n\n    .chat-message-row.other .chat-message-bubble {\n        background-color: #ffffff;\n        border: 1px solid #e8e8e8;\n    }\n\n    .chat-message-row.self .chat-message-bubble {\n        background: linear-gradient(135deg, #1890ff, #096dd9);\n        color: white;\n        box-shadow: 0 2px 8px rgba(24, 144, 255, 0.3);\n    }\n\n    /* 添加小箭头效果 */\n    .chat-message-row.other .chat-message-bubble::before {\n        content: '';\n        position: absolute;\n        left: -6px;\n        top: 12px;\n        width: 0;\n        height: 0;\n        border-top: 6px solid transparent;\n        border-bottom: 6px solid transparent;\n        border-right: 6px solid white;\n    }\n\n    .chat-message-row.self .chat-message-bubble::before {\n        content: '';\n        position: absolute;\n        right: -6px;\n        top: 12px;\n        width: 0;\n        height: 0;\n        border-top: 6px solid transparent;\n        border-bottom: 6px solid transparent;\n        border-left: 6px solid #1890ff;\n    }\n\n    .chat-message-content {\n        font-size: 14px;\n        line-height: 1.5;\n        word-break: break-word;\n    }\n\n    .chat-message-row.self .chat-message-content {\n        color: white;\n    }\n\n    .chat-message-time {\n        margin-top: 6px;\n        font-size: 11px;\n        color: #999;\n        text-align: right;\n        opacity: 0.8;\n    }\n\n    .chat-message-row.self .chat-message-time {\n        color: rgba(255, 255, 255, 0.85);\n    }\n\n    .chat-image {\n        max-width: 200px;\n        max-height: 200px;\n        border-radius: 8px;\n        cursor: pointer;\n    }\n\n    .chat-input-bar {\n        border-top: 1px solid #e8e8e8;\n        padding: 16px 20px;\n        background-color: white;\n        box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.05);\n    }\n\n    /* 优化文本输入框 */\n    .el-textarea {\n        border-radius: 8px;\n        overflow: hidden;\n    }\n\n    .el-textarea >>> .el-textarea__inner {\n        border: 1px solid #d9d9d9;\n        border-radius: 8px;\n        padding: 12px;\n        font-size: 14px;\n        transition: all 0.3s;\n        background-color: #fafafa;\n    }\n\n    .el-textarea >>> .el-textarea__inner:focus {\n        border-color: #1890ff;\n        box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);\n        background-color: white;\n    }\n\n    .el-textarea >>> .el-input__count {\n        background: transparent;\n        color: #999;\n    }\n\n    .chat-input-actions {\n        display: flex;\n        justify-content: flex-end;\n        margin-top: 12px;\n    }\n\n    /* 优化发送按钮 */\n    .el-button--primary {\n        background: linear-gradient(135deg, #1890ff, #096dd9);\n        border: none;\n        border-radius: 6px;\n        padding: 10px 24px;\n        font-weight: 500;\n        transition: all 0.3s;\n    }\n\n    .el-button--primary:hover {\n        background: linear-gradient(135deg, #40a9ff, #1890ff);\n        box-shadow: 0 4px 12px rgba(24, 144, 255, 0.3);\n        transform: translateY(-1px);\n    }\n\n    .el-button--primary:active {\n        transform: translateY(0);\n    }\n\n    .el-button--primary.is-disabled {\n        background: #f5f5f5;\n        color: #bfbfbf;\n        cursor: not-allowed;\n        transform: none;\n        box-shadow: none;\n    }\n\n    /* 滚动条优化 */\n    .chat-session-list,\n    .chat-message-list {\n        scrollbar-width: thin;\n        scrollbar-color: #c1c1c1 #f5f5f5;\n    }\n\n    .chat-session-list::-webkit-scrollbar,\n    .chat-message-list::-webkit-scrollbar {\n        width: 6px;\n    }\n\n    .chat-session-list::-webkit-scrollbar-track,\n    .chat-message-list::-webkit-scrollbar-track {\n        background: #f5f5f5;\n    }\n\n    .chat-session-list::-webkit-scrollbar-thumb,\n    .chat-message-list::-webkit-scrollbar-thumb {\n        background-color: #c1c1c1;\n        border-radius: 3px;\n    }\n\n    .chat-session-list::-webkit-scrollbar-thumb:hover,\n    .chat-message-list::-webkit-scrollbar-thumb:hover {\n        background-color: #a8a8a8;\n    }\n\n    @media (max-width: 900px) {\n        .chat-container {\n            flex-direction: column;\n        }\n\n        .chat-session-list {\n            width: 100%;\n            border-right: none;\n            border-bottom: 1px solid #ebeef5;\n            max-height: 300px;\n            overflow-y: auto;\n        }\n\n        .chat-message-bubble {\n            max-width: 75%;\n        }\n    }\n</style>\n\n"]}]}