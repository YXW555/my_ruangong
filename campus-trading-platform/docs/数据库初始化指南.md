# 数据库初始化指南

## 问题现象

后端日志显示：
```
Table 'second_hand_trading.sh_idle_item' doesn't exist
```

说明数据库存在，但表没有创建。

## 原因

MySQL 容器的 `/docker-entrypoint-initdb.d/` 目录中的 SQL 脚本只在**容器首次启动时**执行。如果容器已经启动过，即使后来添加了 SQL 文件，也不会自动执行。

## 解决方案

### 方案 1：手动导入 SQL 文件（推荐）

在服务器上执行：

```bash
cd /opt/campus-trading-platform

# 1. 检查 SQL 文件是否存在
ls -la *.sql

# 2. 如果不存在，需要从项目上传 SQL 文件
# 在本地执行：
# scp campus-trading-platform/backend/second_hand_trading.sql root@你的服务器IP:/opt/campus-trading-platform/init.sql

# 3. 导入 SQL 文件到数据库
sudo docker compose exec -i mysql mysql -u root -proot123456 second_hand_trading < init.sql

# 或者如果文件在容器内
sudo docker compose exec mysql mysql -u root -proot123456 second_hand_trading < /docker-entrypoint-initdb.d/init.sql
```

### 方案 2：重新创建 MySQL 容器（会丢失数据）

如果数据库是空的，可以重新创建：

```bash
cd /opt/campus-trading-platform

# 1. 停止 MySQL 容器
sudo docker compose stop mysql

# 2. 删除 MySQL 容器和数据卷（⚠️ 会丢失数据）
sudo docker compose rm -f mysql
sudo docker volume rm campus-trading-platform_mysql_data

# 3. 确保 init.sql 文件存在
ls -la init.sql

# 4. 重新启动 MySQL（会自动执行 init.sql）
sudo docker compose up -d mysql

# 5. 等待几秒让数据库初始化
sleep 10

# 6. 验证表是否创建
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "USE second_hand_trading; SHOW TABLES;"
```

### 方案 3：使用 SCP 上传 SQL 文件并导入

```bash
# 在本地项目目录执行
scp campus-trading-platform/backend/second_hand_trading.sql root@你的服务器IP:/opt/campus-trading-platform/init.sql

# 然后在服务器上导入
ssh root@你的服务器IP
cd /opt/campus-trading-platform
sudo docker compose exec -i mysql mysql -u root -proot123456 second_hand_trading < init.sql
```

## 验证数据库初始化

```bash
# 检查表是否存在
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "USE second_hand_trading; SHOW TABLES;"

# 应该看到很多表，包括：
# - sh_idle_item
# - sh_user
# - sh_order
# 等等
```

## 完整操作流程（推荐）

```bash
# 在服务器上执行

cd /opt/campus-trading-platform

# 1. 检查 SQL 文件
ls -la *.sql

# 2. 如果不存在，需要上传（在本地执行）
# scp campus-trading-platform/backend/second_hand_trading.sql root@你的服务器IP:/opt/campus-trading-platform/init.sql

# 3. 导入数据库
sudo docker compose exec -i mysql mysql -u root -proot123456 second_hand_trading < init.sql

# 4. 验证
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "USE second_hand_trading; SHOW TABLES;" | head -20

# 5. 重启后端（让后端重新连接数据库）
sudo docker compose restart backend

# 6. 查看后端日志
sudo docker compose logs -f backend
```

## 如果 SQL 文件路径不对

检查项目中的 SQL 文件位置：

```bash
# 在本地项目目录
find . -name "*.sql" -type f
```

通常 SQL 文件在：
- `backend/second_hand_trading.sql`
- 或者 `backend/fix_membership_type.sql`

## 注意事项

⚠️ **重要**：如果数据库中已有数据，导入 SQL 可能会：
- 删除现有数据
- 或者因为表已存在而失败

如果表已存在但数据不对，可以：
1. 先删除表：`DROP TABLE IF EXISTS sh_idle_item;`
2. 然后重新导入

