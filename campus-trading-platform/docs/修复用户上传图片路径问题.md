# 修复用户上传图片路径问题

## 问题

用户上传图片后，后端返回的路径是：
```
http://localhost:8080/image?imageName=file17669247184001003bottle.tif
```

前端无法访问，显示"加载失败"。

## 原因

1. 后端 `FileController` 使用 `baseUrl` 配置返回完整 URL
2. `baseUrl` 配置为 `http://localhost:8080`
3. 前端运行在服务器上，无法访问 `localhost:8080`
4. 应该使用相对路径 `/api/image?imageName=xxx` 通过 Nginx 代理

## 已修复

### 1. 修改后端代码

修改了 `FileController.java`，直接返回相对路径：

```java
// 修改前
return ResultVo.success(baseUrl+"/image?imageName="+fileName);

// 修改后
return ResultVo.success("/api/image?imageName="+fileName);
```

### 2. 添加环境变量支持

在 `docker-compose.prod.yml` 中添加：
```yaml
environment:
  - BASE_URL=/api
```

在 `application.properties` 中：
```properties
baseUrl=${BASE_URL:http://localhost:8080}
```

这样：
- 生产环境：使用 `/api`（通过环境变量）
- 开发环境：使用 `http://localhost:8080`（默认值）

## 需要重新部署

修复后需要：

1. **提交代码**：
   ```bash
   git add .
   git commit -m "修复图片上传路径：返回相对路径 /api"
   git push origin main
   ```

2. **等待 GitHub Actions 完成**（自动构建和部署）

3. **更新已上传的图片路径**（在服务器上执行）：
   ```bash
   cd /opt/campus-trading-platform
   
   # 更新数据库中的图片路径
   sudo docker compose exec mysql mysql -u root -proot123456 second_hand_trading << 'EOF'
   UPDATE sh_idle_item 
   SET picture_list = REPLACE(picture_list, 'http://localhost:8080', '/api')
   WHERE picture_list LIKE '%localhost%';
   
   UPDATE sh_idle_item 
   SET picture_list = REPLACE(picture_list, 'http://Localhost:8080', '/api')
   WHERE picture_list LIKE '%Localhost%';
   EOF
   ```

## 验证

部署完成后：

1. 刷新前端页面
2. 之前上传的图片应该能正常显示
3. 新上传的图片路径应该是 `/api/image?imageName=xxx`

## 临时修复（立即生效）

如果不想等重新部署，可以先更新数据库中的路径：

```bash
cd /opt/campus-trading-platform

sudo docker compose exec mysql mysql -u root -proot123456 second_hand_trading << 'EOF'
UPDATE sh_idle_item 
SET picture_list = REPLACE(picture_list, 'http://localhost:8080', '/api')
WHERE picture_list LIKE '%localhost%';

UPDATE sh_idle_item 
SET picture_list = REPLACE(picture_list, 'http://Localhost:8080', '/api')
WHERE picture_list LIKE '%Localhost%';
EOF
```

然后刷新页面，图片应该就能显示了。

