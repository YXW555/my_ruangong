{"remainingRequest":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\babel-loader\\lib\\index.js!D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\cache-loader\\dist\\cjs.js??ref--0-0!D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\src\\components\\page\\message.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\src\\components\\page\\message.vue","mtime":1767327112308},{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1678197338000},{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\babel-loader\\lib\\index.js","mtime":1678197338000},{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1678197338000},{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\vue-loader\\lib\\index.js","mtime":1678197338000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.regexp.replace\";\nimport \"regenerator-runtime/runtime\";\nimport _asyncToGenerator from \"D:/Git/my_ruangong/campus-trading-platform/frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport \"core-js/modules/es6.regexp.to-string\";\nimport \"core-js/modules/es6.regexp.split\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport AppHead from \"../common/AppHeader.vue\";\nimport AppBody from \"../common/AppPageBody.vue\";\nimport AppFoot from \"../common/AppFoot.vue\";\nexport default {\n  name: \"message\",\n  components: {\n    AppHead: AppHead,\n    AppBody: AppBody,\n    AppFoot: AppFoot\n  },\n  data: function data() {\n    return {\n      commentList: [],\n      // 商品留言列表\n      chatList: [],\n      // 私聊会话列表\n      activeTab: 'all',\n      // 当前选中的标签页\n      currentUserId: null\n    };\n  },\n  created: function created() {\n    this.currentUserId = this.getCookie('shUserId');\n    this.loadAllMessages();\n  },\n  methods: {\n    getCookie: function getCookie(cname) {\n      var name = cname + \"=\";\n      var ca = document.cookie.split(';');\n\n      for (var i = 0; i < ca.length; i++) {\n        var c = ca[i].trim();\n        if (c.indexOf(name) === 0) return c.substring(name.length, c.length);\n      }\n\n      return \"\";\n    },\n    formatTime: function formatTime(timeStr) {\n      if (!timeStr) return '';\n      var time = new Date(timeStr);\n      var now = new Date();\n      var diff = now - time;\n      var minutes = Math.floor(diff / 60000);\n      var hours = Math.floor(diff / 3600000);\n      var days = Math.floor(diff / 86400000);\n      if (minutes < 1) return '刚刚';\n      if (minutes < 60) return \"\".concat(minutes, \"\\u5206\\u949F\\u524D\");\n      if (hours < 24) return \"\".concat(hours, \"\\u5C0F\\u65F6\\u524D\");\n      if (days < 7) return \"\".concat(days, \"\\u5929\\u524D\");\n      return timeStr.toString().substring(0, 16);\n    },\n    loadAllMessages: function () {\n      var _loadAllMessages = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {\n        var _this = this;\n\n        var commentRes, chatRes;\n        return regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.prev = 0;\n                _context.next = 3;\n                return this.$api.getAllMyMessage();\n\n              case 3:\n                commentRes = _context.sent;\n\n                if (commentRes.status_code === 1 && commentRes.data) {\n                  this.commentList = commentRes.data.map(function (item) {\n                    // 处理图片\n                    var imgUrl = '';\n\n                    try {\n                      var imgList = JSON.parse(item.idle.pictureList);\n                      imgUrl = imgList && imgList.length > 0 ? imgList[0] : '';\n                    } catch (e) {\n                      imgUrl = '';\n                    }\n\n                    item.idle.imgUrl = imgUrl; // 处理内容（移除HTML标签，只保留文本）\n\n                    var content = item.content;\n\n                    try {\n                      var contentList = content.split('<br>');\n                      content = contentList[0];\n\n                      for (var i = 1; i < contentList.length; i++) {\n                        content += ' ' + contentList[i];\n                      } // 移除HTML标签\n\n\n                      content = content.replace(/<[^>]+>/g, '');\n                    } catch (e) {// 如果处理失败，保持原样\n                    }\n\n                    item.content = content;\n                    return item;\n                  });\n                }\n\n                _context.next = 10;\n                break;\n\n              case 7:\n                _context.prev = 7;\n                _context.t0 = _context[\"catch\"](0);\n                console.error('加载商品留言失败:', _context.t0);\n\n              case 10:\n                _context.prev = 10;\n                _context.next = 13;\n                return this.$api.getChatSessionList();\n\n              case 13:\n                chatRes = _context.sent;\n\n                if (chatRes.status_code === 1 && chatRes.data) {\n                  this.chatList = chatRes.data.map(function (session) {\n                    // 处理商品图片\n                    if (session.idle && session.idle.pictureList) {\n                      try {\n                        var imgList = JSON.parse(session.idle.pictureList);\n                        session.idle.imgUrl = imgList && imgList.length > 0 ? imgList[0] : '';\n                      } catch (e) {\n                        session.idle.imgUrl = '';\n                      }\n                    } // 计算该会话的未读消息数量（如果当前用户是接收方且消息未读）\n\n\n                    if (_this.currentUserId) {\n                      var currentUserIdNum = parseInt(_this.currentUserId); // 如果消息是发送给当前用户的，且未读，则计数\n\n                      if (session.toUser == currentUserIdNum && session.isRead === 0) {\n                        session.unreadCount = 1; // 会话列表只显示最新一条，所以最多是1\n                      } else {\n                        session.unreadCount = 0;\n                      }\n                    } else {\n                      session.unreadCount = 0;\n                    }\n\n                    return session;\n                  });\n                }\n\n                _context.next = 20;\n                break;\n\n              case 17:\n                _context.prev = 17;\n                _context.t1 = _context[\"catch\"](10);\n                console.error('加载私聊会话失败:', _context.t1);\n\n              case 20:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this, [[0, 7], [10, 17]]);\n      }));\n\n      function loadAllMessages() {\n        return _loadAllMessages.apply(this, arguments);\n      }\n\n      return loadAllMessages;\n    }(),\n    getUnreadCountForSession: function getUnreadCountForSession(session) {\n      return session.unreadCount || 0;\n    },\n    getDisplayUser: function getDisplayUser(session) {\n      if (!session) return {};\n      if (!this.currentUserId) return session.toU || session.fromU || {};\n\n      if (session.fromUser == this.currentUserId) {\n        return session.toU || {};\n      }\n\n      return session.fromU || {};\n    },\n    getGoodsImage: function getGoodsImage(idle) {\n      if (!idle) return '';\n      if (idle.imgUrl) return idle.imgUrl;\n\n      if (idle.pictureList) {\n        try {\n          var imgList = JSON.parse(idle.pictureList);\n          return imgList && imgList.length > 0 ? imgList[0] : '';\n        } catch (e) {\n          return '';\n        }\n      }\n\n      return '';\n    },\n    handleTabClick: function handleTabClick(tab) {// 标签切换时不需要额外操作，数据已经加载好了\n    },\n    toDetails: function toDetails(id) {\n      this.$router.push({\n        path: '/details',\n        query: {\n          id: id\n        }\n      });\n    },\n    toChat: function toChat(session) {\n      var targetUserId = session.fromUser == this.currentUserId ? session.toUser : session.fromUser;\n      var idleId = session.idleId || null;\n      this.$router.push({\n        path: '/chat',\n        query: {\n          targetUserId: targetUserId,\n          idleId: idleId\n        }\n      });\n    },\n    goToIndex: function goToIndex() {\n      this.$router.push({\n        path: '/index'\n      });\n    },\n    goToChat: function goToChat() {\n      this.$router.push({\n        path: '/chat'\n      });\n    }\n  }\n};",{"version":3,"sources":["message.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAkJA,OAAA,OAAA;AACA,OAAA,OAAA;AACA,OAAA,OAAA;AAEA,eAAA;AACA,EAAA,IAAA,EAAA,SADA;AAEA,EAAA,UAAA,EAAA;AACA,IAAA,OAAA,EAAA,OADA;AAEA,IAAA,OAAA,EAAA,OAFA;AAGA,IAAA,OAAA,EAAA;AAHA,GAFA;AAOA,EAAA,IAPA,kBAOA;AACA,WAAA;AACA,MAAA,WAAA,EAAA,EADA;AACA;AACA,MAAA,QAAA,EAAA,EAFA;AAEA;AACA,MAAA,SAAA,EAAA,KAHA;AAGA;AACA,MAAA,aAAA,EAAA;AAJA,KAAA;AAMA,GAdA;AAeA,EAAA,OAfA,qBAeA;AACA,SAAA,aAAA,GAAA,KAAA,SAAA,CAAA,UAAA,CAAA;AACA,SAAA,eAAA;AACA,GAlBA;AAmBA,EAAA,OAAA,EAAA;AACA,IAAA,SADA,qBACA,KADA,EACA;AACA,UAAA,IAAA,GAAA,KAAA,GAAA,GAAA;AACA,UAAA,EAAA,GAAA,QAAA,CAAA,MAAA,CAAA,KAAA,CAAA,GAAA,CAAA;;AACA,WAAA,IAAA,CAAA,GAAA,CAAA,EAAA,CAAA,GAAA,EAAA,CAAA,MAAA,EAAA,CAAA,EAAA,EAAA;AACA,YAAA,CAAA,GAAA,EAAA,CAAA,CAAA,CAAA,CAAA,IAAA,EAAA;AACA,YAAA,CAAA,CAAA,OAAA,CAAA,IAAA,MAAA,CAAA,EAAA,OAAA,CAAA,CAAA,SAAA,CAAA,IAAA,CAAA,MAAA,EAAA,CAAA,CAAA,MAAA,CAAA;AACA;;AACA,aAAA,EAAA;AACA,KATA;AAUA,IAAA,UAVA,sBAUA,OAVA,EAUA;AACA,UAAA,CAAA,OAAA,EAAA,OAAA,EAAA;AACA,UAAA,IAAA,GAAA,IAAA,IAAA,CAAA,OAAA,CAAA;AACA,UAAA,GAAA,GAAA,IAAA,IAAA,EAAA;AACA,UAAA,IAAA,GAAA,GAAA,GAAA,IAAA;AACA,UAAA,OAAA,GAAA,IAAA,CAAA,KAAA,CAAA,IAAA,GAAA,KAAA,CAAA;AACA,UAAA,KAAA,GAAA,IAAA,CAAA,KAAA,CAAA,IAAA,GAAA,OAAA,CAAA;AACA,UAAA,IAAA,GAAA,IAAA,CAAA,KAAA,CAAA,IAAA,GAAA,QAAA,CAAA;AAEA,UAAA,OAAA,GAAA,CAAA,EAAA,OAAA,IAAA;AACA,UAAA,OAAA,GAAA,EAAA,EAAA,iBAAA,OAAA;AACA,UAAA,KAAA,GAAA,EAAA,EAAA,iBAAA,KAAA;AACA,UAAA,IAAA,GAAA,CAAA,EAAA,iBAAA,IAAA;AACA,aAAA,OAAA,CAAA,QAAA,GAAA,SAAA,CAAA,CAAA,EAAA,EAAA,CAAA;AACA,KAxBA;AAyBA,IAAA,eAzBA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBA4BA,KAAA,IAAA,CAAA,eAAA,EA5BA;;AAAA;AA4BA,gBAAA,UA5BA;;AA6BA,oBAAA,UAAA,CAAA,WAAA,KAAA,CAAA,IAAA,UAAA,CAAA,IAAA,EAAA;AACA,uBAAA,WAAA,GAAA,UAAA,CAAA,IAAA,CAAA,GAAA,CAAA,UAAA,IAAA,EAAA;AACA;AACA,wBAAA,MAAA,GAAA,EAAA;;AACA,wBAAA;AACA,0BAAA,OAAA,GAAA,IAAA,CAAA,KAAA,CAAA,IAAA,CAAA,IAAA,CAAA,WAAA,CAAA;AACA,sBAAA,MAAA,GAAA,OAAA,IAAA,OAAA,CAAA,MAAA,GAAA,CAAA,GAAA,OAAA,CAAA,CAAA,CAAA,GAAA,EAAA;AACA,qBAHA,CAGA,OAAA,CAAA,EAAA;AACA,sBAAA,MAAA,GAAA,EAAA;AACA;;AACA,oBAAA,IAAA,CAAA,IAAA,CAAA,MAAA,GAAA,MAAA,CATA,CAWA;;AACA,wBAAA,OAAA,GAAA,IAAA,CAAA,OAAA;;AACA,wBAAA;AACA,0BAAA,WAAA,GAAA,OAAA,CAAA,KAAA,CAAA,MAAA,CAAA;AACA,sBAAA,OAAA,GAAA,WAAA,CAAA,CAAA,CAAA;;AACA,2BAAA,IAAA,CAAA,GAAA,CAAA,EAAA,CAAA,GAAA,WAAA,CAAA,MAAA,EAAA,CAAA,EAAA,EAAA;AACA,wBAAA,OAAA,IAAA,MAAA,WAAA,CAAA,CAAA,CAAA;AACA,uBALA,CAMA;;;AACA,sBAAA,OAAA,GAAA,OAAA,CAAA,OAAA,CAAA,UAAA,EAAA,EAAA,CAAA;AACA,qBARA,CAQA,OAAA,CAAA,EAAA,CACA;AACA;;AACA,oBAAA,IAAA,CAAA,OAAA,GAAA,OAAA;AAEA,2BAAA,IAAA;AACA,mBA3BA,CAAA;AA4BA;;AA1DA;AAAA;;AAAA;AAAA;AAAA;AA4DA,gBAAA,OAAA,CAAA,KAAA,CAAA,WAAA;;AA5DA;AAAA;AAAA;AAAA,uBAiEA,KAAA,IAAA,CAAA,kBAAA,EAjEA;;AAAA;AAiEA,gBAAA,OAjEA;;AAkEA,oBAAA,OAAA,CAAA,WAAA,KAAA,CAAA,IAAA,OAAA,CAAA,IAAA,EAAA;AACA,uBAAA,QAAA,GAAA,OAAA,CAAA,IAAA,CAAA,GAAA,CAAA,UAAA,OAAA,EAAA;AACA;AACA,wBAAA,OAAA,CAAA,IAAA,IAAA,OAAA,CAAA,IAAA,CAAA,WAAA,EAAA;AACA,0BAAA;AACA,4BAAA,OAAA,GAAA,IAAA,CAAA,KAAA,CAAA,OAAA,CAAA,IAAA,CAAA,WAAA,CAAA;AACA,wBAAA,OAAA,CAAA,IAAA,CAAA,MAAA,GAAA,OAAA,IAAA,OAAA,CAAA,MAAA,GAAA,CAAA,GAAA,OAAA,CAAA,CAAA,CAAA,GAAA,EAAA;AACA,uBAHA,CAGA,OAAA,CAAA,EAAA;AACA,wBAAA,OAAA,CAAA,IAAA,CAAA,MAAA,GAAA,EAAA;AACA;AACA,qBATA,CAUA;;;AACA,wBAAA,KAAA,CAAA,aAAA,EAAA;AACA,0BAAA,gBAAA,GAAA,QAAA,CAAA,KAAA,CAAA,aAAA,CAAA,CADA,CAEA;;AACA,0BAAA,OAAA,CAAA,MAAA,IAAA,gBAAA,IAAA,OAAA,CAAA,MAAA,KAAA,CAAA,EAAA;AACA,wBAAA,OAAA,CAAA,WAAA,GAAA,CAAA,CADA,CACA;AACA,uBAFA,MAEA;AACA,wBAAA,OAAA,CAAA,WAAA,GAAA,CAAA;AACA;AACA,qBARA,MAQA;AACA,sBAAA,OAAA,CAAA,WAAA,GAAA,CAAA;AACA;;AACA,2BAAA,OAAA;AACA,mBAvBA,CAAA;AAwBA;;AA3FA;AAAA;;AAAA;AAAA;AAAA;AA6FA,gBAAA,OAAA,CAAA,KAAA,CAAA,WAAA;;AA7FA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAgGA,IAAA,wBAhGA,oCAgGA,OAhGA,EAgGA;AACA,aAAA,OAAA,CAAA,WAAA,IAAA,CAAA;AACA,KAlGA;AAmGA,IAAA,cAnGA,0BAmGA,OAnGA,EAmGA;AACA,UAAA,CAAA,OAAA,EAAA,OAAA,EAAA;AACA,UAAA,CAAA,KAAA,aAAA,EAAA,OAAA,OAAA,CAAA,GAAA,IAAA,OAAA,CAAA,KAAA,IAAA,EAAA;;AACA,UAAA,OAAA,CAAA,QAAA,IAAA,KAAA,aAAA,EAAA;AACA,eAAA,OAAA,CAAA,GAAA,IAAA,EAAA;AACA;;AACA,aAAA,OAAA,CAAA,KAAA,IAAA,EAAA;AACA,KA1GA;AA2GA,IAAA,aA3GA,yBA2GA,IA3GA,EA2GA;AACA,UAAA,CAAA,IAAA,EAAA,OAAA,EAAA;AACA,UAAA,IAAA,CAAA,MAAA,EAAA,OAAA,IAAA,CAAA,MAAA;;AACA,UAAA,IAAA,CAAA,WAAA,EAAA;AACA,YAAA;AACA,cAAA,OAAA,GAAA,IAAA,CAAA,KAAA,CAAA,IAAA,CAAA,WAAA,CAAA;AACA,iBAAA,OAAA,IAAA,OAAA,CAAA,MAAA,GAAA,CAAA,GAAA,OAAA,CAAA,CAAA,CAAA,GAAA,EAAA;AACA,SAHA,CAGA,OAAA,CAAA,EAAA;AACA,iBAAA,EAAA;AACA;AACA;;AACA,aAAA,EAAA;AACA,KAvHA;AAwHA,IAAA,cAxHA,0BAwHA,GAxHA,EAwHA,CACA;AACA,KA1HA;AA2HA,IAAA,SA3HA,qBA2HA,EA3HA,EA2HA;AACA,WAAA,OAAA,CAAA,IAAA,CAAA;AAAA,QAAA,IAAA,EAAA,UAAA;AAAA,QAAA,KAAA,EAAA;AAAA,UAAA,EAAA,EAAA;AAAA;AAAA,OAAA;AACA,KA7HA;AA8HA,IAAA,MA9HA,kBA8HA,OA9HA,EA8HA;AACA,UAAA,YAAA,GAAA,OAAA,CAAA,QAAA,IAAA,KAAA,aAAA,GAAA,OAAA,CAAA,MAAA,GAAA,OAAA,CAAA,QAAA;AACA,UAAA,MAAA,GAAA,OAAA,CAAA,MAAA,IAAA,IAAA;AACA,WAAA,OAAA,CAAA,IAAA,CAAA;AACA,QAAA,IAAA,EAAA,OADA;AAEA,QAAA,KAAA,EAAA;AACA,UAAA,YAAA,EAAA,YADA;AAEA,UAAA,MAAA,EAAA;AAFA;AAFA,OAAA;AAOA,KAxIA;AAyIA,IAAA,SAzIA,uBAyIA;AACA,WAAA,OAAA,CAAA,IAAA,CAAA;AAAA,QAAA,IAAA,EAAA;AAAA,OAAA;AACA,KA3IA;AA4IA,IAAA,QA5IA,sBA4IA;AACA,WAAA,OAAA,CAAA,IAAA,CAAA;AAAA,QAAA,IAAA,EAAA;AAAA,OAAA;AACA;AA9IA;AAnBA,CAAA","sourcesContent":["<template>\n    <div>\n        <app-head></app-head>\n        <app-body>\n            <div class=\"message-container\">\n                <div class=\"message-header\">\n                    <h2 class=\"message-title\">我的消息</h2>\n                    <el-tabs v-model=\"activeTab\" @tab-click=\"handleTabClick\" class=\"message-tabs\">\n                        <el-tab-pane label=\"全部\" name=\"all\">\n                            <span slot=\"label\">\n                                <i class=\"el-icon-message\"></i> 全部\n                            </span>\n                        </el-tab-pane>\n                        <el-tab-pane label=\"商品留言\" name=\"comment\">\n                            <span slot=\"label\">\n                                <i class=\"el-icon-chat-line-round\"></i> 商品留言\n                            </span>\n                        </el-tab-pane>\n                        <el-tab-pane label=\"私聊消息\" name=\"chat\">\n                            <span slot=\"label\">\n                                <i class=\"el-icon-chat-dot-round\"></i> 私聊消息\n                            </span>\n                        </el-tab-pane>\n                    </el-tabs>\n                </div>\n\n                <!-- 商品留言列表 -->\n                <div v-if=\"activeTab === 'all' || activeTab === 'comment'\">\n                    <div v-if=\"commentList.length === 0 && activeTab === 'comment'\" class=\"empty-state\">\n                        <i class=\"el-icon-chat-line-round empty-icon\"></i>\n                        <p class=\"empty-text\">暂无商品留言</p>\n                        <p class=\"empty-hint\">当有人在你发布的商品下留言时，会显示在这里</p>\n                        <el-button type=\"primary\" @click=\"goToIndex\">去逛逛商品</el-button>\n                    </div>\n                    <div v-else>\n                        <div v-for=\"(mes,index) in commentList\" :key=\"'comment-' + index\" \n                             class=\"message-item comment-item\" \n                             @click=\"toDetails(mes.idle.id)\">\n                            <div class=\"message-item-left\">\n                        <el-image\n                                    class=\"message-avatar\"\n                                :src=\"mes.fromU.avatar\"\n                                    fit=\"cover\">\n                                    <div slot=\"error\" class=\"avatar-error\">\n                                        <i class=\"el-icon-user\"></i>\n                                    </div>\n                                </el-image>\n                                <div class=\"message-content-wrapper\">\n                                    <div class=\"message-header-info\">\n                                        <span class=\"message-nickname\">{{mes.fromU.nickname}}</span>\n                                        <span class=\"message-type-tag comment-tag\">\n                                            <i class=\"el-icon-chat-line-round\"></i> 商品留言\n                                        </span>\n                                    </div>\n                            <div class=\"message-content\">{{mes.content}}</div>\n                                    <div class=\"message-footer\">\n                                        <span class=\"message-time\">{{formatTime(mes.createTime)}}</span>\n                                        <span class=\"message-goods\">商品：{{mes.idle.idleName}}</span>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"message-item-right\">\n                                <el-image\n                                    class=\"message-goods-image\"\n                                    :src=\"mes.idle.imgUrl\"\n                                    fit=\"cover\">\n                                    <div slot=\"error\" class=\"image-error\">\n                                        <i class=\"el-icon-picture-outline\"></i>\n                                    </div>\n                                </el-image>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- 私聊会话列表 -->\n                <div v-if=\"activeTab === 'all' || activeTab === 'chat'\">\n                    <div v-if=\"chatList.length === 0 && activeTab === 'chat'\" class=\"empty-state\">\n                        <i class=\"el-icon-chat-dot-round empty-icon\"></i>\n                        <p class=\"empty-text\">暂无私聊消息</p>\n                        <p class=\"empty-hint\">当有人给你发送私聊消息时，会显示在这里</p>\n                        <el-button type=\"primary\" @click=\"goToChat\">去私聊页面</el-button>\n                    </div>\n                    <div v-else>\n                        <div v-for=\"(session,index) in chatList\" :key=\"'chat-' + index\" \n                             class=\"message-item chat-item\" \n                             @click=\"toChat(session)\">\n                            <div class=\"message-item-left\">\n                                <el-image\n                                    class=\"message-avatar\"\n                                    :src=\"getDisplayUser(session).avatar\"\n                                    fit=\"cover\">\n                                    <div slot=\"error\" class=\"avatar-error\">\n                                        <i class=\"el-icon-user\"></i>\n                                    </div>\n                                </el-image>\n                                <div class=\"message-content-wrapper\">\n                                    <div class=\"message-header-info\">\n                                        <span class=\"message-nickname\">{{getDisplayUser(session).nickname}}</span>\n                                        <span class=\"message-type-tag chat-tag\">\n                                            <i class=\"el-icon-chat-dot-round\"></i> 私聊\n                                        </span>\n                                        <el-badge \n                                            v-if=\"getUnreadCountForSession(session) > 0\"\n                                            :value=\"getUnreadCountForSession(session)\" \n                                            class=\"unread-badge\">\n                                        </el-badge>\n                                    </div>\n                                    <div class=\"message-content\" :class=\"{'unread-message': getUnreadCountForSession(session) > 0}\">{{session.content}}</div>\n                                    <div class=\"message-footer\">\n                                        <span class=\"message-time\">{{formatTime(session.createTime)}}</span>\n                                        <span v-if=\"session.idle\" class=\"message-goods\">商品：{{session.idle.idleName}}</span>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"message-item-right\" v-if=\"session.idle\">\n                        <el-image\n                                    class=\"message-goods-image\"\n                                    :src=\"getGoodsImage(session.idle)\"\n                                    fit=\"cover\">\n                                    <div slot=\"error\" class=\"image-error\">\n                                        <i class=\"el-icon-picture-outline\"></i>\n                                    </div>\n                                </el-image>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- 全部为空的状态 -->\n                <div v-if=\"activeTab === 'all' && commentList.length === 0 && chatList.length === 0\" class=\"empty-state\">\n                    <i class=\"el-icon-message empty-icon\"></i>\n                    <p class=\"empty-text\">暂无消息</p>\n                    <p class=\"empty-hint\">当有人给你留言或发送私聊消息时，会显示在这里</p>\n                    <div class=\"empty-actions\">\n                        <el-button type=\"primary\" @click=\"goToIndex\">去逛逛商品</el-button>\n                        <el-button @click=\"goToChat\">查看私聊</el-button>\n                    </div>\n                </div>\n            </div>\n            <app-foot></app-foot>\n        </app-body>\n    </div>\n</template>\n\n<script>\n    import AppHead from '../common/AppHeader.vue';\n    import AppBody from '../common/AppPageBody.vue'\n    import AppFoot from '../common/AppFoot.vue'\n\n    export default {\n        name: \"message\",\n        components: {\n            AppHead,\n            AppBody,\n            AppFoot\n        },\n        data(){\n            return{\n                commentList: [],  // 商品留言列表\n                chatList: [],     // 私聊会话列表\n                activeTab: 'all', // 当前选中的标签页\n                currentUserId: null\n            };\n        },\n        created(){\n            this.currentUserId = this.getCookie('shUserId');\n            this.loadAllMessages();\n        },\n        methods:{\n            getCookie(cname) {\n                const name = cname + \"=\";\n                const ca = document.cookie.split(';');\n                for (let i = 0; i < ca.length; i++) {\n                    let c = ca[i].trim();\n                    if (c.indexOf(name) === 0) return c.substring(name.length, c.length);\n                }\n                return \"\";\n            },\n            formatTime(timeStr) {\n                if (!timeStr) return '';\n                const time = new Date(timeStr);\n                const now = new Date();\n                const diff = now - time;\n                const minutes = Math.floor(diff / 60000);\n                const hours = Math.floor(diff / 3600000);\n                const days = Math.floor(diff / 86400000);\n                \n                if (minutes < 1) return '刚刚';\n                if (minutes < 60) return `${minutes}分钟前`;\n                if (hours < 24) return `${hours}小时前`;\n                if (days < 7) return `${days}天前`;\n                return timeStr.toString().substring(0, 16);\n            },\n            async loadAllMessages() {\n                // 加载商品留言\n                try {\n                    const commentRes = await this.$api.getAllMyMessage();\n                    if (commentRes.status_code === 1 && commentRes.data) {\n                        this.commentList = commentRes.data.map(item => {\n                            // 处理图片\n                            let imgUrl = '';\n                            try {\n                                const imgList = JSON.parse(item.idle.pictureList);\n                                imgUrl = imgList && imgList.length > 0 ? imgList[0] : '';\n                            } catch (e) {\n                                imgUrl = '';\n                            }\n                            item.idle.imgUrl = imgUrl;\n                            \n                            // 处理内容（移除HTML标签，只保留文本）\n                            let content = item.content;\n                            try {\n                                const contentList = content.split('<br>');\n                                content = contentList[0];\n                                for (let i = 1; i < contentList.length; i++) {\n                                    content += ' ' + contentList[i];\n                                }\n                                // 移除HTML标签\n                                content = content.replace(/<[^>]+>/g, '');\n                            } catch (e) {\n                                // 如果处理失败，保持原样\n                            }\n                            item.content = content;\n                            \n                            return item;\n                        });\n                    }\n                } catch (e) {\n                    console.error('加载商品留言失败:', e);\n                }\n\n                // 加载私聊会话\n                try {\n                    const chatRes = await this.$api.getChatSessionList();\n                    if (chatRes.status_code === 1 && chatRes.data) {\n                        this.chatList = chatRes.data.map(session => {\n                            // 处理商品图片\n                            if (session.idle && session.idle.pictureList) {\n                                try {\n                                    const imgList = JSON.parse(session.idle.pictureList);\n                                    session.idle.imgUrl = imgList && imgList.length > 0 ? imgList[0] : '';\n                                } catch (e) {\n                                    session.idle.imgUrl = '';\n                                }\n                            }\n                            // 计算该会话的未读消息数量（如果当前用户是接收方且消息未读）\n                            if (this.currentUserId) {\n                                const currentUserIdNum = parseInt(this.currentUserId);\n                                // 如果消息是发送给当前用户的，且未读，则计数\n                                if (session.toUser == currentUserIdNum && session.isRead === 0) {\n                                    session.unreadCount = 1; // 会话列表只显示最新一条，所以最多是1\n                                } else {\n                                    session.unreadCount = 0;\n                                }\n                            } else {\n                                session.unreadCount = 0;\n                            }\n                            return session;\n                        });\n                    }\n                } catch (e) {\n                    console.error('加载私聊会话失败:', e);\n                }\n            },\n            getUnreadCountForSession(session) {\n                return session.unreadCount || 0;\n            },\n            getDisplayUser(session) {\n                if (!session) return {};\n                if (!this.currentUserId) return session.toU || session.fromU || {};\n                if (session.fromUser == this.currentUserId) {\n                    return session.toU || {};\n                }\n                return session.fromU || {};\n            },\n            getGoodsImage(idle) {\n                if (!idle) return '';\n                if (idle.imgUrl) return idle.imgUrl;\n                if (idle.pictureList) {\n                    try {\n                        const imgList = JSON.parse(idle.pictureList);\n                        return imgList && imgList.length > 0 ? imgList[0] : '';\n                    } catch (e) {\n                        return '';\n                    }\n                }\n                return '';\n            },\n            handleTabClick(tab) {\n                // 标签切换时不需要额外操作，数据已经加载好了\n            },\n            toDetails(id){\n                this.$router.push({path: '/details', query: {id: id}});\n            },\n            toChat(session) {\n                const targetUserId = session.fromUser == this.currentUserId ? session.toUser : session.fromUser;\n                const idleId = session.idleId || null;\n                this.$router.push({\n                    path: '/chat',\n                    query: {\n                        targetUserId: targetUserId,\n                        idleId: idleId\n                    }\n                });\n            },\n            goToIndex() {\n                this.$router.push({path: '/index'});\n            },\n            goToChat() {\n                this.$router.push({path: '/chat'});\n            }\n        }\n    }\n</script>\n\n<style scoped>\n    .message-container {\n        min-height: 85vh;\n        padding: 20px;\n        max-width: 1200px;\n        margin: 0 auto;\n    }\n    .message-header {\n        margin-bottom: 20px;\n    }\n    .message-title {\n        font-size: 24px;\n        font-weight: 600;\n        color: #303133;\n        margin-bottom: 20px;\n    }\n    .message-tabs {\n        margin-bottom: 20px;\n    }\n    .message-tabs :deep(.el-tabs__item) {\n        font-size: 15px;\n        padding: 0 20px;\n    }\n    .message-tabs :deep(.el-tabs__item i) {\n        margin-right: 5px;\n    }\n\n    .message-item {\n        cursor: pointer;\n        padding: 20px;\n        margin-bottom: 12px;\n        background: #fff;\n        border-radius: 12px;\n        border: 1px solid #ebeef5;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        transition: all 0.3s ease;\n    }\n    .message-item:hover {\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);\n        border-color: #4fc08d;\n        transform: translateY(-2px);\n    }\n    .message-item-left {\n        flex: 1;\n        display: flex;\n        align-items: flex-start;\n        min-width: 0;\n    }\n    .message-avatar {\n        width: 55px;\n        height: 55px;\n        border-radius: 8px;\n        flex-shrink: 0;\n        margin-right: 15px;\n    }\n    .avatar-error {\n        width: 100%;\n        height: 100%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: #f5f7fa;\n        color: #909399;\n        font-size: 24px;\n    }\n    .message-content-wrapper {\n        flex: 1;\n        min-width: 0;\n    }\n    .message-header-info {\n        display: flex;\n        align-items: center;\n        margin-bottom: 8px;\n        gap: 10px;\n    }\n    .message-nickname {\n        font-weight: 600;\n        font-size: 16px;\n        color: #303133;\n    }\n    .message-type-tag {\n        font-size: 12px;\n        padding: 2px 8px;\n        border-radius: 12px;\n        display: inline-flex;\n        align-items: center;\n        gap: 4px;\n    }\n    .comment-tag {\n        background: #e8f5e9;\n        color: #2d8259;\n    }\n    .chat-tag {\n        background: #e3f2fd;\n        color: #1976d2;\n    }\n    .message-type-tag i {\n        font-size: 12px;\n    }\n    .message-content {\n        font-size: 14px;\n        color: #606266;\n        margin-bottom: 8px;\n        line-height: 1.5;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        display: -webkit-box;\n        -webkit-line-clamp: 2;\n        -webkit-box-orient: vertical;\n    }\n    .message-content.unread-message {\n        font-weight: 600;\n        color: #303133;\n    }\n    .unread-badge {\n        margin-left: 8px;\n    }\n    .message-footer {\n        display: flex;\n        align-items: center;\n        gap: 15px;\n        font-size: 12px;\n        color: #909399;\n    }\n    .message-goods {\n        color: #4fc08d;\n    }\n    .message-item-right {\n        flex-shrink: 0;\n        margin-left: 15px;\n    }\n    .message-goods-image {\n        width: 100px;\n        height: 100px;\n        border-radius: 8px;\n        object-fit: cover;\n    }\n    .image-error {\n        width: 100%;\n        height: 100%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: #f5f7fa;\n        color: #909399;\n        font-size: 24px;\n    }\n\n    /* 空状态样式 */\n    .empty-state {\n        text-align: center;\n        padding: 80px 20px;\n        background: #fff;\n        border-radius: 12px;\n        border: 1px dashed #dcdfe6;\n    }\n    .empty-icon {\n        font-size: 64px;\n        color: #c0c4cc;\n        margin-bottom: 20px;\n    }\n    .empty-text {\n        font-size: 18px;\n        color: #606266;\n        margin-bottom: 10px;\n        font-weight: 500;\n    }\n    .empty-hint {\n        font-size: 14px;\n        color: #909399;\n        margin-bottom: 30px;\n    }\n    .empty-actions {\n        display: flex;\n        justify-content: center;\n        gap: 15px;\n    }\n\n    /* 响应式 */\n    @media (max-width: 768px) {\n        .message-container {\n            padding: 15px;\n        }\n        .message-item {\n            padding: 15px;\n            flex-direction: column;\n            align-items: flex-start;\n        }\n        .message-item-right {\n            margin-left: 0;\n            margin-top: 15px;\n            width: 100%;\n        }\n        .message-goods-image {\n            width: 100%;\n            height: 150px;\n        }\n        .message-content {\n            -webkit-line-clamp: 3;\n        }\n    }\n</style>"],"sourceRoot":"src/components/page"}]}