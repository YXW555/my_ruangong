# CI/CD 和自动化测试简要说明

## 一、什么是 CI/CD？

### CI (持续集成)
- **作用**：代码提交后自动构建、测试
- **好处**：及早发现问题，保证代码质量

### CD (持续部署)
- **作用**：自动部署到生产环境
- **好处**：减少人工操作，提高效率

---

## 二、测试完整流程

### 测试金字塔（从下到上）

```
        /\
       /  \      E2E测试（端到端测试）
      /____\     少量，覆盖关键用户流程
     /      \    
    /________\   集成测试
   /          \  中等数量，测试模块间交互
  /____________\ 
 /              \ 单元测试
/________________\ 大量，测试单个方法/类
```

### 1. 单元测试（Unit Test）

**测试什么**：单个方法或类的功能

**示例**：
```java
@Test
void testUserLogin() {
    // 测试用户登录功能
    UserModel user = userService.userLogin("test", "123456");
    assertNotNull(user);
}
```

**特点**：
- ✅ 快速（毫秒级）
- ✅ 隔离（不依赖外部）
- ✅ 覆盖率高

### 2. 集成测试（Integration Test）

**测试什么**：多个组件之间的交互

**示例**：
```java
@Test
void testUserLoginAPI() {
    // 测试完整的 HTTP 请求流程
    mockMvc.perform(post("/user/login")
            .param("username", "test")
            .param("password", "123456"))
            .andExpect(status().isOk());
}
```

**特点**：
- ✅ 测试完整流程
- ✅ 验证接口正确性
- ✅ 使用 MockMvc 模拟请求

### 3. 端到端测试（E2E Test）

**测试什么**：完整的用户流程

**示例**：
```javascript
// Cypress 测试
it('用户购买流程', () => {
  cy.visit('/login')
  cy.get('#username').type('test')
  cy.get('button').click()
  cy.visit('/product/1')
  cy.get('.buy-button').click()
})
```

**特点**：
- ✅ 测试真实用户场景
- ✅ 覆盖关键业务流程
- ✅ 验证前后端集成

---

## 三、CI/CD 实现方案

### 方案对比

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| **GitHub Actions** | 免费、简单、与 GitHub 集成 | 仅限 GitHub | ✅ **推荐**（本项目） |
| **GitLab CI/CD** | 功能强大、私有仓库免费 | 需要 GitLab | GitLab 项目 |
| **Jenkins** | 功能最全面、插件丰富 | 需要自己搭建 | 企业级项目 |

### 本项目采用：GitHub Actions

**原因**：
- ✅ 免费（公开仓库）
- ✅ 配置简单
- ✅ 与 GitHub 完美集成

---

## 四、CI/CD 工作流程

### 流程图

```
代码提交 (Git Push)
    ↓
自动触发 CI/CD
    ↓
┌─────────────────────┐
│  后端构建和测试      │
│  - 编译 Java 代码    │
│  - 运行单元测试      │
│  - 生成测试报告      │
└─────────────────────┘
    ↓
┌─────────────────────┐
│  前端构建            │
│  - 安装依赖          │
│  - 构建生产版本      │
└─────────────────────┘
    ↓
┌─────────────────────┐
│  构建 Docker 镜像    │
│  - 后端镜像          │
│  - 前端镜像          │
└─────────────────────┘
    ↓
┌─────────────────────┐
│  自动部署（可选）    │
│  - 推送到服务器      │
│  - 重启服务          │
└─────────────────────┘
```

### 触发条件

- **Push 到 main/master/develop 分支**
- **创建 Pull Request**

---

## 五、如何开始？

### 第一步：运行本地测试（2 分钟）

```bash
cd backend
mvn test
```

### 第二步：查看测试覆盖率（1 分钟）

```bash
mvn jacoco:report
# 打开 backend/target/site/jacoco/index.html
```

### 第三步：配置 GitHub Actions（5 分钟）

1. 推送代码到 GitHub
2. 进入仓库 → Actions 标签
3. 查看工作流运行状态

### 第四步：构建 Docker 镜像（5 分钟）

```bash
# 后端
cd backend
docker build -t campus-trading-backend:latest .

# 前端
cd frontend
docker build -t campus-trading-frontend:latest .
```

### 第五步：使用 Docker Compose 启动（2 分钟）

```bash
docker-compose up -d
```

---

## 六、测试覆盖率目标

### 推荐覆盖率

- **单元测试**：70%+
- **集成测试**：50%+
- **E2E 测试**：关键流程 100%

### 如何提高覆盖率？

1. **先写关键功能测试**
   - 用户登录/注册
   - 订单创建/支付
   - 商品发布/查询

2. **逐步完善**
   - 每周增加 5-10% 覆盖率
   - 优先覆盖核心业务逻辑

3. **持续改进**
   - 每次新功能都写测试
   - 修复 Bug 时补充测试

---

## 七、部署策略

### 1. 蓝绿部署

- 两套环境（蓝/绿）
- 切换流量，零停机

### 2. 滚动部署

- 逐步替换实例
- 适合多实例场景

### 3. 金丝雀部署

- 先部署到少量实例
- 验证后全量部署

**本项目**：使用 Docker Compose，支持快速切换

---

## 八、监控和告警（可选）

### 监控指标

- **应用性能**：响应时间、错误率
- **服务器资源**：CPU、内存、磁盘
- **数据库性能**：查询时间、连接数

### 工具推荐

- **Prometheus**：指标收集
- **Grafana**：可视化
- **ELK**：日志分析

---

## 九、最佳实践

### 1. 测试先行（TDD）

- 先写测试，再写代码
- 保证代码质量

### 2. 快速反馈

- CI 流程应该在 10 分钟内完成
- 及时发现问题

### 3. 自动化一切

- 构建、测试、部署全部自动化
- 减少人工错误

### 4. 版本控制

- 所有配置都纳入版本控制
- 可追溯、可回滚

---

## 十、总结

### CI/CD 的价值

1. **提高效率**：自动化减少人工操作
2. **保证质量**：自动测试及早发现问题
3. **快速交付**：缩短发布周期
4. **降低风险**：自动化减少人为错误

### 测试的价值

1. **保证质量**：确保功能正确
2. **文档作用**：测试即文档
3. **重构信心**：有测试才能放心重构
4. **回归测试**：防止新功能破坏旧功能

---

## 十一、下一步

### 立即开始

1. ✅ 运行本地测试
2. ✅ 查看测试覆盖率
3. ✅ 配置 GitHub Actions
4. ✅ 编写更多测试

### 持续改进

1. 提高测试覆盖率
2. 优化 CI/CD 流程
3. 添加监控和告警
4. 完善部署策略

---

**详细文档**：
- [CI/CD 和自动化测试指南](./CI-CD和自动化测试指南.md)
- [CI/CD 快速开始指南](./CI-CD快速开始指南.md)

---

**祝您测试顺利！** 🚀

