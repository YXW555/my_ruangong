# 智能自动回复功能说明

## 概述

智能自动回复功能基于 **HanLP** 中文自然语言处理框架实现，支持精确匹配和语义相似度匹配两种模式。

## 功能特点

### 1. 精确匹配（Exact Matching）
- 传统的关键词包含匹配
- 当用户消息中包含模板关键词时，立即匹配
- 匹配速度快，准确率高

### 2. 语义相似度匹配（Semantic Matching）
- 基于 HanLP 的中文分词和语义分析
- 支持同义词和语义相似匹配
- 例如：用户问"多少钱"，可以匹配关键词"价格"的模板

### 3. 智能匹配策略
- **优先级**：精确匹配 > 语义匹配
- **阈值控制**：语义匹配需要达到相似度阈值才会匹配
- **回退机制**：如果 NLP 匹配失败，自动回退到传统匹配

## 配置说明

在 `application.properties` 中可以配置以下参数：

```properties
# 是否启用智能NLP匹配（默认：true）
auto-reply.nlp.enabled=true

# 语义相似度阈值，范围0-1（默认：0.5）
# 值越高，匹配越严格；值越低，匹配越宽松
auto-reply.nlp.similarity-threshold=0.5
```

### 配置参数说明

| 参数 | 说明 | 默认值 | 取值范围 |
|------|------|--------|----------|
| `auto-reply.nlp.enabled` | 是否启用NLP智能匹配 | `true` | `true` / `false` |
| `auto-reply.nlp.similarity-threshold` | 语义相似度阈值 | `0.5` | `0.0` - `1.0` |

### 相似度阈值建议

- **0.3-0.4**：宽松匹配，适合希望提高召回率的场景
- **0.5**：平衡匹配，推荐使用（默认值）
- **0.6-0.7**：严格匹配，适合对准确率要求高的场景
- **0.8+**：非常严格，基本只匹配高度相似的文本

## 使用示例

### 场景1：精确匹配
- **模板关键词**：`价格`
- **用户消息**：`这个商品价格是多少？`
- **匹配结果**：✅ 精确匹配（相似度：1.0）

### 场景2：语义匹配
- **模板关键词**：`价格`
- **用户消息**：`这个多少钱？`
- **匹配结果**：✅ 语义匹配（相似度：0.65）

### 场景3：不匹配
- **模板关键词**：`价格`
- **用户消息**：`这个商品质量怎么样？`
- **匹配结果**：❌ 不匹配（相似度：0.2，低于阈值）

## 技术实现

### 核心组件

1. **NlpMatcher** (`com.second.hand.trading.server.util.NlpMatcher`)
   - 提供智能匹配算法
   - 基于 HanLP 进行中文分词
   - 计算文本相似度

2. **AutoReplyTemplateServiceImpl** (`com.second.hand.trading.server.service.impl.AutoReplyTemplateServiceImpl`)
   - 集成智能匹配算法
   - 支持配置化的匹配策略
   - 提供回退机制

### 算法原理

1. **文本预处理**
   - 去除 HTML 标签
   - 转换为小写
   - 去除首尾空格

2. **关键词提取**
   - 使用 HanLP 进行中文分词
   - 过滤停用词和标点符号
   - 保留名词、动词、形容词等有意义的词

3. **相似度计算**
   - Jaccard 相似度：计算关键词集合的交集与并集比例
   - 关键词重叠度：计算共同关键词的比例
   - 综合相似度：加权平均（Jaccard 60% + 重叠度 40%）

## 性能优化

1. **缓存机制**：HanLP 会自动缓存分词结果
2. **回退机制**：NLP 失败时自动使用传统匹配
3. **阈值控制**：通过相似度阈值过滤低质量匹配

## 注意事项

1. **首次启动**：HanLP 首次加载可能需要几秒钟，后续会更快
2. **内存占用**：HanLP 会占用一定内存（约100-200MB）
3. **依赖管理**：确保 `pom.xml` 中已添加 HanLP 依赖

## 故障排查

### 问题1：NLP匹配不生效
- 检查配置：`auto-reply.nlp.enabled=true`
- 检查依赖：确认 `pom.xml` 中有 HanLP 依赖
- 查看日志：检查是否有异常信息

### 问题2：匹配准确率低
- 调整相似度阈值：提高 `similarity-threshold` 值
- 优化关键词：使用更具体、更常见的关键词
- 检查分词结果：查看 HanLP 分词是否正确

### 问题3：性能问题
- 如果模板数量很多，考虑使用缓存
- 如果不需要语义匹配，可以关闭 NLP：`auto-reply.nlp.enabled=false`

## 未来优化方向

1. **机器学习模型**：训练专门的意图识别模型
2. **多轮对话**：支持上下文理解和多轮对话
3. **个性化匹配**：根据用户历史行为优化匹配策略
4. **A/B测试**：对比不同阈值和算法的效果

