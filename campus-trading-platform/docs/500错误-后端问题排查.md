# 500 错误 - 后端问题排查

## 问题现象

前端可以连接到后端（通过 `/api`），但后端返回 500 内部服务器错误。

## 立即排查

在服务器上执行：

```bash
cd /opt/campus-trading-platform

# 1. 检查后端容器是否运行
sudo docker compose ps backend

# 2. 查看后端日志（最重要！）
sudo docker compose logs --tail=100 backend

# 3. 查看实时日志
sudo docker compose logs -f backend
```

## 常见原因

### 1. 数据库连接失败

**检查**：
```bash
# 检查 MySQL 容器是否运行
sudo docker compose ps mysql

# 检查数据库是否已初始化
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "SHOW DATABASES;"
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "USE second_hand_trading; SHOW TABLES;"
```

**如果数据库不存在或表不存在**：
```bash
# 检查 init.sql 文件是否存在
ls -la /opt/campus-trading-platform/init.sql

# 如果不存在，需要上传数据库初始化脚本
```

### 2. Redis 连接失败

**检查**：
```bash
# 检查 Redis 容器是否运行
sudo docker compose ps redis

# 测试 Redis 连接
sudo docker compose exec redis redis-cli ping
```

### 3. 后端应用启动失败

**检查后端启动日志**：
```bash
sudo docker compose logs backend | grep -i error
sudo docker compose logs backend | grep -i exception
```

### 4. 配置文件错误

**检查环境变量**：
```bash
sudo docker compose exec backend env | grep SPRING
```

## 快速修复流程

```bash
cd /opt/campus-trading-platform

# 1. 查看所有容器状态
sudo docker compose ps

# 2. 查看后端详细日志
sudo docker compose logs --tail=200 backend

# 3. 如果后端容器没有运行，重启
sudo docker compose restart backend

# 4. 查看实时日志
sudo docker compose logs -f backend
```

## 数据库初始化

如果数据库表不存在，需要初始化：

```bash
# 1. 检查是否有 SQL 文件
ls -la /opt/campus-trading-platform/*.sql

# 2. 如果有 SQL 文件，导入数据库
sudo docker compose exec mysql mysql -u root -proot123456 < /opt/campus-trading-platform/init.sql

# 或者手动导入
sudo docker compose exec -i mysql mysql -u root -proot123456 second_hand_trading < /opt/campus-trading-platform/init.sql
```

## 完整排查脚本

```bash
#!/bin/bash
cd /opt/campus-trading-platform

echo "=== 1. 容器状态 ==="
sudo docker compose ps

echo -e "\n=== 2. 后端日志（最后100行）==="
sudo docker compose logs --tail=100 backend

echo -e "\n=== 3. MySQL 状态 ==="
sudo docker compose ps mysql
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "SHOW DATABASES;" 2>&1

echo -e "\n=== 4. Redis 状态 ==="
sudo docker compose ps redis
sudo docker compose exec redis redis-cli ping 2>&1

echo -e "\n=== 5. 测试后端连接 ==="
curl -v http://localhost:8080 2>&1 | head -20
```

