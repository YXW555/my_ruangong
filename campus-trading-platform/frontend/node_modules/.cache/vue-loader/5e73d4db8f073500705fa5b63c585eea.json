{"remainingRequest":"D:\\Git\\ruangong\\campus-trading-platform\\frontend\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\Git\\ruangong\\campus-trading-platform\\frontend\\src\\components\\page\\idle-details.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\Git\\ruangong\\campus-trading-platform\\frontend\\src\\components\\page\\idle-details.vue","mtime":1766669659414},{"path":"D:\\Git\\ruangong\\campus-trading-platform\\frontend\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1678197338000},{"path":"D:\\Git\\ruangong\\campus-trading-platform\\frontend\\node_modules\\babel-loader\\lib\\index.js","mtime":1678197338000},{"path":"D:\\Git\\ruangong\\campus-trading-platform\\frontend\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1678197338000},{"path":"D:\\Git\\ruangong\\campus-trading-platform\\frontend\\node_modules\\vue-loader\\lib\\index.js","mtime":1678197338000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport AppHead from '../common/AppHeader.vue';\nimport AppBody from '../common/AppPageBody.vue'\nimport AppFoot from '../common/AppFoot.vue'\n\nexport default {\n    name: \"idle-details\",\n    components: {\n        AppHead,\n        AppBody,\n        AppFoot\n    },\n    data() {\n        return {\n            messageContent:'',\n            toUser:null,\n            toMessage:null,\n            isReply:false,\n            replyData:{\n                toUserNickname:'',\n                toMessage:''\n            },\n            messageList:[],\n            idleItemInfo:{\n                id:'',\n                idleName:'',\n                idleDetails:'',\n                pictureList:[],\n                idlePrice:0,\n                idlePlace:'',\n                idleLabel:'',\n                idleStatus:-1,\n                userId:'',\n                user:{\n                    avatar:'',\n                    nickname:'',\n                    signInTime:''\n                },\n            },\n            isMaster:false,\n            isFavorite:true,\n            favoriteId:0,\n            sellerRatingStats: null, // 卖家信誉评分统计 {averageRating, ratingCount}\n            categories: {\n                '1': '数码科技',\n                '2': '生活用品',\n                '3': '运动相关',\n                '4': '图书笔记',\n                '5': '公告'\n            },\n            membershipStatus: null // 会员状态\n        };\n    },\n    computed: {\n        canPin() {\n            // 检查用户是否是会员且可以置顶\n            return this.membershipStatus && this.membershipStatus.isValid && this.membershipStatus.canPin;\n        }\n    },\n    created(){\n        // 加载会员状态\n        this.loadMembershipStatus();\n        \n        let id=this.$route.query.id;\n        this.$api.getIdleItem({\n            id:id\n        }).then(res=>{\n            console.log(res);\n            if(res.data){\n                let list=res.data.idleDetails.split(/\\r?\\n/);\n                let str='';\n                for(let i=0;i<list.length;i++){\n                    str+='<p>'+list[i]+'</p>';\n                }\n                res.data.idleDetails=str;\n                res.data.pictureList=JSON.parse(res.data.pictureList);\n                this.idleItemInfo=res.data;\n                console.log(this.idleItemInfo);\n                let userId=this.getCookie('shUserId');\n                console.log('userid',userId)\n                if(userId == this.idleItemInfo.userId){\n                    console.log('isMaster');\n                    this.isMaster=true;\n                }\n                this.checkFavorite();\n                this.getAllIdleMessage();\n                // 加载卖家信誉评分\n                this.loadSellerRating();\n            }\n            $('html,body').animate({\n                scrollTop: 0\n            }, {duration: 500, easing: \"swing\"});\n        });\n    },\n    methods: {\n        getCategoryName(label) {\n            return this.categories[label] || '其他';\n        },\n        getTagType(label) {\n            const types = {\n                '1': 'primary',\n                '2': 'success',\n                '3': 'warning',\n                '4': 'info',\n                '5': 'danger'\n            };\n            return types[label] || 'info';\n        },\n        getAllIdleMessage(){\n            this.$api.getAllIdleMessage({\n                idleId:this.idleItemInfo.id\n            }).then(res=>{\n                console.log('getAllIdleMessage',res.data);\n                if(res.status_code===1){\n                    this.messageList=res.data;\n                }\n            }).catch(()=>{\n            })\n        },\n        checkFavorite(){\n            this.$api.checkFavorite({\n                idleId:this.idleItemInfo.id\n            }).then(res=>{\n                if(!res.data){\n                    this.isFavorite=false;\n                }else {\n                    this.favoriteId=res.data;\n                }\n            })\n        },\n        getCookie(cname){\n            var name = cname + \"=\";\n            var ca = document.cookie.split(';');\n            for(var i=0; i<ca.length; i++)\n            {\n                var c = ca[i].trim();\n                if (c.indexOf(name)===0) return c.substring(name.length,c.length);\n            }\n            return \"\";\n        },\n        startChat(){\n            const userId = this.getCookie('shUserId');\n            if(!userId){\n                this.$message.error(\"请先登录后再发起私聊\");\n                this.$router.push('/login');\n                return;\n            }\n            if(userId == this.idleItemInfo.userId){\n                this.$message.info(\"这是您自己发布的闲置哦\");\n                return;\n            }\n            this.$router.push({\n                path:'/chat',\n                query:{\n                    targetUserId:this.idleItemInfo.userId,\n                    idleId:this.idleItemInfo.id\n                }\n            });\n        },\n        replyMessage(index){\n            $('html,body').animate({\n                scrollTop: $(\"#replyMessageLocation\").offset().top-100\n            }, {duration: 500, easing: \"swing\"});\n            this.isReply=true;\n            this.replyData.toUserNickname=this.messageList[index].fromU.nickname;\n            this.replyData.toMessage=this.messageList[index].content.substring(0,10)+(this.messageList[index].content.length>10?'...':'');\n            this.toUser=this.messageList[index].userId;\n            this.toMessage=this.messageList[index].id;\n        },\n        changeStatus(idle,status){\n            this.$api.updateIdleItem({\n                id:idle.id,\n                idleStatus:status\n            }).then(res=>{\n                console.log(res);\n                if(res.status_code===1){\n                    this.idleItemInfo.idleStatus=status;\n                    this.$message({\n                        message: status === 1 ? '商品已重新上架' : '商品已下架',\n                        type: 'success'\n                    });\n                }else {\n                    this.$message.error(res.msg)\n                }\n            });\n        },\n        buyButton(idleItemInfo){\n            this.$api.addOrder({\n                idleId:idleItemInfo.id,\n                orderPrice:idleItemInfo.idlePrice,\n            }).then(res=>{\n                console.log(res);\n                if(res.status_code===1){\n                    this.$router.push({path: '/order', query: {id: res.data.id}});\n                }else {\n                    this.$message.error(res.msg)\n                }\n            }).catch(e=>{\n\n            })\n        },\n        loadMembershipStatus() {\n            this.$api.getMembershipStatus().then(res => {\n                if (res.status_code === 1) {\n                    this.membershipStatus = res.data;\n                }\n            }).catch(() => {\n                // 静默失败\n            });\n        },\n        handlePinItem() {\n            if (!this.canPin) {\n                this.$message.warning('您还不是会员，无法使用置顶功能！');\n                this.$router.push('/membership');\n                return;\n            }\n\n            if (this.idleItemInfo.isPinned) {\n                // 取消置顶（这里需要后端支持取消置顶的接口）\n                this.$message.info('取消置顶功能开发中，置顶将在到期后自动取消');\n                return;\n            }\n\n            // 置顶商品\n            this.$confirm('置顶商品可以让您的商品在列表中优先显示，是否确认置顶？', '确认置顶', {\n                confirmButtonText: '确认',\n                cancelButtonText: '取消',\n                type: 'info'\n            }).then(() => {\n                // 默认置顶7天\n                this.$api.pinItem({\n                    idleItemId: this.idleItemInfo.id,\n                    durationDays: 7\n                }).then(res => {\n                    if (res.status_code === 1) {\n                        this.$message.success('置顶成功！');\n                        // 刷新商品信息\n                        this.$api.getIdleItem({\n                            id: this.idleItemInfo.id\n                        }).then(refreshRes => {\n                            if (refreshRes.data) {\n                                refreshRes.data.pictureList = JSON.parse(refreshRes.data.pictureList);\n                                this.idleItemInfo = refreshRes.data;\n                            }\n                        });\n                        // 刷新会员状态\n                        this.loadMembershipStatus();\n                    } else {\n                        this.$message.error(res.msg || '置顶失败');\n                    }\n                }).catch(() => {\n                    this.$message.error('网络错误，请稍后重试');\n                });\n            }).catch(() => {});\n        },\n        favoriteButton(idleItemInfo){\n            if(this.isFavorite){\n                this.$api.deleteFavorite({\n                    id: this.favoriteId\n                }).then(res=>{\n                    console.log(res);\n                    if(res.status_code===1){\n                        this.$message({\n                            message: '已取消购物车！',\n                            type: 'success'\n                        });\n                        this.isFavorite=false;\n                    }else {\n                        this.$message.error(res.msg)\n                    }\n                }).catch(e=>{\n                })\n            }else {\n                this.$api.addFavorite({\n                    idleId:idleItemInfo.id\n                }).then(res=>{\n                    console.log(res);\n                    if(res.status_code===1){\n                        this.$message({\n                            message: '已加入购物车！',\n                            type: 'success'\n                        });\n                        this.isFavorite=true;\n                        this.favoriteId=res.data;\n                    }else {\n                        this.$message.error(res.msg)\n                    }\n                }).catch(e=>{\n                })\n            }\n        },\n        cancelReply(){\n            this.isReply=false;\n            this.toUser=this.idleItemInfo.userId;\n            this.toMessage=null;\n            this.replyData.toUserNickname='';\n            this.replyData.toMessage='';\n        },\n        sendMessage(){\n            let content=this.messageContent.trim();\n            if(this.toUser==null){\n                this.toUser=this.idleItemInfo.userId;\n            }\n            if(content){\n                let contentList=content.split(/\\r?\\n/);\n                let contenHtml=contentList[0];\n                for(let i=1;i<contentList.length;i++){\n                    contenHtml+='<br>'+contentList[i];\n                }\n                this.$api.sendMessage({\n                    idleId:this.idleItemInfo.id,\n                    content:contenHtml,\n                    toUser:this.toUser,\n                    toMessage:this.toMessage\n                }).then(res=>{\n                    if(res.status_code===1){\n                        this.$message({\n                            message: '留言成功！',\n                            type: 'success'\n                        });\n                        this.messageContent='';\n                        this.cancelReply();\n                        this.getAllIdleMessage();\n                    }else {\n                        this.$message.error(\"留言失败！\"+res.msg);\n                    }\n                }).catch(()=>{\n                    this.$message.error(\"留言失败！\");\n                });\n\n            }else{\n                this.$message.error(\"留言为空！\");\n            }\n        },\n        loadSellerRating() {\n            if (!this.idleItemInfo.userId) {\n                return;\n            }\n            this.$api.getSellerStats({\n                sellerId: this.idleItemInfo.userId\n            }).then(res => {\n                if (res.status_code === 1 && res.data) {\n                    // 确保评分是数字类型，保留一位小数\n                    const avgRating = parseFloat(res.data.averageRating || 0);\n                    this.sellerRatingStats = {\n                        averageRating: avgRating > 0 ? avgRating : 0,\n                        ratingCount: res.data.ratingCount || 0\n                    };\n                } else {\n                    this.sellerRatingStats = null;\n                }\n            }).catch(() => {\n                this.sellerRatingStats = null;\n            });\n        }\n    },\n}\n",{"version":3,"sources":["idle-details.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAyOA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"idle-details.vue","sourceRoot":"src/components/page","sourcesContent":["<template>\n    <div>\n        <app-head></app-head>\n        <app-body>\n            <div class=\"idle-details-container\">\n                <!-- 商品详情卡片 -->\n                <el-card class=\"product-card\" shadow=\"hover\">\n                    <!-- 用户信息与价格区域 -->\n                    <div class=\"details-header\">\n                        <div class=\"details-header-user-info\">\n                            <el-avatar \n                                :size=\"80\" \n                                :src=\"idleItemInfo.user.avatar\" \n                                class=\"user-avatar\">\n                            </el-avatar>\n                            <div class=\"user-info-text\">\n                                <div class=\"details-header-user-info-nickname\">{{idleItemInfo.user.nickname}}</div>\n                                <div class=\"details-header-user-info-time\">\n                                    <i class=\"el-icon-time\"></i> {{idleItemInfo.user.signInTime.substring(0,10)}} 加入平台\n                                </div>\n                                <div class=\"details-header-user-info-rating\" v-if=\"sellerRatingStats\">\n                                    <el-rate\n                                        v-model=\"sellerRatingStats.averageRating\"\n                                        disabled\n                                        show-score\n                                        text-color=\"#ff9900\"\n                                        score-template=\"{value}\">\n                                    </el-rate>\n                                    <span class=\"rating-count\">({{sellerRatingStats.ratingCount}}条评价)</span>\n                                </div>\n                                <div class=\"details-header-user-info-rating\" v-else-if=\"sellerRatingStats === null\">\n                                    <span class=\"no-rating\">暂无评价</span>\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"details-header-buy\" :class=\"{'owner-controls': isMaster}\">\n                            <div v-show=\"idleItemInfo.idlePrice !== 0\" class=\"product-price\">\n                                <span class=\"price-symbol\">¥</span>{{idleItemInfo.idlePrice}}\n                            </div>\n                            <div v-if=\"!isMaster && idleItemInfo.idleStatus!==1\" class=\"product-status\">\n                                <i class=\"el-icon-warning-outline\"></i> 闲置已下架或删除\n                            </div>\n                            <div class=\"action-buttons\">\n                                <el-button \n                                    v-show=\"idleItemInfo.idlePrice > 0\" \n                                    v-if=\"!isMaster && idleItemInfo.idleStatus===1\" \n                                    type=\"danger\" \n                                    icon=\"el-icon-shopping-cart-2\" \n                                    round \n                                    @click=\"buyButton(idleItemInfo)\">\n                                    立即购买\n                                </el-button>\n                                <el-button \n                                    v-show=\"idleItemInfo.idlePrice > 0\" \n                                    v-if=\"!isMaster && idleItemInfo.idleStatus===1\" \n                                    :type=\"isFavorite ? 'warning' : 'primary'\" \n                                    :icon=\"isFavorite ? 'el-icon-star-on' : 'el-icon-star-off'\" \n                                    round \n                                    @click=\"favoriteButton(idleItemInfo)\">\n                                    {{isFavorite ? '取消购物车' : '加入购物车'}}\n                                </el-button>\n                                <el-button\n                                        v-if=\"!isMaster && idleItemInfo.idleStatus===1\"\n                                        type=\"primary\"\n                                        icon=\"el-icon-chat-dot-round\"\n                                        round\n                                        @click=\"startChat\">\n                                    私聊\n                                </el-button>\n                                <el-button \n                                    v-if=\"isMaster && idleItemInfo.idleStatus===1\" \n                                    type=\"danger\" \n                                    icon=\"el-icon-download\" \n                                    round \n                                    @click=\"changeStatus(idleItemInfo,2)\">\n                                    下架\n                                </el-button>\n                                <el-button \n                                    v-if=\"isMaster && idleItemInfo.idleStatus===2\" \n                                    type=\"success\" \n                                    icon=\"el-icon-upload2\" \n                                    round \n                                    @click=\"changeStatus(idleItemInfo,1)\">\n                                    重新上架\n                                </el-button>\n                                <el-button \n                                    v-if=\"isMaster && idleItemInfo.idleStatus===1 && canPin\" \n                                    :type=\"idleItemInfo.isPinned ? 'warning' : 'primary'\" \n                                    :icon=\"idleItemInfo.isPinned ? 'el-icon-top' : 'el-icon-top'\" \n                                    round \n                                    @click=\"handlePinItem\">\n                                    {{idleItemInfo.isPinned ? '取消置顶' : '置顶商品'}}\n                                </el-button>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- 分隔线 -->\n                    <el-divider></el-divider>\n\n                    <!-- 商品详情区域 -->\n                    <div class=\"details-info\">\n                        <div class=\"details-info-title\">\n                            <span class=\"product-name\">{{idleItemInfo.idleName}}</span>\n                            <el-tag \n                                v-if=\"idleItemInfo.isPinned\" \n                                type=\"warning\" \n                                size=\"small\" \n                                class=\"pin-tag\">\n                                <i class=\"el-icon-top\"></i> 置顶中\n                            </el-tag>\n                            <el-tag \n                                v-if=\"idleItemInfo.idleLabel\" \n                                :type=\"getTagType(idleItemInfo.idleLabel)\" \n                                size=\"medium\" \n                                class=\"product-tag\">\n                                {{getCategoryName(idleItemInfo.idleLabel)}}\n                            </el-tag>\n                        </div>\n                        \n                        <div class=\"product-location\" v-if=\"idleItemInfo.idlePlace\">\n                            <i class=\"el-icon-location\"></i> {{idleItemInfo.idlePlace}}\n                        </div>\n                        \n                        <div class=\"details-info-main\" v-html=\"idleItemInfo.idleDetails\">\n                            {{idleItemInfo.idleDetails}}\n                        </div>\n                    </div>\n\n                    <!-- 商品图片区域 -->\n                    <div class=\"details-picture\">\n                        <el-carousel \n                            v-if=\"idleItemInfo.pictureList && idleItemInfo.pictureList.length > 0\" \n                            :interval=\"4000\" \n                            type=\"card\" \n                            height=\"400px\" \n                            indicator-position=\"outside\"\n                            class=\"image-carousel\">\n                            <el-carousel-item v-for=\"(imgUrl, i) in idleItemInfo.pictureList\" :key=\"i\">\n                                <el-image \n                                    :src=\"imgUrl\" \n                                    fit=\"contain\" \n                                    class=\"carousel-image\"\n                                    :preview-src-list=\"idleItemInfo.pictureList\">\n                                </el-image>\n                            </el-carousel-item>\n                        </el-carousel>\n                        \n                        <div v-else class=\"no-images\">\n                            <i class=\"el-icon-picture-outline\"></i>\n                            <p>暂无图片</p>\n                        </div>\n                    </div>\n                </el-card>\n\n                <!-- 留言板区域 -->\n                <el-card class=\"message-card\" shadow=\"hover\" id=\"replyMessageLocation\">\n                    <div slot=\"header\" class=\"message-header\">\n                        <span><i class=\"el-icon-chat-line-round\"></i> 留言板</span>\n                        <el-badge :value=\"messageList.length\" :max=\"99\" class=\"message-badge\" type=\"primary\"/>\n                    </div>\n                    \n                    <!-- 发送留言区域 -->\n                    <div class=\"message-send\">\n                        <div v-if=\"isReply\" class=\"reply-info\">\n                            <el-tag type=\"info\" closable @close=\"cancelReply\">\n                                回复：{{replyData.toMessage}} @{{replyData.toUserNickname}}\n                            </el-tag>\n                        </div>\n                        <el-input\n                                type=\"textarea\"\n                                :rows=\"3\"\n                                placeholder=\"在此留言提问...\"\n                                v-model=\"messageContent\"\n                                maxlength=\"200\"\n                                show-word-limit\n                                class=\"message-input\">\n                        </el-input>\n                        <div class=\"message-send-button\">\n                            <el-button type=\"primary\" icon=\"el-icon-s-promotion\" @click=\"sendMessage\" round>发送留言</el-button>\n                        </div>\n                    </div>\n                    \n                    <!-- 留言列表 -->\n                    <div class=\"message-list\">\n                        <div v-if=\"messageList.length === 0\" class=\"no-messages\">\n                            <i class=\"el-icon-chat-dot-square\"></i>\n                            <p>暂无留言，快来留言吧!</p>\n                        </div>\n                        \n                        <el-timeline v-else>\n                            <el-timeline-item\n                                v-for=\"(mes, index) in messageList\"\n                                :key=\"index\"\n                                :timestamp=\"mes.createTime\"\n                                placement=\"top\"\n                                :color=\"index % 2 === 0 ? '#409EFF' : '#67C23A'\">\n                                \n                                <el-card class=\"message-item-card\" shadow=\"hover\">\n                                    <div class=\"message-container-list\">\n                                        <div class=\"message-container-list-left\">\n                                            <el-avatar\n                                                :size=\"50\"\n                                                :src=\"mes.fromU.avatar\"\n                                                class=\"message-avatar\">\n                                            </el-avatar>\n                                            <div class=\"message-container-list-text\">\n                                                <div class=\"message-nickname\">\n                                                    {{mes.fromU.nickname}}\n                                                    <span v-if=\"mes.toU.nickname\" class=\"reply-to\">\n                                                        回复 <strong>@{{mes.toU.nickname}}</strong>：\n                                                        <span class=\"quoted-message\">{{mes.toM.content.substring(0,10)}}{{mes.toM.content.length>10?'...':''}}</span>\n                                                    </span>\n                                                </div>\n                                                <div class=\"message-content\" v-html=\"mes.content\">{{mes.content}}</div>\n                                            </div>\n                                        </div>\n                                        <div class=\"message-container-list-right\">\n                                            <el-button type=\"text\" icon=\"el-icon-chat-dot-round\" @click=\"replyMessage(index)\">回复</el-button>\n                                        </div>\n                                    </div>\n                                </el-card>\n                            </el-timeline-item>\n                        </el-timeline>\n                    </div>\n                </el-card>\n            </div>\n            <app-foot></app-foot>\n        </app-body>\n    </div>\n</template>\n\n<script>\n    import AppHead from '../common/AppHeader.vue';\n    import AppBody from '../common/AppPageBody.vue'\n    import AppFoot from '../common/AppFoot.vue'\n\n    export default {\n        name: \"idle-details\",\n        components: {\n            AppHead,\n            AppBody,\n            AppFoot\n        },\n        data() {\n            return {\n                messageContent:'',\n                toUser:null,\n                toMessage:null,\n                isReply:false,\n                replyData:{\n                    toUserNickname:'',\n                    toMessage:''\n                },\n                messageList:[],\n                idleItemInfo:{\n                    id:'',\n                    idleName:'',\n                    idleDetails:'',\n                    pictureList:[],\n                    idlePrice:0,\n                    idlePlace:'',\n                    idleLabel:'',\n                    idleStatus:-1,\n                    userId:'',\n                    user:{\n                        avatar:'',\n                        nickname:'',\n                        signInTime:''\n                    },\n                },\n                isMaster:false,\n                isFavorite:true,\n                favoriteId:0,\n                sellerRatingStats: null, // 卖家信誉评分统计 {averageRating, ratingCount}\n                categories: {\n                    '1': '数码科技',\n                    '2': '生活用品',\n                    '3': '运动相关',\n                    '4': '图书笔记',\n                    '5': '公告'\n                },\n                membershipStatus: null // 会员状态\n            };\n        },\n        computed: {\n            canPin() {\n                // 检查用户是否是会员且可以置顶\n                return this.membershipStatus && this.membershipStatus.isValid && this.membershipStatus.canPin;\n            }\n        },\n        created(){\n            // 加载会员状态\n            this.loadMembershipStatus();\n            \n            let id=this.$route.query.id;\n            this.$api.getIdleItem({\n                id:id\n            }).then(res=>{\n                console.log(res);\n                if(res.data){\n                    let list=res.data.idleDetails.split(/\\r?\\n/);\n                    let str='';\n                    for(let i=0;i<list.length;i++){\n                        str+='<p>'+list[i]+'</p>';\n                    }\n                    res.data.idleDetails=str;\n                    res.data.pictureList=JSON.parse(res.data.pictureList);\n                    this.idleItemInfo=res.data;\n                    console.log(this.idleItemInfo);\n                    let userId=this.getCookie('shUserId');\n                    console.log('userid',userId)\n                    if(userId == this.idleItemInfo.userId){\n                        console.log('isMaster');\n                        this.isMaster=true;\n                    }\n                    this.checkFavorite();\n                    this.getAllIdleMessage();\n                    // 加载卖家信誉评分\n                    this.loadSellerRating();\n                }\n                $('html,body').animate({\n                    scrollTop: 0\n                }, {duration: 500, easing: \"swing\"});\n            });\n        },\n        methods: {\n            getCategoryName(label) {\n                return this.categories[label] || '其他';\n            },\n            getTagType(label) {\n                const types = {\n                    '1': 'primary',\n                    '2': 'success',\n                    '3': 'warning',\n                    '4': 'info',\n                    '5': 'danger'\n                };\n                return types[label] || 'info';\n            },\n            getAllIdleMessage(){\n                this.$api.getAllIdleMessage({\n                    idleId:this.idleItemInfo.id\n                }).then(res=>{\n                    console.log('getAllIdleMessage',res.data);\n                    if(res.status_code===1){\n                        this.messageList=res.data;\n                    }\n                }).catch(()=>{\n                })\n            },\n            checkFavorite(){\n                this.$api.checkFavorite({\n                    idleId:this.idleItemInfo.id\n                }).then(res=>{\n                    if(!res.data){\n                        this.isFavorite=false;\n                    }else {\n                        this.favoriteId=res.data;\n                    }\n                })\n            },\n            getCookie(cname){\n                var name = cname + \"=\";\n                var ca = document.cookie.split(';');\n                for(var i=0; i<ca.length; i++)\n                {\n                    var c = ca[i].trim();\n                    if (c.indexOf(name)===0) return c.substring(name.length,c.length);\n                }\n                return \"\";\n            },\n            startChat(){\n                const userId = this.getCookie('shUserId');\n                if(!userId){\n                    this.$message.error(\"请先登录后再发起私聊\");\n                    this.$router.push('/login');\n                    return;\n                }\n                if(userId == this.idleItemInfo.userId){\n                    this.$message.info(\"这是您自己发布的闲置哦\");\n                    return;\n                }\n                this.$router.push({\n                    path:'/chat',\n                    query:{\n                        targetUserId:this.idleItemInfo.userId,\n                        idleId:this.idleItemInfo.id\n                    }\n                });\n            },\n            replyMessage(index){\n                $('html,body').animate({\n                    scrollTop: $(\"#replyMessageLocation\").offset().top-100\n                }, {duration: 500, easing: \"swing\"});\n                this.isReply=true;\n                this.replyData.toUserNickname=this.messageList[index].fromU.nickname;\n                this.replyData.toMessage=this.messageList[index].content.substring(0,10)+(this.messageList[index].content.length>10?'...':'');\n                this.toUser=this.messageList[index].userId;\n                this.toMessage=this.messageList[index].id;\n            },\n            changeStatus(idle,status){\n                this.$api.updateIdleItem({\n                    id:idle.id,\n                    idleStatus:status\n                }).then(res=>{\n                    console.log(res);\n                    if(res.status_code===1){\n                        this.idleItemInfo.idleStatus=status;\n                        this.$message({\n                            message: status === 1 ? '商品已重新上架' : '商品已下架',\n                            type: 'success'\n                        });\n                    }else {\n                        this.$message.error(res.msg)\n                    }\n                });\n            },\n            buyButton(idleItemInfo){\n                this.$api.addOrder({\n                    idleId:idleItemInfo.id,\n                    orderPrice:idleItemInfo.idlePrice,\n                }).then(res=>{\n                    console.log(res);\n                    if(res.status_code===1){\n                        this.$router.push({path: '/order', query: {id: res.data.id}});\n                    }else {\n                        this.$message.error(res.msg)\n                    }\n                }).catch(e=>{\n\n                })\n            },\n            loadMembershipStatus() {\n                this.$api.getMembershipStatus().then(res => {\n                    if (res.status_code === 1) {\n                        this.membershipStatus = res.data;\n                    }\n                }).catch(() => {\n                    // 静默失败\n                });\n            },\n            handlePinItem() {\n                if (!this.canPin) {\n                    this.$message.warning('您还不是会员，无法使用置顶功能！');\n                    this.$router.push('/membership');\n                    return;\n                }\n\n                if (this.idleItemInfo.isPinned) {\n                    // 取消置顶（这里需要后端支持取消置顶的接口）\n                    this.$message.info('取消置顶功能开发中，置顶将在到期后自动取消');\n                    return;\n                }\n\n                // 置顶商品\n                this.$confirm('置顶商品可以让您的商品在列表中优先显示，是否确认置顶？', '确认置顶', {\n                    confirmButtonText: '确认',\n                    cancelButtonText: '取消',\n                    type: 'info'\n                }).then(() => {\n                    // 默认置顶7天\n                    this.$api.pinItem({\n                        idleItemId: this.idleItemInfo.id,\n                        durationDays: 7\n                    }).then(res => {\n                        if (res.status_code === 1) {\n                            this.$message.success('置顶成功！');\n                            // 刷新商品信息\n                            this.$api.getIdleItem({\n                                id: this.idleItemInfo.id\n                            }).then(refreshRes => {\n                                if (refreshRes.data) {\n                                    refreshRes.data.pictureList = JSON.parse(refreshRes.data.pictureList);\n                                    this.idleItemInfo = refreshRes.data;\n                                }\n                            });\n                            // 刷新会员状态\n                            this.loadMembershipStatus();\n                        } else {\n                            this.$message.error(res.msg || '置顶失败');\n                        }\n                    }).catch(() => {\n                        this.$message.error('网络错误，请稍后重试');\n                    });\n                }).catch(() => {});\n            },\n            favoriteButton(idleItemInfo){\n                if(this.isFavorite){\n                    this.$api.deleteFavorite({\n                        id: this.favoriteId\n                    }).then(res=>{\n                        console.log(res);\n                        if(res.status_code===1){\n                            this.$message({\n                                message: '已取消购物车！',\n                                type: 'success'\n                            });\n                            this.isFavorite=false;\n                        }else {\n                            this.$message.error(res.msg)\n                        }\n                    }).catch(e=>{\n                    })\n                }else {\n                    this.$api.addFavorite({\n                        idleId:idleItemInfo.id\n                    }).then(res=>{\n                        console.log(res);\n                        if(res.status_code===1){\n                            this.$message({\n                                message: '已加入购物车！',\n                                type: 'success'\n                            });\n                            this.isFavorite=true;\n                            this.favoriteId=res.data;\n                        }else {\n                            this.$message.error(res.msg)\n                        }\n                    }).catch(e=>{\n                    })\n                }\n            },\n            cancelReply(){\n                this.isReply=false;\n                this.toUser=this.idleItemInfo.userId;\n                this.toMessage=null;\n                this.replyData.toUserNickname='';\n                this.replyData.toMessage='';\n            },\n            sendMessage(){\n                let content=this.messageContent.trim();\n                if(this.toUser==null){\n                    this.toUser=this.idleItemInfo.userId;\n                }\n                if(content){\n                    let contentList=content.split(/\\r?\\n/);\n                    let contenHtml=contentList[0];\n                    for(let i=1;i<contentList.length;i++){\n                        contenHtml+='<br>'+contentList[i];\n                    }\n                    this.$api.sendMessage({\n                        idleId:this.idleItemInfo.id,\n                        content:contenHtml,\n                        toUser:this.toUser,\n                        toMessage:this.toMessage\n                    }).then(res=>{\n                        if(res.status_code===1){\n                            this.$message({\n                                message: '留言成功！',\n                                type: 'success'\n                            });\n                            this.messageContent='';\n                            this.cancelReply();\n                            this.getAllIdleMessage();\n                        }else {\n                            this.$message.error(\"留言失败！\"+res.msg);\n                        }\n                    }).catch(()=>{\n                        this.$message.error(\"留言失败！\");\n                    });\n\n                }else{\n                    this.$message.error(\"留言为空！\");\n                }\n            },\n            loadSellerRating() {\n                if (!this.idleItemInfo.userId) {\n                    return;\n                }\n                this.$api.getSellerStats({\n                    sellerId: this.idleItemInfo.userId\n                }).then(res => {\n                    if (res.status_code === 1 && res.data) {\n                        // 确保评分是数字类型，保留一位小数\n                        const avgRating = parseFloat(res.data.averageRating || 0);\n                        this.sellerRatingStats = {\n                            averageRating: avgRating > 0 ? avgRating : 0,\n                            ratingCount: res.data.ratingCount || 0\n                        };\n                    } else {\n                        this.sellerRatingStats = null;\n                    }\n                }).catch(() => {\n                    this.sellerRatingStats = null;\n                });\n            }\n        },\n    }\n</script>\n\n<style scoped>\n    .idle-details-container {\n        min-height: 85vh;\n        padding: 20px 0;\n    }\n\n    /* 商品卡片样式 */\n    .product-card, .message-card {\n        margin-bottom: 30px;\n        border-radius: 8px;\n        overflow: hidden;\n    }\n    \n    /* 用户信息与价格区域 */\n    .details-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 10px 0;\n        flex-wrap: wrap;\n    }\n\n    .details-header-user-info {\n        display: flex;\n        align-items: center;\n    }\n\n    .user-avatar {\n        box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);\n        border: 2px solid #fff;\n    }\n\n    .user-info-text {\n        margin-left: 15px;\n    }\n\n    .details-header-user-info-nickname {\n        font-weight: 600;\n        font-size: 18px;\n        margin-bottom: 10px;\n        color: #303133;\n    }\n\n    .details-header-user-info-time {\n        font-size: 14px;\n        color: #909399;\n        display: flex;\n        align-items: center;\n        margin-top: 8px;\n    }\n\n    .details-header-user-info-time i {\n        margin-right: 5px;\n    }\n\n    .details-header-user-info-rating {\n        margin-top: 8px;\n        display: flex;\n        align-items: center;\n        font-size: 14px;\n    }\n\n    .rating-count {\n        margin-left: 8px;\n        color: #909399;\n        font-size: 13px;\n    }\n\n    .no-rating {\n        color: #c0c4cc;\n        font-size: 13px;\n    }\n\n    .details-header-buy {\n        display: flex;\n        flex-direction: column;\n        align-items: flex-end;\n    }\n\n    .owner-controls {\n        align-items: center;\n    }\n\n    .product-price {\n        font-size: 24px;\n        font-weight: 700;\n        color: #f56c6c;\n        margin-bottom: 15px;\n    }\n\n    .price-symbol {\n        font-size: 16px;\n        font-weight: normal;\n        margin-right: 2px;\n    }\n\n    .product-status {\n        color: #f56c6c;\n        font-size: 16px;\n        margin-bottom: 15px;\n        display: flex;\n        align-items: center;\n    }\n\n    .product-status i {\n        margin-right: 5px;\n    }\n\n    .action-buttons {\n        display: flex;\n        gap: 10px;\n    }\n\n    /* 商品详情区域 */\n    .details-info {\n        padding: 20px 0;\n    }\n\n    .details-info-title {\n        display: flex;\n        align-items: center;\n        margin-bottom: 15px;\n    }\n\n    .product-name {\n        font-size: 24px;\n        font-weight: 600;\n        color: #303133;\n        margin-right: 10px;\n    }\n\n    .product-tag {\n        margin-left: 10px;\n    }\n    \n    .pin-tag {\n        margin-left: 10px;\n        background: #ffc107;\n        color: #fff;\n        border: none;\n    }\n    \n    .pin-tag i {\n        margin-right: 4px;\n    }\n\n    .product-location {\n        font-size: 14px;\n        color: #606266;\n        margin-bottom: 20px;\n        display: flex;\n        align-items: center;\n    }\n\n    .product-location i {\n        margin-right: 5px;\n        color: #e6a23c;\n    }\n\n    .details-info-main {\n        font-size: 16px;\n        color: #606266;\n        line-height: 1.8;\n        background-color: #f8f9fa;\n        padding: 20px;\n        border-radius: 4px;\n        margin-bottom: 20px;\n    }\n\n    /* 商品图片区域 */\n    .details-picture {\n        margin: 10px 0 30px;\n    }\n\n    .image-carousel {\n        margin: 0 auto;\n    }\n\n    .carousel-image {\n        height: 100%;\n        width: 100%;\n    }\n\n    .no-images {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        background-color: #f5f7fa;\n        height: 300px;\n        color: #909399;\n        border-radius: 4px;\n    }\n\n    .no-images i {\n        font-size: 50px;\n        margin-bottom: 10px;\n    }\n    \n    /* 留言板样式 */\n    .message-header {\n        display: flex;\n        align-items: center;\n        font-size: 18px;\n        font-weight: 600;\n    }\n\n    .message-badge {\n        margin-left: 10px;\n    }\n\n    .message-send {\n        margin-bottom: 30px;\n    }\n\n    .reply-info {\n        margin-bottom: 10px;\n    }\n\n    .message-input {\n        margin-bottom: 10px;\n    }\n\n    .message-send-button {\n        display: flex;\n        justify-content: flex-end;\n    }\n\n    /* 留言列表样式 */\n    .message-list {\n        padding: 10px 0;\n    }\n\n    .no-messages {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        height: 150px;\n        color: #909399;\n    }\n\n    .no-messages i {\n        font-size: 40px;\n        margin-bottom: 10px;\n    }\n\n    .message-item-card {\n        margin-bottom: 10px;\n    }\n\n    .message-container-list {\n        display: flex;\n        justify-content: space-between;\n        align-items: flex-start;\n    }\n\n    .message-container-list-left {\n        display: flex;\n        flex: 1;\n    }\n\n    .message-avatar {\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n        border: 2px solid #fff;\n    }\n\n    .message-container-list-text {\n        margin-left: 15px;\n        flex: 1;\n    }\n\n    .message-nickname {\n        font-weight: 600;\n        font-size: 16px;\n        color: #303133;\n        margin-bottom: 8px;\n    }\n\n    .reply-to {\n        font-size: 14px;\n        font-weight: normal;\n        color: #606266;\n    }\n\n    .quoted-message {\n        color: #909399;\n        font-style: italic;\n    }\n\n    .message-content {\n        font-size: 15px;\n        color: #606266;\n        margin-bottom: 10px;\n        line-height: 1.6;\n        word-break: break-word;\n    }\n\n    .message-container-list-right {\n        min-width: 60px;\n        display: flex;\n        justify-content: flex-end;\n        margin-left: 15px;\n    }\n\n    /* 响应式调整 */\n    @media (max-width: 768px) {\n        .details-header {\n            flex-direction: column;\n            align-items: flex-start;\n        }\n\n        .details-header-buy {\n            margin-top: 20px;\n            align-items: flex-start;\n            width: 100%;\n        }\n\n        .action-buttons {\n            flex-wrap: wrap;\n            margin-top: 10px;\n        }\n\n        .message-container-list {\n            flex-direction: column;\n        }\n\n        .message-container-list-right {\n            margin-top: 10px;\n            margin-left: 0;\n            align-self: flex-end;\n        }\n    }\n</style>\n</style>"]}]}