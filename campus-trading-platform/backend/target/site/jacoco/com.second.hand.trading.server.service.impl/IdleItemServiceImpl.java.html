<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IdleItemServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">server</a> &gt; <a href="index.source.html" class="el_package">com.second.hand.trading.server.service.impl</a> &gt; <span class="el_source">IdleItemServiceImpl.java</span></div><h1>IdleItemServiceImpl.java</h1><pre class="source lang-java linenums">package com.second.hand.trading.server.service.impl;

import com.second.hand.trading.server.dao.IdleItemDao;
import com.second.hand.trading.server.dao.IdleItemPinDao;
import com.second.hand.trading.server.dao.UserDao;
import com.second.hand.trading.server.entity.IdleItemModel;
import com.second.hand.trading.server.entity.UserModel;
import com.second.hand.trading.server.service.IdleItemService;
import com.second.hand.trading.server.dto.PageVo;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Service
<span class="fc" id="L20">public class IdleItemServiceImpl implements IdleItemService {</span>

    @Resource
    private IdleItemDao idleItemDao;

    @Resource
    private UserDao userDao;

    @Resource
    private com.second.hand.trading.server.utils.RedisUtil redisUtil;
    
    @Resource
    private com.second.hand.trading.server.service.CacheService cacheService;

    @Resource
    private IdleItemPinDao idleItemPinDao;

    /**
     * 发布闲置
     * @param idleItemModel
     * @return
     */
    public boolean addIdleItem(IdleItemModel idleItemModel) {
        // 如果没有设置库存，默认为1
<span class="nc bnc" id="L44" title="All 4 branches missed.">        if (idleItemModel.getStock() == null || idleItemModel.getStock() &lt;= 0) {</span>
<span class="nc" id="L45">            idleItemModel.setStock(1);</span>
        }
<span class="nc bnc" id="L47" title="All 2 branches missed.">        return idleItemDao.insert(idleItemModel) == 1;</span>
    }

    /**
     * 查询闲置信息，同时查出发布者的信息
     * @param id
     * @return
     */
    public IdleItemModel getIdleItem(Long id) {
        // 使用缓存服务
<span class="nc" id="L57">        IdleItemModel idleItemModel = cacheService.getProductDetail(id, () -&gt; {</span>
<span class="nc" id="L58">            IdleItemModel item = idleItemDao.selectByPrimaryKey(id);</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">            if(item != null){</span>
<span class="nc" id="L60">                item.setUser(userDao.selectByPrimaryKey(item.getUserId()));</span>
                // 检查是否正在置顶
<span class="nc" id="L62">                com.second.hand.trading.server.entity.IdleItemPinModel pin = </span>
<span class="nc" id="L63">                    idleItemPinDao.selectActivePinByItemId(id, new Date());</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">                item.setIsPinned(pin != null);</span>
            }
<span class="nc" id="L66">            return item;</span>
        });
        
        // 增加浏览量（计数器）
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (idleItemModel != null) {</span>
<span class="nc" id="L71">            redisUtil.increment(&quot;product:view:&quot; + id);</span>
        }
        
<span class="nc" id="L74">        return idleItemModel;</span>
    }

    /**
     * 查询用户发布的所有闲置
     * user_id建索引
     * @param userId
     * @return
     */
    public List&lt;IdleItemModel&gt; getAllIdelItem(Long userId) {
<span class="nc" id="L84">        return idleItemDao.getAllIdleItem(userId);</span>
    }

    /**
     * 搜索，分页
     * 同时查出闲置发布者的信息
     * @param findValue
     * @param page
     * @param nums
     * @return
     */
    public PageVo&lt;IdleItemModel&gt; findIdleItem(String findValue, int page, int nums) {
        // 使用缓存服务
<span class="nc" id="L97">        return cacheService.getProductList(findValue, page, nums, () -&gt; {</span>
<span class="nc" id="L98">            List&lt;IdleItemModel&gt; list=idleItemDao.findIdleItem(findValue, (page - 1) * nums, nums);</span>

<span class="nc bnc" id="L100" title="All 2 branches missed.">            for (IdleItemModel i:list) {</span>
<span class="nc" id="L101">                System.out.println(i.getIdleName() + ' ' + i.getIdleStatus() + '\n');</span>
<span class="nc" id="L102">            }</span>

<span class="nc bnc" id="L104" title="All 2 branches missed.">            if(list.size()&gt;0){</span>
<span class="nc" id="L105">                List&lt;Long&gt; idList=new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                for(IdleItemModel i:list){</span>
<span class="nc" id="L107">                    idList.add(i.getUserId());</span>
<span class="nc" id="L108">                }</span>
<span class="nc" id="L109">                List&lt;UserModel&gt; userList=userDao.findUserByList(idList);</span>
<span class="nc" id="L110">                Map&lt;Long,UserModel&gt; map=new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">                for(UserModel user:userList){</span>
<span class="nc" id="L112">                    map.put(user.getId(),user);</span>
<span class="nc" id="L113">                }</span>
<span class="nc" id="L114">                Date now = new Date();</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                for(IdleItemModel i:list){</span>
<span class="nc" id="L116">                    i.setUser(map.get(i.getUserId()));</span>
                    // 检查是否正在置顶
<span class="nc" id="L118">                    com.second.hand.trading.server.entity.IdleItemPinModel pin = </span>
<span class="nc" id="L119">                        idleItemPinDao.selectActivePinByItemId(i.getId(), now);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                    i.setIsPinned(pin != null);</span>
<span class="nc" id="L121">                }</span>
            }

<span class="nc" id="L124">            int count=idleItemDao.countIdleItem(findValue);</span>
<span class="nc" id="L125">            return new PageVo&lt;&gt;(list,count);</span>
        });
    }



    /**
     * 分类查询，分页
     * 同时查出闲置发布者的信息，代码结构与上面的类似，可封装优化，或改为join查询
     * @param idleLabel
     * @param page
     * @param nums
     * @return
     */
    public PageVo&lt;IdleItemModel&gt; findIdleItemByLable(int idleLabel, int page, int nums) {
        // 使用缓存服务
<span class="nc" id="L141">        return cacheService.getProductListByLabel(idleLabel, page, nums, () -&gt; {</span>
<span class="nc" id="L142">            List&lt;IdleItemModel&gt; list=idleItemDao.findIdleItemByLable(idleLabel, (page - 1) * nums, nums);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">            if(list.size()&gt;0){</span>
<span class="nc" id="L144">                List&lt;Long&gt; idList=new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">                for(IdleItemModel i:list){</span>
<span class="nc" id="L146">                    idList.add(i.getUserId());</span>
<span class="nc" id="L147">                }</span>
<span class="nc" id="L148">                List&lt;UserModel&gt; userList=userDao.findUserByList(idList);</span>
<span class="nc" id="L149">                Map&lt;Long,UserModel&gt; map=new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">                for(UserModel user:userList){</span>
<span class="nc" id="L151">                    map.put(user.getId(),user);</span>
<span class="nc" id="L152">                }</span>
<span class="nc" id="L153">                Date now = new Date();</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">                for(IdleItemModel i:list){</span>
<span class="nc" id="L155">                    i.setUser(map.get(i.getUserId()));</span>
                    // 检查是否正在置顶
<span class="nc" id="L157">                    com.second.hand.trading.server.entity.IdleItemPinModel pin = </span>
<span class="nc" id="L158">                        idleItemPinDao.selectActivePinByItemId(i.getId(), now);</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">                    i.setIsPinned(pin != null);</span>
<span class="nc" id="L160">                }</span>
            }
<span class="nc" id="L162">            int count=idleItemDao.countIdleItemByLable(idleLabel);</span>
<span class="nc" id="L163">            return new PageVo&lt;&gt;(list,count);</span>
        });
    }

    /**
     * 更新闲置信息
     * @param idleItemModel
     * @return
     */
    public boolean updateIdleItem(IdleItemModel idleItemModel){
<span class="nc bnc" id="L173" title="All 2 branches missed.">        return idleItemDao.updateByPrimaryKeySelective(idleItemModel)==1;</span>
    }

    public PageVo&lt;IdleItemModel&gt; adminGetIdleList(int status, int page, int nums) {
<span class="nc" id="L177">        List&lt;IdleItemModel&gt; list=idleItemDao.getIdleItemByStatus(status, (page - 1) * nums, nums);</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if(list.size()&gt;0){</span>
<span class="nc" id="L179">            List&lt;Long&gt; idList=new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">            for(IdleItemModel i:list){</span>
<span class="nc" id="L181">                idList.add(i.getUserId());</span>
<span class="nc" id="L182">            }</span>
<span class="nc" id="L183">            List&lt;UserModel&gt; userList=userDao.findUserByList(idList);</span>
<span class="nc" id="L184">            Map&lt;Long,UserModel&gt; map=new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            for(UserModel user:userList){</span>
<span class="nc" id="L186">                map.put(user.getId(),user);</span>
<span class="nc" id="L187">            }</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">            for(IdleItemModel i:list){</span>
<span class="nc" id="L189">                i.setUser(map.get(i.getUserId()));</span>
<span class="nc" id="L190">            }</span>
        }
<span class="nc" id="L192">        int count=idleItemDao.countIdleItemByStatus(status);</span>
<span class="nc" id="L193">        return new PageVo&lt;&gt;(list,count);</span>
    }



    // 根据不同的状态查找闲置物品
    @Override
    public PageVo&lt;IdleItemModel&gt; findIdleItem1(String findValue, int status, int page, int nums) {

<span class="nc" id="L202">        List&lt;IdleItemModel&gt; list=idleItemDao.findIdleItem1(findValue, status, (page - 1) * nums, nums);</span>

<span class="nc bnc" id="L204" title="All 2 branches missed.">        if(list.size()&gt;0){</span>
<span class="nc" id="L205">            List&lt;Long&gt; idList=new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">            for(IdleItemModel i:list){</span>
<span class="nc" id="L207">                idList.add(i.getUserId());</span>
<span class="nc" id="L208">            }</span>
<span class="nc" id="L209">            List&lt;UserModel&gt; userList=userDao.findUserByList(idList);</span>
<span class="nc" id="L210">            Map&lt;Long,UserModel&gt; map=new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">            for(UserModel user:userList){</span>
<span class="nc" id="L212">                map.put(user.getId(),user);</span>
<span class="nc" id="L213">            }</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">            for(IdleItemModel i:list){</span>
<span class="nc" id="L215">                i.setUser(map.get(i.getUserId()));</span>
<span class="nc" id="L216">            }</span>
        }
<span class="nc" id="L218">        int count=idleItemDao.countIdleItem(findValue);</span>

//        System.out.println(&quot;------------------------------------下架的--------------------------&quot;);
//        for (IdleItemModel i:list) {
//
//            System.out.println(i.getIdleName());
//            System.out.println(i.getIdleStatus());
//            System.out.println(i.getIdlePlace());
//            System.out.println(i.getReleaseTime());
//            System.out.println(i.getPictureList());
//            System.out.println(i.getIdlePrice());
//            System.out.println(i.getIdleLabel());
//
//        }

<span class="nc" id="L233">        return new PageVo&lt;&gt;(list,count);</span>

    }

    /**
     * 获取各个商品分类的统计数据
     * @return 包含分类名称和对应数量的列表
     */
    @Override
    public List&lt;Map&lt;String, Object&gt;&gt; getCategoryStatistics() {
<span class="nc" id="L243">        List&lt;Map&lt;String, Object&gt;&gt; result = new ArrayList&lt;&gt;();</span>

        // 获取所有分类的统计数据
<span class="nc" id="L246">        List&lt;Map&lt;String, Object&gt;&gt; rawData = idleItemDao.countItemsByCategory();</span>

        // 处理分类编号和名称的映射
<span class="nc" id="L249">        Map&lt;Integer, String&gt; categoryNames = new HashMap&lt;&gt;();</span>
<span class="nc" id="L250">        categoryNames.put(1, &quot;电子产品&quot;);</span>
<span class="nc" id="L251">        categoryNames.put(2, &quot;衣物饰品&quot;);</span>
<span class="nc" id="L252">        categoryNames.put(3, &quot;生活用品&quot;);</span>
<span class="nc" id="L253">        categoryNames.put(4, &quot;运动器材&quot;);</span>
<span class="nc" id="L254">        categoryNames.put(5, &quot;图书音像&quot;);</span>
<span class="nc" id="L255">        categoryNames.put(6, &quot;其他&quot;);</span>

        // 处理结果
<span class="nc bnc" id="L258" title="All 2 branches missed.">        for (Map&lt;String, Object&gt; item : rawData) {</span>
<span class="nc" id="L259">            Integer categoryId = (Integer) item.get(&quot;category&quot;);</span>
<span class="nc" id="L260">            item.put(&quot;categoryName&quot;, categoryNames.getOrDefault(categoryId, &quot;未知分类&quot;));</span>
<span class="nc" id="L261">            result.add(item);</span>
<span class="nc" id="L262">        }</span>

<span class="nc" id="L264">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>