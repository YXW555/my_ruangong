{"remainingRequest":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\babel-loader\\lib\\index.js!D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\src\\utils\\mapUtil.js","dependencies":[{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\src\\utils\\mapUtil.js","mtime":1767419352745},{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1678197338000},{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\babel-loader\\lib\\index.js","mtime":1678197338000}],"contextDependencies":[],"result":["import \"core-js/modules/es7.object.get-own-property-descriptors\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.object.keys\";\nimport _defineProperty from \"D:/Git/my_ruangong/campus-trading-platform/frontend/node_modules/@babel/runtime/helpers/esm/defineProperty\";\nimport \"regenerator-runtime/runtime\";\nimport \"core-js/modules/es6.function.name\";\nimport \"core-js/modules/es6.regexp.search\";\nimport \"core-js/modules/es6.regexp.match\";\nimport _asyncToGenerator from \"D:/Git/my_ruangong/campus-trading-platform/frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\n/**\r\n * 地图工具类\r\n * 封装高德地图相关功能\r\n */\n// 地图API加载状态\nvar mapApiLoaded = false;\nvar mapApiLoading = false;\n/**\r\n * 动态加载高德地图API\r\n * @returns {Promise} 返回Promise，加载完成后resolve\r\n */\n\nexport function loadAmapApi() {\n  return new Promise(function (resolve, reject) {\n    // 如果已经加载，直接resolve\n    if (window.AMap) {\n      mapApiLoaded = true;\n      resolve();\n      return;\n    } // 如果正在加载，等待加载完成\n\n\n    if (mapApiLoading) {\n      var checkInterval = setInterval(function () {\n        if (window.AMap) {\n          clearInterval(checkInterval);\n          mapApiLoaded = true;\n          resolve();\n        }\n      }, 100);\n      return;\n    } // 开始加载\n\n\n    mapApiLoading = true; // 从环境变量获取API Key，如果没有则使用默认值\n\n    var apiKey = process.env.VUE_APP_AMAP_KEY || 'YOUR_AMAP_KEY';\n    console.log('读取到的API Key:', apiKey ? apiKey.substring(0, 8) + '...' : '未配置');\n\n    if (apiKey === 'YOUR_AMAP_KEY' || !apiKey) {\n      console.warn('高德地图API Key未配置，请在.env文件中设置VUE_APP_AMAP_KEY');\n      console.warn('当前环境变量值:', process.env.VUE_APP_AMAP_KEY);\n      reject(new Error('高德地图API Key未配置，请在frontend目录下创建.env文件并设置VUE_APP_AMAP_KEY'));\n      return;\n    } // 创建script标签\n\n\n    var script = document.createElement('script');\n    script.type = 'text/javascript';\n    script.src = \"https://webapi.amap.com/maps?v=2.0&key=\".concat(apiKey, \"&plugin=AMap.Geocoder,AMap.Driving,AMap.PlaceSearch\");\n    script.async = true;\n\n    script.onload = function () {\n      mapApiLoaded = true;\n      mapApiLoading = false;\n      console.log('高德地图API加载成功');\n      resolve();\n    };\n\n    script.onerror = function () {\n      mapApiLoading = false;\n      console.error('高德地图API加载失败');\n      reject(new Error('高德地图API加载失败，请检查网络连接和API Key'));\n    }; // 添加到head\n\n\n    document.head.appendChild(script);\n  });\n}\n/**\r\n * 初始化地图\r\n * @param {String} containerId 地图容器ID\r\n * @param {Object} options 地图配置选项\r\n * @returns {Promise<AMap.Map>} 返回Promise，resolve包含地图实例\r\n */\n\nexport function initMap(_x) {\n  return _initMap.apply(this, arguments);\n}\n/**\r\n * 地址解析（Geocoding）\r\n * @param {String} address 地址文本\r\n * @returns {Promise} 返回Promise，resolve包含{lng, lat, address}\r\n */\n\nfunction _initMap() {\n  _initMap = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee(containerId) {\n    var options,\n        defaultOptions,\n        _args = arguments;\n    return regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            options = _args.length > 1 && _args[1] !== undefined ? _args[1] : {};\n            _context.next = 3;\n            return loadAmapApi();\n\n          case 3:\n            if (window.AMap) {\n              _context.next = 5;\n              break;\n            }\n\n            throw new Error('高德地图API未加载，请检查API Key配置');\n\n          case 5:\n            defaultOptions = _objectSpread({\n              zoom: 13,\n              center: [116.397428, 39.90923],\n              // 默认中心点（北京）\n              viewMode: '3D'\n            }, options);\n            return _context.abrupt(\"return\", new AMap.Map(containerId, defaultOptions));\n\n          case 7:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n  return _initMap.apply(this, arguments);\n}\n\nexport function geocodeAddress(address) {\n  return new Promise(function (resolve, reject) {\n    if (!window.AMap) {\n      reject(new Error('高德地图API未加载'));\n      return;\n    }\n\n    if (!address || !address.trim()) {\n      reject(new Error('地址不能为空'));\n      return;\n    } // 清理地址，去除多余空格\n\n\n    var cleanAddress = address.trim(); // 如果地址不包含城市信息，尝试添加常见城市（可以根据实际情况调整）\n\n    var searchAddress = cleanAddress; // 如果地址看起来不完整（比如只有学校名称），尝试添加\"大学\"或\"学院\"等关键词\n    // 或者使用POI搜索\n\n    var geocoder = new AMap.Geocoder({\n      city: '全国',\n      // 全国范围搜索\n      timeout: 10000 // 10秒超时\n\n    });\n    console.log('开始解析地址:', cleanAddress);\n    geocoder.getLocation(cleanAddress, function (status, result) {\n      console.log('地址解析结果:', status, result);\n\n      if (status === 'complete' && result.geocodes && result.geocodes.length > 0) {\n        var location = result.geocodes[0].location;\n        var formattedAddress = result.geocodes[0].formattedAddress || cleanAddress;\n        console.log('地址解析成功:', {\n          original: cleanAddress,\n          formatted: formattedAddress,\n          location: [location.lng, location.lat]\n        });\n        resolve({\n          lng: location.lng,\n          lat: location.lat,\n          address: cleanAddress,\n          formattedAddress: formattedAddress\n        });\n      } else {\n        // 如果地理编码失败，尝试使用POI搜索\n        console.warn('地理编码失败，尝试POI搜索:', cleanAddress);\n        searchByPOI(cleanAddress).then(resolve).catch(function () {\n          console.error('地址解析失败:', cleanAddress, '状态:', status);\n          reject(new Error(\"\\u5730\\u5740\\u89E3\\u6790\\u5931\\u8D25: \\\"\".concat(cleanAddress, \"\\\"\\u3002\\u8BF7\\u786E\\u4FDD\\u5730\\u5740\\u5305\\u542B\\u57CE\\u5E02\\u548C\\u8BE6\\u7EC6\\u4F4D\\u7F6E\\uFF0C\\u4F8B\\u5982\\uFF1A\\\"\\u5317\\u4EAC\\u5E02\\u6E05\\u534E\\u5927\\u5B66\\\"\\u6216\\\"\\u4E0A\\u6D77\\u5E02\\u590D\\u65E6\\u5927\\u5B66\\\"\")));\n        });\n      }\n    });\n  });\n}\n/**\r\n * 使用POI搜索地址（当地理编码失败时使用）\r\n * @param {String} keyword 搜索关键词\r\n * @returns {Promise} 返回Promise，resolve包含{lng, lat, address}\r\n */\n\nfunction searchByPOI(keyword) {\n  return new Promise(function (resolve, reject) {\n    if (!window.AMap) {\n      reject(new Error('高德地图API未加载'));\n      return;\n    } // 尝试提取学校名称（去除宿舍等后缀）\n\n\n    var searchKeyword = keyword; // 如果包含\"宿舍\"、\"校区\"等关键词，尝试提取学校名称部分\n\n    var schoolPatterns = [/^(.+?)(?:校区|宿舍|东区|西区|南区|北区|.*?宿舍)/, // 匹配\"学校名称+校区/宿舍\"\n    /^(.+?大学)/, // 匹配\"XX大学\"\n    /^(.+?学院)/, // 匹配\"XX学院\"\n    /^(.+?学校)/ // 匹配\"XX学校\"\n    ];\n\n    for (var _i = 0, _schoolPatterns = schoolPatterns; _i < _schoolPatterns.length; _i++) {\n      var pattern = _schoolPatterns[_i];\n      var match = keyword.match(pattern);\n\n      if (match && match[1]) {\n        searchKeyword = match[1].trim();\n        console.log('提取学校名称:', searchKeyword, '从:', keyword);\n        break;\n      }\n    }\n\n    var placeSearch = new AMap.PlaceSearch({\n      city: '全国',\n      citylimit: false,\n      type: '高等院校|科教文化服务' // 优先搜索学校\n\n    }); // 先尝试搜索提取的学校名称\n\n    placeSearch.search(searchKeyword, function (status, result) {\n      if (status === 'complete' && result.poiList && result.poiList.pois && result.poiList.pois.length > 0) {\n        var poi = result.poiList.pois[0];\n        var location = poi.location;\n        console.log('POI搜索成功:', {\n          keyword: keyword,\n          searchKeyword: searchKeyword,\n          name: poi.name,\n          address: poi.address,\n          location: [location.lng, location.lat]\n        });\n        resolve({\n          lng: location.lng,\n          lat: location.lat,\n          address: keyword,\n          formattedAddress: poi.address || poi.name\n        });\n      } else {\n        // 如果提取的学校名称搜索失败，尝试用原始关键词搜索\n        if (searchKeyword !== keyword) {\n          console.log('学校名称搜索失败，尝试原始关键词:', keyword);\n          placeSearch.search(keyword, function (status2, result2) {\n            if (status2 === 'complete' && result2.poiList && result2.poiList.pois && result2.poiList.pois.length > 0) {\n              var _poi = result2.poiList.pois[0];\n              var _location = _poi.location;\n              resolve({\n                lng: _location.lng,\n                lat: _location.lat,\n                address: keyword,\n                formattedAddress: _poi.address || _poi.name\n              });\n            } else {\n              reject(new Error('POI搜索失败: ' + keyword));\n            }\n          });\n        } else {\n          reject(new Error('POI搜索失败: ' + keyword));\n        }\n      }\n    });\n  });\n}\n/**\r\n * 添加地图标记\r\n * @param {AMap.Map} map 地图实例\r\n * @param {Object} location 位置对象 {lng, lat, address}\r\n * @param {String} title 标记标题\r\n * @param {String} type 标记类型 'seller' | 'buyer'\r\n */\n\n\nexport function addMarker(map, location, title) {\n  var type = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 'default';\n\n  if (!map || !location) {\n    console.warn('addMarker: 参数无效', {\n      map: map,\n      location: location\n    });\n    return null;\n  }\n\n  if (!location.lng || !location.lat) {\n    console.error('addMarker: 位置坐标无效', location);\n    return null;\n  }\n\n  console.log('添加标记:', {\n    title: title,\n    type: type,\n    location: [location.lng, location.lat]\n  });\n  var iconMap = {\n    seller: 'https://webapi.amap.com/theme/v1.3/markers/n/mid_red.png',\n    // 红色（卖家）\n    buyer: 'https://webapi.amap.com/theme/v1.3/markers/n/mid_blue.png',\n    // 蓝色（买家）\n    default: 'https://webapi.amap.com/theme/v1.3/markers/n/mid_green.png' // 绿色（默认）\n\n  };\n  var icon = iconMap[type] || iconMap.default;\n  var marker = new AMap.Marker({\n    position: [location.lng, location.lat],\n    title: title,\n    icon: new AMap.Icon({\n      image: icon,\n      size: new AMap.Size(32, 32),\n      imageSize: new AMap.Size(32, 32)\n    })\n  }); // 添加信息窗口\n\n  var infoWindow = new AMap.InfoWindow({\n    content: \"<div style=\\\"padding: 5px; min-width: 150px;\\\">\\n            <strong style=\\\"color: #409EFF;\\\">\".concat(title, \"</strong><br/>\\n            <span style=\\\"font-size: 12px; color: #666;\\\">\").concat(location.address || location.formattedAddress || '', \"</span>\\n        </div>\")\n  });\n  marker.on('click', function () {\n    infoWindow.open(map, marker.getPosition());\n  });\n  map.add(marker);\n  console.log('标记已添加到地图:', marker, '位置:', [location.lng, location.lat]);\n  return marker;\n}\n/**\r\n * 计算两点间距离\r\n * @param {Object} location1 位置1 {lng, lat}\r\n * @param {Object} location2 位置2 {lng, lat}\r\n * @returns {Number} 距离（米）\r\n */\n\nexport function calculateDistance(location1, location2) {\n  if (!window.AMap || !location1 || !location2) {\n    return null;\n  }\n\n  return AMap.GeometryUtil.distance([location1.lng, location1.lat], [location2.lng, location2.lat]);\n}\n/**\r\n * 格式化距离文本\r\n * @param {Number} distance 距离（米）\r\n * @returns {String} 格式化后的距离文本\r\n */\n\nexport function formatDistance(distance) {\n  if (distance === null || distance === undefined) {\n    return '计算中...';\n  }\n\n  if (distance < 1000) {\n    return \"\\u7EA6 \".concat(Math.round(distance), \" \\u7C73\");\n  } else {\n    return \"\\u7EA6 \".concat((distance / 1000).toFixed(2), \" \\u516C\\u91CC\");\n  }\n}\n/**\r\n * 更新地图视野，包含所有标记点\r\n * @param {AMap.Map} map 地图实例\r\n * @param {Array} locations 位置数组 [{lng, lat}, ...]\r\n */\n\nexport function fitMapView(map, locations) {\n  if (!map || !locations || locations.length === 0) {\n    console.warn('fitMapView: 参数无效', {\n      map: map,\n      locations: locations\n    });\n    return;\n  } // 过滤无效坐标\n\n\n  var points = locations.map(function (loc) {\n    if (!loc || typeof loc.lng !== 'number' || typeof loc.lat !== 'number') {\n      console.error('fitMapView: 位置坐标无效', loc);\n      return null;\n    }\n\n    return [loc.lng, loc.lat];\n  }).filter(function (p) {\n    return p !== null;\n  });\n\n  if (points.length === 0) {\n    console.error('fitMapView: 没有有效的坐标点');\n    return;\n  }\n\n  console.log('调整地图视野，包含点:', points);\n\n  try {\n    if (points.length === 1) {\n      // 只有一个点，直接设置中心点和缩放\n      map.setCenter(points[0]);\n      map.setZoom(15);\n      console.log('地图视野调整成功（单点）:', points[0]);\n    } else {\n      // 多个点，使用setFitView\n      // 高德地图的setFitView需要传入坐标数组，而不是Marker数组\n      map.setFitView(points, false, [50, 50, 50, 50]);\n      console.log('地图视野调整成功（多点）:', points);\n    }\n  } catch (e) {\n    console.error('调整地图视野失败:', e); // 如果setFitView失败，至少设置中心点\n\n    if (points.length > 0) {\n      map.setCenter(points[0]);\n      map.setZoom(15);\n      console.log('使用备用方法设置地图中心:', points[0]);\n    }\n  }\n}\n/**\r\n * 打开导航\r\n * @param {Object} location 目标位置 {lng, lat, address}\r\n * @param {String} mode 导航模式 'car' | 'walk' | 'bus'\r\n */\n\nexport function openNavigation(location) {\n  var mode = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'car';\n\n  if (!location || !location.lng || !location.lat) {\n    throw new Error('位置信息不完整');\n  }\n\n  var toName = location.address || location.formattedAddress || '目的地';\n  var url = \"https://uri.amap.com/navigation?to=\".concat(location.lng, \",\").concat(location.lat, \"&toName=\").concat(encodeURIComponent(toName), \"&mode=\").concat(mode, \"&policy=1&src=mypage&callnative=1\");\n  window.open(url, '_blank');\n}",{"version":3,"sources":["D:/Git/my_ruangong/campus-trading-platform/frontend/src/utils/mapUtil.js"],"names":["mapApiLoaded","mapApiLoading","loadAmapApi","Promise","resolve","reject","window","AMap","checkInterval","setInterval","clearInterval","apiKey","process","env","VUE_APP_AMAP_KEY","console","log","substring","warn","Error","script","document","createElement","type","src","async","onload","onerror","error","head","appendChild","initMap","containerId","options","defaultOptions","zoom","center","viewMode","Map","geocodeAddress","address","trim","cleanAddress","searchAddress","geocoder","Geocoder","city","timeout","getLocation","status","result","geocodes","length","location","formattedAddress","original","formatted","lng","lat","searchByPOI","then","catch","keyword","searchKeyword","schoolPatterns","pattern","match","placeSearch","PlaceSearch","citylimit","search","poiList","pois","poi","name","status2","result2","addMarker","map","title","iconMap","seller","buyer","default","icon","marker","Marker","position","Icon","image","size","Size","imageSize","infoWindow","InfoWindow","content","on","open","getPosition","add","calculateDistance","location1","location2","GeometryUtil","distance","formatDistance","undefined","Math","round","toFixed","fitMapView","locations","points","loc","filter","p","setCenter","setZoom","setFitView","e","openNavigation","mode","toName","url","encodeURIComponent"],"mappings":"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","sourcesContent":["/**\r\n * 地图工具类\r\n * 封装高德地图相关功能\r\n */\r\n\r\n// 地图API加载状态\r\nlet mapApiLoaded = false;\r\nlet mapApiLoading = false;\r\n\r\n/**\r\n * 动态加载高德地图API\r\n * @returns {Promise} 返回Promise，加载完成后resolve\r\n */\r\nexport function loadAmapApi() {\r\n    return new Promise((resolve, reject) => {\r\n        // 如果已经加载，直接resolve\r\n        if (window.AMap) {\r\n            mapApiLoaded = true;\r\n            resolve();\r\n            return;\r\n        }\r\n        \r\n        // 如果正在加载，等待加载完成\r\n        if (mapApiLoading) {\r\n            const checkInterval = setInterval(() => {\r\n                if (window.AMap) {\r\n                    clearInterval(checkInterval);\r\n                    mapApiLoaded = true;\r\n                    resolve();\r\n                }\r\n            }, 100);\r\n            return;\r\n        }\r\n        \r\n        // 开始加载\r\n        mapApiLoading = true;\r\n        \r\n        // 从环境变量获取API Key，如果没有则使用默认值\r\n        const apiKey = process.env.VUE_APP_AMAP_KEY || 'YOUR_AMAP_KEY';\r\n        \r\n        console.log('读取到的API Key:', apiKey ? apiKey.substring(0, 8) + '...' : '未配置');\r\n        \r\n        if (apiKey === 'YOUR_AMAP_KEY' || !apiKey) {\r\n            console.warn('高德地图API Key未配置，请在.env文件中设置VUE_APP_AMAP_KEY');\r\n            console.warn('当前环境变量值:', process.env.VUE_APP_AMAP_KEY);\r\n            reject(new Error('高德地图API Key未配置，请在frontend目录下创建.env文件并设置VUE_APP_AMAP_KEY'));\r\n            return;\r\n        }\r\n        \r\n        // 创建script标签\r\n        const script = document.createElement('script');\r\n        script.type = 'text/javascript';\r\n        script.src = `https://webapi.amap.com/maps?v=2.0&key=${apiKey}&plugin=AMap.Geocoder,AMap.Driving,AMap.PlaceSearch`;\r\n        script.async = true;\r\n        \r\n        script.onload = () => {\r\n            mapApiLoaded = true;\r\n            mapApiLoading = false;\r\n            console.log('高德地图API加载成功');\r\n            resolve();\r\n        };\r\n        \r\n        script.onerror = () => {\r\n            mapApiLoading = false;\r\n            console.error('高德地图API加载失败');\r\n            reject(new Error('高德地图API加载失败，请检查网络连接和API Key'));\r\n        };\r\n        \r\n        // 添加到head\r\n        document.head.appendChild(script);\r\n    });\r\n}\r\n\r\n/**\r\n * 初始化地图\r\n * @param {String} containerId 地图容器ID\r\n * @param {Object} options 地图配置选项\r\n * @returns {Promise<AMap.Map>} 返回Promise，resolve包含地图实例\r\n */\r\nexport async function initMap(containerId, options = {}) {\r\n    // 确保API已加载\r\n    await loadAmapApi();\r\n    \r\n    if (!window.AMap) {\r\n        throw new Error('高德地图API未加载，请检查API Key配置');\r\n    }\r\n    \r\n    const defaultOptions = {\r\n        zoom: 13,\r\n        center: [116.397428, 39.90923], // 默认中心点（北京）\r\n        viewMode: '3D',\r\n        ...options\r\n    };\r\n    \r\n    return new AMap.Map(containerId, defaultOptions);\r\n}\r\n\r\n/**\r\n * 地址解析（Geocoding）\r\n * @param {String} address 地址文本\r\n * @returns {Promise} 返回Promise，resolve包含{lng, lat, address}\r\n */\r\nexport function geocodeAddress(address) {\r\n    return new Promise((resolve, reject) => {\r\n        if (!window.AMap) {\r\n            reject(new Error('高德地图API未加载'));\r\n            return;\r\n        }\r\n        \r\n        if (!address || !address.trim()) {\r\n            reject(new Error('地址不能为空'));\r\n            return;\r\n        }\r\n        \r\n        // 清理地址，去除多余空格\r\n        const cleanAddress = address.trim();\r\n        \r\n        // 如果地址不包含城市信息，尝试添加常见城市（可以根据实际情况调整）\r\n        let searchAddress = cleanAddress;\r\n        \r\n        // 如果地址看起来不完整（比如只有学校名称），尝试添加\"大学\"或\"学院\"等关键词\r\n        // 或者使用POI搜索\r\n        const geocoder = new AMap.Geocoder({\r\n            city: '全国', // 全国范围搜索\r\n            timeout: 10000 // 10秒超时\r\n        });\r\n        \r\n        console.log('开始解析地址:', cleanAddress);\r\n        \r\n        geocoder.getLocation(cleanAddress, (status, result) => {\r\n            console.log('地址解析结果:', status, result);\r\n            \r\n            if (status === 'complete' && result.geocodes && result.geocodes.length > 0) {\r\n                const location = result.geocodes[0].location;\r\n                const formattedAddress = result.geocodes[0].formattedAddress || cleanAddress;\r\n                \r\n                console.log('地址解析成功:', {\r\n                    original: cleanAddress,\r\n                    formatted: formattedAddress,\r\n                    location: [location.lng, location.lat]\r\n                });\r\n                \r\n                resolve({\r\n                    lng: location.lng,\r\n                    lat: location.lat,\r\n                    address: cleanAddress,\r\n                    formattedAddress: formattedAddress\r\n                });\r\n            } else {\r\n                // 如果地理编码失败，尝试使用POI搜索\r\n                console.warn('地理编码失败，尝试POI搜索:', cleanAddress);\r\n                searchByPOI(cleanAddress).then(resolve).catch(() => {\r\n                    console.error('地址解析失败:', cleanAddress, '状态:', status);\r\n                    reject(new Error(`地址解析失败: \"${cleanAddress}\"。请确保地址包含城市和详细位置，例如：\"北京市清华大学\"或\"上海市复旦大学\"`));\r\n                });\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n/**\r\n * 使用POI搜索地址（当地理编码失败时使用）\r\n * @param {String} keyword 搜索关键词\r\n * @returns {Promise} 返回Promise，resolve包含{lng, lat, address}\r\n */\r\nfunction searchByPOI(keyword) {\r\n    return new Promise((resolve, reject) => {\r\n        if (!window.AMap) {\r\n            reject(new Error('高德地图API未加载'));\r\n            return;\r\n        }\r\n        \r\n        // 尝试提取学校名称（去除宿舍等后缀）\r\n        let searchKeyword = keyword;\r\n        \r\n        // 如果包含\"宿舍\"、\"校区\"等关键词，尝试提取学校名称部分\r\n        const schoolPatterns = [\r\n            /^(.+?)(?:校区|宿舍|东区|西区|南区|北区|.*?宿舍)/,  // 匹配\"学校名称+校区/宿舍\"\r\n            /^(.+?大学)/,  // 匹配\"XX大学\"\r\n            /^(.+?学院)/,  // 匹配\"XX学院\"\r\n            /^(.+?学校)/,  // 匹配\"XX学校\"\r\n        ];\r\n        \r\n        for (const pattern of schoolPatterns) {\r\n            const match = keyword.match(pattern);\r\n            if (match && match[1]) {\r\n                searchKeyword = match[1].trim();\r\n                console.log('提取学校名称:', searchKeyword, '从:', keyword);\r\n                break;\r\n            }\r\n        }\r\n        \r\n        const placeSearch = new AMap.PlaceSearch({\r\n            city: '全国',\r\n            citylimit: false,\r\n            type: '高等院校|科教文化服务' // 优先搜索学校\r\n        });\r\n        \r\n        // 先尝试搜索提取的学校名称\r\n        placeSearch.search(searchKeyword, (status, result) => {\r\n            if (status === 'complete' && result.poiList && result.poiList.pois && result.poiList.pois.length > 0) {\r\n                const poi = result.poiList.pois[0];\r\n                const location = poi.location;\r\n                \r\n                console.log('POI搜索成功:', {\r\n                    keyword: keyword,\r\n                    searchKeyword: searchKeyword,\r\n                    name: poi.name,\r\n                    address: poi.address,\r\n                    location: [location.lng, location.lat]\r\n                });\r\n                \r\n                resolve({\r\n                    lng: location.lng,\r\n                    lat: location.lat,\r\n                    address: keyword,\r\n                    formattedAddress: poi.address || poi.name\r\n                });\r\n            } else {\r\n                // 如果提取的学校名称搜索失败，尝试用原始关键词搜索\r\n                if (searchKeyword !== keyword) {\r\n                    console.log('学校名称搜索失败，尝试原始关键词:', keyword);\r\n                    placeSearch.search(keyword, (status2, result2) => {\r\n                        if (status2 === 'complete' && result2.poiList && result2.poiList.pois && result2.poiList.pois.length > 0) {\r\n                            const poi = result2.poiList.pois[0];\r\n                            const location = poi.location;\r\n                            \r\n                            resolve({\r\n                                lng: location.lng,\r\n                                lat: location.lat,\r\n                                address: keyword,\r\n                                formattedAddress: poi.address || poi.name\r\n                            });\r\n                        } else {\r\n                            reject(new Error('POI搜索失败: ' + keyword));\r\n                        }\r\n                    });\r\n                } else {\r\n                    reject(new Error('POI搜索失败: ' + keyword));\r\n                }\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n/**\r\n * 添加地图标记\r\n * @param {AMap.Map} map 地图实例\r\n * @param {Object} location 位置对象 {lng, lat, address}\r\n * @param {String} title 标记标题\r\n * @param {String} type 标记类型 'seller' | 'buyer'\r\n */\r\nexport function addMarker(map, location, title, type = 'default') {\r\n    if (!map || !location) {\r\n        console.warn('addMarker: 参数无效', { map, location });\r\n        return null;\r\n    }\r\n    \r\n    if (!location.lng || !location.lat) {\r\n        console.error('addMarker: 位置坐标无效', location);\r\n        return null;\r\n    }\r\n    \r\n    console.log('添加标记:', { title, type, location: [location.lng, location.lat] });\r\n    \r\n    const iconMap = {\r\n        seller: 'https://webapi.amap.com/theme/v1.3/markers/n/mid_red.png', // 红色（卖家）\r\n        buyer: 'https://webapi.amap.com/theme/v1.3/markers/n/mid_blue.png', // 蓝色（买家）\r\n        default: 'https://webapi.amap.com/theme/v1.3/markers/n/mid_green.png' // 绿色（默认）\r\n    };\r\n    \r\n    const icon = iconMap[type] || iconMap.default;\r\n    \r\n    const marker = new AMap.Marker({\r\n        position: [location.lng, location.lat],\r\n        title: title,\r\n        icon: new AMap.Icon({\r\n            image: icon,\r\n            size: new AMap.Size(32, 32),\r\n            imageSize: new AMap.Size(32, 32)\r\n        })\r\n    });\r\n    \r\n    // 添加信息窗口\r\n    const infoWindow = new AMap.InfoWindow({\r\n        content: `<div style=\"padding: 5px; min-width: 150px;\">\r\n            <strong style=\"color: #409EFF;\">${title}</strong><br/>\r\n            <span style=\"font-size: 12px; color: #666;\">${location.address || location.formattedAddress || ''}</span>\r\n        </div>`\r\n    });\r\n    \r\n    marker.on('click', () => {\r\n        infoWindow.open(map, marker.getPosition());\r\n    });\r\n    \r\n    map.add(marker);\r\n    console.log('标记已添加到地图:', marker, '位置:', [location.lng, location.lat]);\r\n    \r\n    return marker;\r\n}\r\n\r\n/**\r\n * 计算两点间距离\r\n * @param {Object} location1 位置1 {lng, lat}\r\n * @param {Object} location2 位置2 {lng, lat}\r\n * @returns {Number} 距离（米）\r\n */\r\nexport function calculateDistance(location1, location2) {\r\n    if (!window.AMap || !location1 || !location2) {\r\n        return null;\r\n    }\r\n    \r\n    return AMap.GeometryUtil.distance(\r\n        [location1.lng, location1.lat],\r\n        [location2.lng, location2.lat]\r\n    );\r\n}\r\n\r\n/**\r\n * 格式化距离文本\r\n * @param {Number} distance 距离（米）\r\n * @returns {String} 格式化后的距离文本\r\n */\r\nexport function formatDistance(distance) {\r\n    if (distance === null || distance === undefined) {\r\n        return '计算中...';\r\n    }\r\n    \r\n    if (distance < 1000) {\r\n        return `约 ${Math.round(distance)} 米`;\r\n    } else {\r\n        return `约 ${(distance / 1000).toFixed(2)} 公里`;\r\n    }\r\n}\r\n\r\n/**\r\n * 更新地图视野，包含所有标记点\r\n * @param {AMap.Map} map 地图实例\r\n * @param {Array} locations 位置数组 [{lng, lat}, ...]\r\n */\r\nexport function fitMapView(map, locations) {\r\n    if (!map || !locations || locations.length === 0) {\r\n        console.warn('fitMapView: 参数无效', { map, locations });\r\n        return;\r\n    }\r\n    \r\n    // 过滤无效坐标\r\n    const points = locations.map(loc => {\r\n        if (!loc || typeof loc.lng !== 'number' || typeof loc.lat !== 'number') {\r\n            console.error('fitMapView: 位置坐标无效', loc);\r\n            return null;\r\n        }\r\n        return [loc.lng, loc.lat];\r\n    }).filter(p => p !== null);\r\n    \r\n    if (points.length === 0) {\r\n        console.error('fitMapView: 没有有效的坐标点');\r\n        return;\r\n    }\r\n    \r\n    console.log('调整地图视野，包含点:', points);\r\n    \r\n    try {\r\n        if (points.length === 1) {\r\n            // 只有一个点，直接设置中心点和缩放\r\n            map.setCenter(points[0]);\r\n            map.setZoom(15);\r\n            console.log('地图视野调整成功（单点）:', points[0]);\r\n        } else {\r\n            // 多个点，使用setFitView\r\n            // 高德地图的setFitView需要传入坐标数组，而不是Marker数组\r\n            map.setFitView(points, false, [50, 50, 50, 50]);\r\n            console.log('地图视野调整成功（多点）:', points);\r\n        }\r\n    } catch (e) {\r\n        console.error('调整地图视野失败:', e);\r\n        // 如果setFitView失败，至少设置中心点\r\n        if (points.length > 0) {\r\n            map.setCenter(points[0]);\r\n            map.setZoom(15);\r\n            console.log('使用备用方法设置地图中心:', points[0]);\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * 打开导航\r\n * @param {Object} location 目标位置 {lng, lat, address}\r\n * @param {String} mode 导航模式 'car' | 'walk' | 'bus'\r\n */\r\nexport function openNavigation(location, mode = 'car') {\r\n    if (!location || !location.lng || !location.lat) {\r\n        throw new Error('位置信息不完整');\r\n    }\r\n    \r\n    const toName = location.address || location.formattedAddress || '目的地';\r\n    const url = `https://uri.amap.com/navigation?to=${location.lng},${location.lat}&toName=${encodeURIComponent(toName)}&mode=${mode}&policy=1&src=mypage&callnative=1`;\r\n    window.open(url, '_blank');\r\n}\r\n\r\n"]}]}