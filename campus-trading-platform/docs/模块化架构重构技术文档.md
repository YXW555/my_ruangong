# 校园二手交易平台 - 模块化架构重构技术文档

## 一、项目概述

### 1.1 项目背景
本项目是一个校园二手交易平台，采用Spring Boot + Vue.js技术栈。当前采用传统的分层架构（Controller-Service-DAO），所有功能集中在单一应用中。

### 1.2 重构目标
将现有的分层架构优化为**模块化的单体架构**，通过业务领域划分模块，提升代码的可维护性、可扩展性和团队协作效率。

### 1.3 重构原则
- **业务内聚**：按业务领域划分模块，相关功能聚合在一起
- **低耦合**：模块间通过接口交互，减少直接依赖
- **高内聚**：模块内部功能紧密相关
- **渐进式重构**：保持系统可运行，逐步迁移
- **向后兼容**：不破坏现有功能

## 二、当前架构分析

### 2.1 现有结构
```
com.second.hand.trading.server
├── controller/        # 16个控制器
├── service/           # 16个服务接口
├── service/impl/      # 16个服务实现
├── dao/               # 多个数据访问对象
├── entity/            # 多个实体类
├── dto/               # 数据传输对象
├── enums/             # 枚举类
├── config/            # 配置类
├── exception/         # 异常处理
└── utils/             # 工具类
```

### 2.2 存在的问题
1. **职责不清**：所有功能混在一起，难以快速定位代码
2. **耦合度高**：模块间直接依赖，修改影响范围大
3. **可维护性差**：随着功能增加，代码组织混乱
4. **团队协作困难**：多人开发容易产生冲突
5. **扩展性受限**：新增功能时难以确定放置位置

## 三、模块化设计方案

### 3.1 模块划分原则

#### 3.1.1 按业务领域划分
每个模块代表一个完整的业务领域，包含该领域的所有功能：
- Controller（接口层）
- Service（业务逻辑层）
- Dao（数据访问层）
- Entity（实体层）

#### 3.1.2 模块命名规范
- 模块名使用小写字母，多个单词用单数形式
- 包名：`com.second.hand.trading.server.{module}`
- 示例：`com.second.hand.trading.server.user`

### 3.2 模块详细设计

#### 模块1：user（用户模块）
**职责**：用户注册、登录、信息管理

**包含内容**：
- `UserController` - 用户相关接口
- `UserService` / `UserServiceImpl` - 用户业务逻辑
- `UserDao` - 用户数据访问
- `UserModel` - 用户实体
- `UserDao.xml` - MyBatis映射文件

**依赖关系**：
- 依赖：common模块（ResultVo, ErrorMsg等）
- 被依赖：product, order, membership等模块

---

#### 模块2：product（商品模块）
**职责**：商品发布、查询、管理、置顶

**包含内容**：
- `IdleItemController` - 商品相关接口
- `IdleItemService` / `IdleItemServiceImpl` - 商品业务逻辑
- `IdleItemDao`, `IdleItemPinDao` - 商品数据访问
- `IdleItemModel`, `IdleItemPinModel` - 商品实体
- `IdleItemDao.xml`, `IdleItemPinDao.xml` - MyBatis映射文件

**依赖关系**：
- 依赖：user模块（商品发布者信息）、common模块
- 被依赖：order, favorite模块

---

#### 模块3：order（订单模块）
**职责**：订单创建、管理、地址管理

**包含内容**：
- `OrderController` - 订单相关接口
- `OrderAddressController` - 订单地址接口
- `OrderService` / `OrderServiceImpl` - 订单业务逻辑
- `OrderAddressService` / `OrderAddressServiceImpl` - 订单地址业务逻辑
- `OrderDao`, `OrderAddressDao` - 数据访问
- `OrderModel`, `OrderAddressModel` - 实体
- 对应的Mapper XML文件

**依赖关系**：
- 依赖：user模块、product模块、common模块
- 被依赖：payment, rating模块

---

#### 模块4：payment（支付模块）
**职责**：支付处理、支付回调

**包含内容**：
- `AliPayController` - 支付宝支付接口
- `AliPayConfig` - 支付宝配置（如果仅支付使用）
- 支付相关的Service（如需要）

**依赖关系**：
- 依赖：order模块、common模块
- 被依赖：无

---

#### 模块5：membership（会员模块）
**职责**：会员购买、会员权益管理

**包含内容**：
- `MembershipController` - 会员相关接口
- `MembershipService` / `MembershipServiceImpl` - 会员业务逻辑
- `MembershipOrderDao` - 会员订单数据访问
- `MembershipOrderModel` - 会员订单实体
- `MembershipOrderDao.xml` - MyBatis映射文件

**依赖关系**：
- 依赖：user模块、common模块
- 被依赖：product模块（置顶功能需要会员权限）

---

#### 模块6：merchant（商家模块）
**职责**：商家认证、商家管理

**包含内容**：
- `MerchantController` - 商家管理接口
- `MerchantApplicationController` - 商家认证申请接口
- `MerchantService` / `MerchantServiceImpl` - 商家业务逻辑
- `MerchantApplicationService` / `MerchantApplicationServiceImpl` - 认证业务逻辑
- `MerchantApplicationDao` - 数据访问
- `MerchantApplicationModel` - 实体
- 对应的Mapper XML文件

**依赖关系**：
- 依赖：user模块、product模块、common模块
- 被依赖：无

---

#### 模块7：message（消息模块）
**职责**：站内消息、私聊功能

**包含内容**：
- `MessageController` - 站内消息接口
- `ChatMessageController` - 私聊消息接口
- `MessageService` / `MessageServiceImpl` - 站内消息业务逻辑
- `ChatMessageService` / `ChatMessageServiceImpl` - 私聊业务逻辑
- `MessageDao`, `ChatMessageDao` - 数据访问
- `MessageModel`, `ChatMessageModel` - 实体
- 对应的Mapper XML文件

**依赖关系**：
- 依赖：user模块、product模块、common模块
- 被依赖：无

---

#### 模块8：rating（评价模块）
**职责**：商品评价、卖家信誉

**包含内容**：
- `RatingController` - 评价相关接口
- `RatingService` / `RatingServiceImpl` - 评价业务逻辑
- `RatingDao` - 数据访问
- `RatingModel` - 实体
- `RatingDao.xml` - MyBatis映射文件

**依赖关系**：
- 依赖：user模块、order模块、common模块
- 被依赖：product模块（显示卖家信誉）

---

#### 模块9：favorite（收藏模块）
**职责**：商品收藏、购物车

**包含内容**：
- `FavoriteController` - 收藏相关接口
- `FavoriteService` / `FavoriteServiceImpl` - 收藏业务逻辑
- `FavoriteDao` - 数据访问
- `FavoriteModel` - 实体
- `FavoriteDao.xml` - MyBatis映射文件

**依赖关系**：
- 依赖：user模块、product模块、common模块
- 被依赖：无

---

#### 模块10：address（地址模块）
**职责**：收货地址管理

**包含内容**：
- `AddressController` - 地址相关接口
- `AddressService` / `AddressServiceImpl` - 地址业务逻辑
- `AddressDao` - 数据访问
- `AddressModel` - 实体
- `AddressDao.xml` - MyBatis映射文件

**依赖关系**：
- 依赖：user模块、common模块
- 被依赖：order模块

---

#### 模块11：admin（后台管理模块）
**职责**：管理员功能、数据统计

**包含内容**：
- `AdminController` - 管理员登录、管理接口
- `StatisticsController` - 数据统计接口
- `AdminService` / `AdminServiceImpl` - 管理员业务逻辑
- `AdminDao` - 数据访问
- `AdminModel` - 实体
- 对应的Mapper XML文件

**依赖关系**：
- 依赖：所有业务模块（用于统计）、common模块
- 被依赖：无

---

#### 模块12：file（文件管理模块）
**职责**：文件上传、图片管理

**包含内容**：
- `FileController` - 文件上传接口
- `FileService` / `FileServiceImpl` - 文件业务逻辑

**依赖关系**：
- 依赖：common模块
- 被依赖：product, user等模块（上传图片、头像）

---

#### 模块13：common（公共模块）
**职责**：公共配置、工具类、异常处理

**包含内容**：
- `config/` - 全局配置（CorsConfig, WebMvcConfig等）
- `dto/` - 数据传输对象（ResultVo, PageVo）
- `enums/` - 枚举类（ErrorMsg）
- `exception/` - 异常处理（ParamException, GlobalExceptionHandler）
- `utils/` - 工具类（IdFactoryUtil, OrderTask等）
- `interceptor/` - 拦截器（LogCostInterceptor）

**依赖关系**：
- 依赖：无
- 被依赖：所有业务模块

### 3.3 模块依赖关系图

```
                    common (公共模块)
                      ↑
        ┌─────────────┼─────────────┐
        │             │             │
     user          product        admin
        ↑             ↑             ↑
        │             │             │
    ┌───┴───┬─────────┴───┬─────────┴───┐
    │       │             │             │
 order  membership    merchant      message
    ↑       ↑             │             │
    │       │             │             │
payment  product      (独立)        (独立)
    │       │
    │       │
 rating  favorite
```

## 四、重构实施步骤

### 4.1 阶段一：准备工作（1-2天）

#### 4.1.1 创建新目录结构
```bash
# 在 backend/src/main/java/com/second/hand/trading/server/ 下创建模块目录
mkdir -p user/{controller,service,dao,entity}
mkdir -p product/{controller,service,dao,entity}
mkdir -p order/{controller,service,dao,entity}
mkdir -p payment/{controller,config}
mkdir -p membership/{controller,service,dao,entity}
mkdir -p merchant/{controller,service,dao,entity}
mkdir -p message/{controller,service,dao,entity}
mkdir -p rating/{controller,service,dao,entity}
mkdir -p favorite/{controller,service,dao,entity}
mkdir -p address/{controller,service,dao,entity}
mkdir -p admin/{controller,service,dao,entity}
mkdir -p file/{controller,service}
mkdir -p common/{config,dto,enums,exception,utils,interceptor}
```

#### 4.1.2 备份现有代码
```bash
git checkout -b refactoring/modular-architecture
git commit -m "备份：重构前的代码状态"
```

### 4.2 阶段二：迁移公共模块（1天）

#### 4.2.1 迁移common模块
1. 移动 `dto/` → `common/dto/`
2. 移动 `enums/` → `common/enums/`
3. 移动 `exception/` → `common/exception/`
4. 移动 `utils/` → `common/utils/`
5. 移动 `config/` → `common/config/`
6. 移动 `interceptor/` → `common/interceptor/`

#### 4.2.2 更新包名和导入
- 更新所有文件的package声明
- 更新所有导入common模块的import语句

### 4.3 阶段三：迁移业务模块（3-5天）

#### 4.3.1 按模块顺序迁移
建议迁移顺序：
1. **user模块**（基础模块，其他模块依赖）
2. **product模块**
3. **address模块**
4. **favorite模块**
5. **order模块**
6. **payment模块**
7. **membership模块**
8. **merchant模块**
9. **message模块**
10. **rating模块**
11. **admin模块**
12. **file模块**

#### 4.3.2 每个模块的迁移步骤
以user模块为例：

1. **创建目录结构**
   ```
   user/
   ├── controller/
   ├── service/
   ├── dao/
   └── entity/
   ```

2. **移动文件**
   - `controller/UserController.java` → `user/controller/UserController.java`
   - `service/UserService.java` → `user/service/UserService.java`
   - `service/impl/UserServiceImpl.java` → `user/service/UserServiceImpl.java`
   - `dao/UserDao.java` → `user/dao/UserDao.java`
   - `entity/UserModel.java` → `user/entity/UserModel.java`

3. **更新包名**
   ```java
   // 旧包名
   package com.second.hand.trading.server.controller;
   
   // 新包名
   package com.second.hand.trading.server.user.controller;
   ```

4. **更新导入语句**
   ```java
   // 旧导入
   import com.second.hand.trading.server.service.UserService;
   import com.second.hand.trading.server.dto.ResultVo;
   
   // 新导入
   import com.second.hand.trading.server.user.service.UserService;
   import com.second.hand.trading.server.common.dto.ResultVo;
   ```

5. **更新Mapper XML**
   ```xml
   <!-- 旧namespace -->
   <mapper namespace="com.second.hand.trading.server.dao.UserDao">
   
   <!-- 新namespace -->
   <mapper namespace="com.second.hand.trading.server.user.dao.UserDao">
   ```

6. **更新Mapper XML路径**
   - 移动 `mapper/UserDao.xml` → `mapper/user/UserDao.xml`
   - 在 `application.yml` 中更新MyBatis配置：
     ```yaml
     mybatis:
       mapper-locations: classpath:mapper/**/*.xml
     ```

7. **测试编译**
   - 运行 `mvn clean compile`
   - 修复所有编译错误

### 4.4 阶段四：更新配置和启动类（1天）

#### 4.4.1 更新MyBatis配置
```yaml
# application.yml
mybatis:
  type-aliases-package: com.second.hand.trading.server.*.entity
  mapper-locations: classpath:mapper/**/*.xml
```

#### 4.4.2 更新组件扫描
```java
@SpringBootApplication(scanBasePackages = "com.second.hand.trading.server")
public class ServerApplication {
    // ...
}
```

#### 4.4.3 更新工具类引用
检查并更新所有工具类的导入路径。

### 4.5 阶段五：测试和验证（2-3天）

#### 4.5.1 单元测试
- 测试每个模块的基本功能
- 确保模块间调用正常

#### 4.5.2 集成测试
- 测试完整的业务流程
- 验证API接口正常

#### 4.5.3 回归测试
- 测试所有现有功能
- 确保没有功能回退

## 五、重构后的目录结构

```
backend/src/main/java/com/second/hand/trading/server/
├── ServerApplication.java          # 启动类
│
├── common/                          # 公共模块
│   ├── config/
│   │   ├── CorsConfig.java
│   │   └── WebMvcConfig.java
│   ├── dto/
│   │   ├── ResultVo.java
│   │   └── PageVo.java
│   ├── enums/
│   │   └── ErrorMsg.java
│   ├── exception/
│   │   ├── ParamException.java
│   │   └── GlobalExceptionHandler.java
│   ├── utils/
│   │   ├── IdFactoryUtil.java
│   │   ├── OrderTask.java
│   │   └── OrderTaskHandler.java
│   └── interceptor/
│       └── LogCostInterceptor.java
│
├── user/                            # 用户模块
│   ├── controller/
│   │   └── UserController.java
│   ├── service/
│   │   ├── UserService.java
│   │   └── UserServiceImpl.java
│   ├── dao/
│   │   └── UserDao.java
│   └── entity/
│       └── UserModel.java
│
├── product/                         # 商品模块
│   ├── controller/
│   │   └── IdleItemController.java
│   ├── service/
│   │   ├── IdleItemService.java
│   │   └── IdleItemServiceImpl.java
│   ├── dao/
│   │   ├── IdleItemDao.java
│   │   └── IdleItemPinDao.java
│   └── entity/
│       ├── IdleItemModel.java
│       └── IdleItemPinModel.java
│
├── order/                           # 订单模块
│   ├── controller/
│   │   ├── OrderController.java
│   │   └── OrderAddressController.java
│   ├── service/
│   │   ├── OrderService.java
│   │   ├── OrderServiceImpl.java
│   │   ├── OrderAddressService.java
│   │   └── OrderAddressServiceImpl.java
│   ├── dao/
│   │   ├── OrderDao.java
│   │   └── OrderAddressDao.java
│   └── entity/
│       ├── OrderModel.java
│       └── OrderAddressModel.java
│
├── payment/                         # 支付模块
│   ├── controller/
│   │   └── AliPayController.java
│   └── config/
│       └── AliPayConfig.java
│
├── membership/                      # 会员模块
│   ├── controller/
│   │   └── MembershipController.java
│   ├── service/
│   │   ├── MembershipService.java
│   │   └── MembershipServiceImpl.java
│   ├── dao/
│   │   └── MembershipOrderDao.java
│   └── entity/
│       └── MembershipOrderModel.java
│
├── merchant/                        # 商家模块
│   ├── controller/
│   │   ├── MerchantController.java
│   │   └── MerchantApplicationController.java
│   ├── service/
│   │   ├── MerchantService.java
│   │   ├── MerchantServiceImpl.java
│   │   ├── MerchantApplicationService.java
│   │   └── MerchantApplicationServiceImpl.java
│   ├── dao/
│   │   └── MerchantApplicationDao.java
│   └── entity/
│       └── MerchantApplicationModel.java
│
├── message/                         # 消息模块
│   ├── controller/
│   │   ├── MessageController.java
│   │   └── ChatMessageController.java
│   ├── service/
│   │   ├── MessageService.java
│   │   ├── MessageServiceImpl.java
│   │   ├── ChatMessageService.java
│   │   └── ChatMessageServiceImpl.java
│   ├── dao/
│   │   ├── MessageDao.java
│   │   └── ChatMessageDao.java
│   └── entity/
│       ├── MessageModel.java
│       └── ChatMessageModel.java
│
├── rating/                          # 评价模块
│   ├── controller/
│   │   └── RatingController.java
│   ├── service/
│   │   ├── RatingService.java
│   │   └── RatingServiceImpl.java
│   ├── dao/
│   │   └── RatingDao.java
│   └── entity/
│       └── RatingModel.java
│
├── favorite/                        # 收藏模块
│   ├── controller/
│   │   └── FavoriteController.java
│   ├── service/
│   │   ├── FavoriteService.java
│   │   └── FavoriteServiceImpl.java
│   ├── dao/
│   │   └── FavoriteDao.java
│   └── entity/
│       └── FavoriteModel.java
│
├── address/                         # 地址模块
│   ├── controller/
│   │   └── AddressController.java
│   ├── service/
│   │   ├── AddressService.java
│   │   └── AddressServiceImpl.java
│   ├── dao/
│   │   └── AddressDao.java
│   └── entity/
│       └── AddressModel.java
│
├── admin/                           # 后台管理模块
│   ├── controller/
│   │   ├── AdminController.java
│   │   └── StatisticsController.java
│   ├── service/
│   │   ├── AdminService.java
│   │   └── AdminServiceImpl.java
│   ├── dao/
│   │   └── AdminDao.java
│   └── entity/
│       └── AdminModel.java
│
└── file/                            # 文件管理模块
    ├── controller/
    │   └── FileController.java
    └── service/
        ├── FileService.java
        └── FileServiceImpl.java
```

## 六、Mapper XML文件组织

### 6.1 新的目录结构
```
backend/src/main/resources/mapper/
├── user/
│   └── UserDao.xml
├── product/
│   ├── IdleItemDao.xml
│   └── IdleItemPinDao.xml
├── order/
│   ├── OrderDao.xml
│   └── OrderAddressDao.xml
├── membership/
│   └── MembershipOrderDao.xml
├── merchant/
│   └── MerchantApplicationDao.xml
├── message/
│   ├── MessageDao.xml
│   └── ChatMessageDao.xml
├── rating/
│   └── RatingDao.xml
├── favorite/
│   └── FavoriteDao.xml
├── address/
│   └── AddressDao.xml
└── admin/
    └── AdminDao.xml
```

### 6.2 更新MyBatis配置
```yaml
# application.yml
mybatis:
  type-aliases-package: com.second.hand.trading.server.*.entity
  mapper-locations: classpath:mapper/**/*.xml
```

## 七、重构收益

### 7.1 代码组织
- ✅ **清晰的模块边界**：每个模块职责明确
- ✅ **易于定位代码**：按业务领域快速找到相关代码
- ✅ **降低认知负担**：开发者只需关注相关模块

### 7.2 可维护性
- ✅ **模块独立**：修改某个模块不影响其他模块
- ✅ **易于测试**：可以针对单个模块进行测试
- ✅ **代码复用**：公共功能集中在common模块

### 7.3 团队协作
- ✅ **并行开发**：不同开发者可以负责不同模块
- ✅ **减少冲突**：模块化减少代码冲突
- ✅ **职责清晰**：模块负责人明确

### 7.4 扩展性
- ✅ **易于扩展**：新增功能时明确归属模块
- ✅ **技术选型**：未来可以为不同模块选择不同技术（如需要）
- ✅ **微服务准备**：为未来拆分为微服务打下基础

## 八、注意事项

### 8.1 重构风险
1. **编译错误**：包名变更可能导致大量编译错误
2. **运行时错误**：Mapper XML路径变更需要仔细检查
3. **功能回退**：确保重构后功能正常

### 8.2 最佳实践
1. **渐进式重构**：一个模块一个模块地迁移
2. **充分测试**：每个模块迁移后立即测试
3. **版本控制**：使用Git分支管理，便于回滚
4. **文档更新**：及时更新相关文档

### 8.3 后续优化
1. **接口抽象**：模块间通过接口交互，减少直接依赖
2. **事件驱动**：使用Spring Event实现模块间解耦
3. **API版本管理**：为接口添加版本控制
4. **监控和日志**：添加模块级别的监控和日志

## 九、时间估算

| 阶段 | 工作内容 | 预计时间 |
|------|---------|---------|
| 阶段一 | 准备工作 | 1-2天 |
| 阶段二 | 迁移公共模块 | 1天 |
| 阶段三 | 迁移业务模块 | 3-5天 |
| 阶段四 | 更新配置 | 1天 |
| 阶段五 | 测试验证 | 2-3天 |
| **总计** | | **8-12天** |

## 十、总结

本次重构将传统的分层架构优化为模块化的单体架构，通过业务领域划分模块，提升了代码的组织性和可维护性。重构后的架构保持了单体的简单性，同时具备了更好的扩展性，为未来的发展打下了良好的基础。

---

**文档版本**：v1.0  
**编写日期**：2024年  
**维护人员**：开发团队

