# 交易纠纷功能说明

## 一、删除订单功能说明

### 1. 删除订单的作用

**当前实现**：管理员可以删除订单，但**只有未支付或已取消的订单才能删除**。

**删除订单的限制**：
- ✅ **可以删除**：未支付的订单（`paymentStatus = 0`）
- ✅ **可以删除**：已取消的订单（`orderStatus = 4`）
- ❌ **不能删除**：已支付的订单（`paymentStatus = 1`）

**为什么已支付的订单不能删除？**
- 已支付的订单涉及资金，删除会导致数据丢失
- 如果订单有问题，应该通过**交易纠纷**功能处理，而不是直接删除
- 删除已支付订单可能导致财务对账问题

### 2. 删除订单的使用场景

**适用场景**：
1. **测试数据清理**：删除测试时创建的未支付订单
2. **异常订单清理**：删除因系统异常产生的无效订单
3. **用户误操作**：删除用户误创建的未支付订单

**不适用场景**：
- ❌ 已支付的订单有问题 → 应该使用**交易纠纷**功能
- ❌ 需要退款 → 应该使用**交易纠纷**功能处理退款

---

## 二、交易纠纷功能

### 1. 功能概述

交易纠纷功能允许用户在遇到交易问题时申请管理员介入处理。

### 2. 用户功能

#### 申请纠纷处理
- **接口**：`POST /dispute/apply`
- **权限**：需要登录
- **参数**：
  ```json
  {
    "orderId": 1,
    "disputeType": 1,  // 1-商品描述不符，2-商品质量问题，3-未收到货，4-退款问题，5-其他
    "disputeReason": "商品描述不符，实际颜色与描述不一致",
    "evidenceImages": "[\"http://example.com/image1.jpg\", \"http://example.com/image2.jpg\"]"
  }
  ```
- **限制**：每个订单只能有一个待处理的纠纷

#### 查看我的纠纷列表
- **接口**：`GET /dispute/my`
- **权限**：需要登录
- **返回**：当前用户申请的所有纠纷列表

#### 查看纠纷详情
- **接口**：`GET /dispute/info?id=1`
- **权限**：需要登录（只能查看自己申请的纠纷）

### 3. 管理员功能

#### 查看纠纷列表
- **接口**：`GET /dispute/admin/list?status=0&page=1&nums=8`
- **权限**：需要管理员登录
- **参数**：
  - `status`：纠纷状态（可选，0-待处理，1-处理中，2-已解决，3-已关闭）
  - `page`：页码
  - `nums`：每页数量
- **返回**：分页的纠纷列表

#### 处理纠纷
- **接口**：`POST /dispute/admin/handle`
- **权限**：需要管理员登录
- **参数**：
  - `id`：纠纷ID
  - `handleResult`：处理结果
    - `1`：退款给买家
    - `2`：驳回申请
    - `3`：要求退货退款
    - `4`：警告用户
    - `5`：其他
  - `handleDescription`：处理说明（可选）

### 4. 纠纷类型说明

| 类型 | 说明 | 示例 |
|------|------|------|
| 1 | 商品描述不符 | 商品颜色、尺寸、功能与描述不一致 |
| 2 | 商品质量问题 | 商品损坏、无法使用、是假货 |
| 3 | 未收到货 | 卖家未发货、物流问题、地址错误 |
| 4 | 退款问题 | 退款申请被拒、退款金额争议 |
| 5 | 其他 | 其他问题 |

### 5. 纠纷状态说明

| 状态 | 说明 |
|------|------|
| 0 | 待处理：用户已申请，等待管理员处理 |
| 1 | 处理中：管理员正在处理（暂未使用） |
| 2 | 已解决：管理员已处理完成 |
| 3 | 已关闭：纠纷已关闭（暂未使用） |

### 6. 处理结果说明

| 结果 | 说明 | 后续操作 |
|------|------|---------|
| 1 | 退款给买家 | 系统自动退款（模拟支付环境） |
| 2 | 驳回申请 | 订单继续正常流程 |
| 3 | 要求退货退款 | 需要买家退货，卖家确认后退款 |
| 4 | 警告用户 | 记录用户不良行为 |
| 5 | 其他 | 根据处理说明执行 |

---

## 三、数据库表结构

### sh_dispute 表

```sql
CREATE TABLE `sh_dispute` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '自增主键',
  `order_id` bigint NOT NULL COMMENT '订单ID',
  `applicant_id` bigint NOT NULL COMMENT '申请人ID（买家或卖家）',
  `dispute_type` tinyint NOT NULL COMMENT '纠纷类型：1-商品描述不符，2-商品质量问题，3-未收到货，4-退款问题，5-其他',
  `dispute_reason` varchar(512) NOT NULL COMMENT '纠纷原因描述',
  `evidence_images` varchar(1024) DEFAULT NULL COMMENT '证据图片（JSON格式）',
  `dispute_status` tinyint NOT NULL DEFAULT 0 COMMENT '纠纷状态：0-待处理，1-处理中，2-已解决，3-已关闭',
  `handle_result` tinyint DEFAULT NULL COMMENT '处理结果：1-退款给买家，2-驳回申请，3-要求退货退款，4-警告用户，5-其他',
  `handle_description` varchar(512) DEFAULT NULL COMMENT '处理说明',
  `handler_id` bigint DEFAULT NULL COMMENT '处理人ID（管理员ID）',
  `create_time` datetime NOT NULL COMMENT '创建时间',
  `handle_time` datetime DEFAULT NULL COMMENT '处理时间',
  PRIMARY KEY (`id`),
  INDEX `order_id_index`(`order_id`),
  INDEX `applicant_id_index`(`applicant_id`),
  INDEX `status_index`(`dispute_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='交易纠纷表';
```

---

## 四、使用流程

### 用户申请纠纷流程

1. 用户在订单详情页点击"申请纠纷处理"
2. 选择纠纷类型
3. 填写纠纷原因
4. 上传证据图片（可选）
5. 提交申请
6. 系统创建纠纷记录，状态为"待处理"
7. 管理员收到通知（如果有通知功能）

### 管理员处理纠纷流程

1. 管理员登录后台
2. 进入"交易纠纷管理"页面
3. 查看待处理的纠纷列表
4. 点击查看纠纷详情：
   - 查看订单信息
   - 查看商品信息
   - 查看用户描述和证据
5. 根据情况判定责任
6. 选择处理方式：
   - 退款给买家
   - 驳回申请
   - 要求退货退款
   - 警告用户
7. 填写处理说明
8. 提交处理结果
9. 系统更新纠纷状态为"已解决"
10. 如果选择退款，系统执行退款操作（模拟环境）

---

## 五、注意事项

### 1. 删除订单 vs 交易纠纷

- **删除订单**：只用于清理无效的未支付订单
- **交易纠纷**：用于处理已支付订单的问题

### 2. 退款处理

当前是模拟支付环境，退款操作只是更新订单状态，不涉及真实资金流转。

### 3. 权限控制

- 用户只能申请自己参与的订单的纠纷
- 管理员可以查看和处理所有纠纷

### 4. 重复申请限制

每个订单只能有一个待处理的纠纷，避免重复申请。

---

## 六、后续优化建议

1. **通知功能**：纠纷申请后通知管理员，处理完成后通知用户
2. **站内信功能**：管理员和用户可以通过站内信沟通
3. **自动判定**：根据订单状态、聊天记录等自动判定责任（高级功能）
4. **退款功能**：完善退款流程，包括部分退款、退货退款等
5. **纠纷统计**：统计纠纷类型、处理时长等数据

