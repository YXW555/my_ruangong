# 图片加载完整排查

## 完整排查步骤

### 第 1 步：检查图片文件是否存在

```bash
cd /opt/campus-trading-platform

# 检查上传目录
sudo docker compose exec backend ls -la /opt/upload

# 查看具体文件
sudo docker compose exec backend ls -la /opt/upload | head -20

# 检查文件大小（确认不是空文件）
sudo docker compose exec backend du -sh /opt/upload/*
```

### 第 2 步：检查数据库中的图片路径

```bash
# 查看数据库中的图片路径
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "USE second_hand_trading; SELECT id, idle_name, picture_list FROM sh_idle_item WHERE picture_list != '[]' LIMIT 5;" 2>&1

# 查看是否有 localhost 路径
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "USE second_hand_trading; SELECT id, picture_list FROM sh_idle_item WHERE picture_list LIKE '%localhost%' LIMIT 5;" 2>&1
```

### 第 3 步：测试后端图片接口

```bash
# 获取一个真实的图片文件名
IMAGE_NAME=$(sudo docker compose exec backend ls /opt/upload | head -1 | tr -d '\r\n')

# 测试后端图片接口（直接访问后端）
curl -I http://localhost:8080/image?imageName=$IMAGE_NAME 2>&1 | head -10

# 测试通过 Nginx 代理
curl -I http://localhost/api/image?imageName=$IMAGE_NAME 2>&1 | head -10

# 或者手动测试（替换为实际文件名）
curl -I http://localhost:8080/image?imageName=file17669247184001003bottle.tif 2>&1
curl -I http://localhost/api/image?imageName=file17669247184001003bottle.tif 2>&1
```

### 第 4 步：检查后端日志

```bash
# 查看后端日志（图片请求相关）
sudo docker compose logs backend | grep -i image | tail -20

# 查看所有错误
sudo docker compose logs backend | grep -i error | tail -20
```

### 第 5 步：检查 Nginx 配置

```bash
# 查看 Nginx 配置
sudo docker compose exec frontend cat /etc/nginx/conf.d/default.conf

# 测试 Nginx 配置
sudo docker compose exec frontend nginx -t
```

### 第 6 步：检查浏览器控制台

在浏览器中：
1. 打开开发者工具（F12）
2. 查看 Network 标签
3. 刷新页面
4. 找到图片请求，查看：
   - 请求 URL
   - 响应状态码
   - 响应内容

## 常见问题和解决方案

### 问题 1：图片文件不存在

**检查**：
```bash
sudo docker compose exec backend ls -la /opt/upload
```

**解决**：
- 如果目录为空，需要重新上传图片
- 检查文件权限

### 问题 2：路径格式错误

**检查**：
```bash
# 查看数据库中的路径格式
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "USE second_hand_trading; SELECT picture_list FROM sh_idle_item WHERE id = 7;" 2>&1
```

**可能的问题**：
- 路径是 JSON 数组格式：`["/api/image?imageName=xxx"]`
- 前端需要解析 JSON 数组

### 问题 3：Nginx 代理配置问题

**检查**：
```bash
sudo docker compose exec frontend cat /etc/nginx/conf.d/default.conf | grep -A 5 "location /api"
```

**应该包含**：
```nginx
location /api/ {
    proxy_pass http://backend:8080/;
    ...
}
```

### 问题 4：CORS 跨域问题

**检查后端日志**：
```bash
sudo docker compose logs backend | grep -i cors
```

## 完整诊断脚本

```bash
#!/bin/bash
cd /opt/campus-trading-platform

echo "=== 1. 检查图片文件 ==="
echo "上传目录内容："
sudo docker compose exec backend ls -la /opt/upload | head -10
echo ""

echo "=== 2. 检查数据库路径 ==="
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "USE second_hand_trading; SELECT id, LEFT(picture_list, 100) as path FROM sh_idle_item WHERE picture_list != '[]' LIMIT 3;" 2>&1
echo ""

echo "=== 3. 测试后端图片接口 ==="
IMAGE_NAME=$(sudo docker compose exec backend ls /opt/upload 2>/dev/null | head -1 | tr -d '\r\n')
if [ -n "$IMAGE_NAME" ]; then
    echo "测试图片: $IMAGE_NAME"
    echo "直接访问后端:"
    curl -I "http://localhost:8080/image?imageName=$IMAGE_NAME" 2>&1 | head -5
    echo ""
    echo "通过 Nginx 代理:"
    curl -I "http://localhost/api/image?imageName=$IMAGE_NAME" 2>&1 | head -5
else
    echo "没有找到图片文件"
fi
echo ""

echo "=== 4. 检查后端日志（最后20行）==="
sudo docker compose logs backend --tail=20 | grep -E "(image|Image|IMAGE|error|Error)" || echo "没有相关日志"
echo ""

echo "=== 5. 检查 Nginx 配置 ==="
sudo docker compose exec frontend cat /etc/nginx/conf.d/default.conf | grep -A 3 "location /api"
```

保存为 `check-images.sh`，然后执行：
```bash
chmod +x check-images.sh
./check-images.sh
```

