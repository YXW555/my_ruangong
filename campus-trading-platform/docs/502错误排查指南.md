# 502 错误排查指南

## 问题现象

访问服务器 IP 时出现 HTTP 502 错误，说明服务没有正常运行。

## 排查步骤

### 1. 检查容器状态

在服务器上执行：

```bash
# 连接服务器
ssh root@你的服务器IP

# 检查容器状态
cd /opt/campus-trading-platform
docker-compose ps
# 或者
docker ps -a
```

**预期结果**：所有容器应该是 `Up` 状态

**如果容器没有运行**：
```bash
# 查看容器日志
docker-compose logs
# 或者查看特定服务的日志
docker-compose logs backend
docker-compose logs frontend
docker-compose logs mysql
```

### 2. 常见问题及解决方案

#### 问题 1: 容器启动失败

**检查日志**：
```bash
docker-compose logs backend
docker-compose logs frontend
```

**常见原因**：
- 数据库连接失败
- Redis 连接失败
- 镜像不存在或拉取失败
- 端口冲突

#### 问题 2: 数据库未初始化

**检查**：
```bash
# 检查 MySQL 容器是否正常运行
docker-compose logs mysql

# 进入 MySQL 容器检查数据库
docker-compose exec mysql mysql -u trading_user -ptrading123456 -e "SHOW DATABASES;"
```

**如果数据库不存在**：
```bash
# 检查 init.sql 文件是否存在
ls -la /opt/campus-trading-platform/init.sql

# 如果不存在，需要创建或上传
# 手动初始化数据库（如果需要）
docker-compose exec mysql mysql -u root -proot123456 -e "CREATE DATABASE IF NOT EXISTS second_hand_trading;"
```

#### 问题 3: 后端服务启动失败

**检查后端日志**：
```bash
docker-compose logs backend
```

**常见错误**：
- 数据库连接超时：检查 MySQL 容器是否启动，网络是否连通
- Redis 连接失败：检查 Redis 容器是否启动
- 配置文件错误：检查环境变量是否正确

**解决方案**：
```bash
# 重启后端服务
docker-compose restart backend

# 查看实时日志
docker-compose logs -f backend
```

#### 问题 4: 前端无法连接后端

**检查前端日志**：
```bash
docker-compose logs frontend
```

**检查网络连通性**：
```bash
# 在 frontend 容器中测试连接后端
docker-compose exec frontend curl http://backend:8080
# 或者
docker-compose exec frontend wget -O- http://backend:8080
```

#### 问题 5: 端口冲突

**检查端口占用**：
```bash
# 检查端口是否被占用
sudo netstat -tulpn | grep 80
sudo netstat -tulpn | grep 8080

# 或者使用 ss 命令
sudo ss -tulpn | grep 80
sudo ss -tulpn | grep 8080
```

**如果端口被占用**：
```bash
# 停止占用端口的服务
# 或者修改 docker-compose.yml 中的端口映射
```

### 3. 完整排查脚本

在服务器上执行以下脚本进行全面检查：

```bash
#!/bin/bash
cd /opt/campus-trading-platform

echo "=== 检查容器状态 ==="
docker-compose ps

echo -e "\n=== 检查容器是否在运行 ==="
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

echo -e "\n=== 检查后端日志（最后50行）==="
docker-compose logs --tail=50 backend

echo -e "\n=== 检查前端日志（最后50行）==="
docker-compose logs --tail=50 frontend

echo -e "\n=== 检查 MySQL 日志（最后50行）==="
docker-compose logs --tail=50 mysql

echo -e "\n=== 检查网络 ==="
docker network ls
docker network inspect campus-trading-platform_trading-network 2>/dev/null || docker network inspect trading-network 2>/dev/null || echo "网络检查失败"

echo -e "\n=== 测试后端连接 ==="
curl -f http://localhost:8080 || echo "后端连接失败"

echo -e "\n=== 测试前端连接 ==="
curl -f http://localhost:80 || echo "前端连接失败"
```

保存为 `check-services.sh`，然后执行：
```bash
chmod +x check-services.sh
./check-services.sh
```

### 4. 重新部署

如果问题持续，尝试完全重新部署：

```bash
cd /opt/campus-trading-platform

# 停止所有容器
docker-compose down

# 清理未使用的资源
docker system prune -f

# 重新拉取镜像
export DOCKER_USERNAME=你的Docker用户名
docker-compose pull

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f
```

### 5. 检查环境变量

确保 `DOCKER_USERNAME` 环境变量已设置：

```bash
echo $DOCKER_USERNAME

# 如果没有设置，需要设置
export DOCKER_USERNAME=你的Docker用户名
# 或者在 ~/.bashrc 中添加
echo 'export DOCKER_USERNAME=你的Docker用户名' >> ~/.bashrc
source ~/.bashrc
```

### 6. 手动测试服务

```bash
# 测试后端 API
curl http://localhost:8080
# 或者
curl http://你的服务器IP:8080

# 测试前端
curl http://localhost:80
# 或者
curl http://你的服务器IP:80
```

## 快速修复命令

如果所有容器都没有运行，尝试：

```bash
cd /opt/campus-trading-platform
export DOCKER_USERNAME=你的Docker用户名
docker-compose down
docker-compose pull
docker-compose up -d
docker-compose ps
docker-compose logs -f
```

## 需要更多帮助？

如果以上步骤都无法解决问题，请提供：
1. `docker-compose ps` 的输出
2. `docker-compose logs` 的输出（特别是 backend 和 frontend）
3. 服务器上执行的错误信息

