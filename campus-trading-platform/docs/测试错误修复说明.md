# 测试错误修复说明

## 错误原因

### 1. 数据库表不存在
**错误信息**：`Table "SH_USER" not found`

**原因**：
- 测试使用 H2 内存数据库
- 但没有初始化数据库表结构
- 测试运行时找不到 `sh_user` 表

### 2. Controller 路径错误
**错误信息**：`Status expected:<200> but was:<404>`

**原因**：
- 测试中使用 `/user/signin`
- 实际 Controller 路径是 `/user/sign-in`

---

## 修复方案

### 1. 创建数据库初始化脚本

#### `schema.sql` - 表结构
```sql
-- 创建用户表
DROP TABLE IF EXISTS sh_user;
CREATE TABLE sh_user (
  id BIGINT NOT NULL AUTO_INCREMENT,
  account_number VARCHAR(16) NOT NULL,
  user_password VARCHAR(16) NOT NULL,
  nickname VARCHAR(32) NOT NULL,
  avatar VARCHAR(256) NOT NULL,
  sign_in_time TIMESTAMP NOT NULL,
  user_status TINYINT DEFAULT 0,
  user_role TINYINT NOT NULL DEFAULT 0,
  membership_type TINYINT NOT NULL DEFAULT 0,
  membership_expire_time TIMESTAMP NULL,
  PRIMARY KEY (id)
);

CREATE UNIQUE INDEX account_number ON sh_user(account_number);
```

#### `data.sql` - 测试数据
```sql
-- 插入测试用户数据
INSERT INTO sh_user (id, account_number, user_password, nickname, avatar, sign_in_time, user_status, user_role, membership_type, membership_expire_time) 
VALUES (1, '13800138000', '123456', '测试用户', 'https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png', CURRENT_TIMESTAMP, 0, 0, 0, NULL);
```

### 2. 配置自动执行 SQL 脚本

在 `application-test.properties` 中添加：
```properties
# H2 数据库配置（兼容 MySQL 语法）
spring.datasource.url=jdbc:h2:mem:testdb;MODE=MySQL;DATABASE_TO_LOWER=TRUE

# 自动执行 SQL 脚本
spring.datasource.initialization-mode=always
spring.datasource.schema=classpath:schema.sql
spring.datasource.data=classpath:data.sql
```

### 3. 修复 Controller 路径

将测试中的路径从 `/user/signin` 改为 `/user/sign-in`

---

## 文件位置

- `backend/src/test/resources/schema.sql` - 表结构脚本
- `backend/src/test/resources/data.sql` - 测试数据脚本
- `backend/src/test/resources/application-test.properties` - 测试配置

---

## 运行测试

```bash
cd backend
mvn test
```

现在测试应该可以正常运行了！

---

## 注意事项

1. **H2 与 MySQL 语法差异**
   - 使用 `MODE=MySQL` 模式，让 H2 兼容 MySQL 语法
   - 某些 MySQL 特性可能不支持，需要调整

2. **测试数据隔离**
   - 使用 `@Transactional` 确保测试后回滚
   - 每个测试使用独立的测试数据

3. **Redis 配置**
   - 如果测试需要 Redis，可以使用：
     - Testcontainers（推荐）
     - 嵌入式 Redis
     - Mock Redis

---

## 后续优化建议

1. **使用 Testcontainers**
   - 更真实的测试环境
   - 支持 MySQL、Redis 等

2. **Mock 外部依赖**
   - 使用 Mockito 模拟 Service
   - 减少对数据库的依赖

3. **测试数据管理**
   - 使用 @Sql 注解加载测试数据
   - 更灵活的测试数据管理

