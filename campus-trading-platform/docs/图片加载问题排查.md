# 图片加载问题排查

## 问题分析

图片加载失败的可能原因：

1. **数据库中的图片路径是 `localhost:8080`**
   - 生产环境应该使用服务器IP或相对路径

2. **图片文件不存在**
   - 数据库中有路径，但实际文件没有上传到服务器

3. **后端文件路径配置问题**
   - `userFilePath` 配置可能不正确

4. **Nginx 代理配置问题**
   - 图片请求可能没有正确代理到后端

## 立即排查

在服务器上执行：

```bash
cd /opt/campus-trading-platform

# 1. 检查图片文件是否存在
sudo docker compose exec backend ls -la /opt/upload

# 2. 检查后端日志（查看图片请求）
sudo docker compose logs backend | grep -i image | tail -20

# 3. 测试图片接口
curl -I http://localhost:8080/image?imageName=test.jpg

# 4. 检查数据库中的图片路径
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "USE second_hand_trading; SELECT id, idle_name, picture_list FROM sh_idle_item LIMIT 5;"
```

## 解决方案

### 方案 1：修复数据库中的图片路径（推荐）

将 `localhost:8080` 改为相对路径或服务器IP：

```bash
# 在服务器上执行
cd /opt/campus-trading-platform

# 更新数据库中的图片路径（将 localhost:8080 改为 /api）
sudo docker compose exec mysql mysql -u root -proot123456 second_hand_trading << 'EOF'
UPDATE sh_idle_item 
SET picture_list = REPLACE(picture_list, 'http://localhost:8080', '/api');

UPDATE sh_user 
SET avatar = REPLACE(avatar, 'http://localhost:8080', '/api');
EOF

# 验证更新
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "USE second_hand_trading; SELECT id, picture_list FROM sh_idle_item LIMIT 3;"
```

### 方案 2：确保图片文件存在

```bash
# 检查上传目录
sudo docker compose exec backend ls -la /opt/upload

# 如果目录为空，需要上传图片文件
# 或者让用户重新上传图片
```

### 方案 3：检查 Nginx 配置

确保 Nginx 正确代理图片请求：

```bash
# 检查 Nginx 配置
sudo docker compose exec frontend cat /etc/nginx/conf.d/default.conf

# 应该包含：
# location /api/ {
#     proxy_pass http://backend:8080/;
# }
```

## 快速修复脚本

```bash
cd /opt/campus-trading-platform

echo "=== 1. 检查图片目录 ==="
sudo docker compose exec backend ls -la /opt/upload | head -10

echo "=== 2. 检查数据库中的图片路径 ==="
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "USE second_hand_trading; SELECT id, LEFT(picture_list, 50) as path FROM sh_idle_item WHERE picture_list LIKE '%localhost%' LIMIT 5;" 2>&1

echo "=== 3. 更新图片路径（localhost -> /api）==="
sudo docker compose exec mysql mysql -u root -proot123456 second_hand_trading << 'EOF'
UPDATE sh_idle_item 
SET picture_list = REPLACE(picture_list, 'http://localhost:8080', '/api')
WHERE picture_list LIKE '%localhost%';

UPDATE sh_user 
SET avatar = REPLACE(avatar, 'http://localhost:8080', '/api')
WHERE avatar LIKE '%localhost%';
EOF

echo "=== 4. 验证更新 ==="
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "USE second_hand_trading; SELECT COUNT(*) as updated_count FROM sh_idle_item WHERE picture_list LIKE '%/api%';" 2>&1

echo "=== 5. 测试图片接口 ==="
curl -I http://localhost:8080/api/image?imageName=test.jpg 2>&1 | head -5
```

## 如果图片文件不存在

如果数据库中有路径但文件不存在，有两个选择：

### 选择 1：使用占位图片

```bash
# 创建一个占位图片
sudo docker compose exec backend mkdir -p /opt/upload
# 上传一个默认图片到 /opt/upload/default.jpg
```

### 选择 2：让用户重新上传

前端应该允许用户重新上传图片。

## 验证修复

修复后，在浏览器中：

1. 打开开发者工具（F12）
2. 查看 Network 标签
3. 刷新页面
4. 查看图片请求：
   - 应该请求 `/api/image?imageName=xxx`
   - 不应该请求 `localhost:8080`

