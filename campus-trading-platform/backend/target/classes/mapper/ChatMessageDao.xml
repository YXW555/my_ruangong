<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.second.hand.trading.server.dao.ChatMessageDao">
  <resultMap id="BaseResultMap" type="com.second.hand.trading.server.entity.ChatMessageModel">
    <id column="id" jdbcType="BIGINT" property="id"/>
    <result column="from_user" jdbcType="BIGINT" property="fromUser"/>
    <result column="to_user" jdbcType="BIGINT" property="toUser"/>
    <result column="idle_id" jdbcType="BIGINT" property="idleId"/>
    <result column="content" jdbcType="VARCHAR" property="content"/>
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
    <result column="is_read" jdbcType="TINYINT" property="isRead"/>
  </resultMap>

  <sql id="Base_Column_List">
    id, from_user, to_user, idle_id, content, create_time, is_read
  </sql>

  <insert id="insert" keyColumn="id" keyProperty="id"
          parameterType="com.second.hand.trading.server.entity.ChatMessageModel"
          useGeneratedKeys="true">
    insert into sh_chat_message (from_user, to_user, idle_id, content, create_time, is_read)
    values (#{fromUser,jdbcType=BIGINT},
            #{toUser,jdbcType=BIGINT},
            #{idleId,jdbcType=BIGINT},
            #{content,jdbcType=VARCHAR},
            #{createTime,jdbcType=TIMESTAMP},
            #{isRead,jdbcType=TINYINT})
  </insert>

  <select id="getAllUserChat" parameterType="java.lang.Long" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List"/>
    from sh_chat_message
    where from_user = #{userId,jdbcType=BIGINT}
       or to_user = #{userId,jdbcType=BIGINT}
    order by id desc
  </select>

  <select id="getChatDetail" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List"/>
    from sh_chat_message
    where ((from_user = #{userId,jdbcType=BIGINT} and to_user = #{targetUserId,jdbcType=BIGINT})
        or (from_user = #{targetUserId,jdbcType=BIGINT} and to_user = #{userId,jdbcType=BIGINT}))
      and ( (#{idleId,jdbcType=BIGINT} is null and idle_id is null)
         or idle_id = #{idleId,jdbcType=BIGINT} )
    order by id asc
  </select>

  <update id="markRead">
    update sh_chat_message
    set is_read = 1
    where to_user = #{userId,jdbcType=BIGINT}
      and ((from_user = #{targetUserId,jdbcType=BIGINT} and to_user = #{userId,jdbcType=BIGINT})
        or (from_user = #{userId,jdbcType=BIGINT} and to_user = #{targetUserId,jdbcType=BIGINT}))
      and ( (#{idleId,jdbcType=BIGINT} is null and idle_id is null)
         or idle_id = #{idleId,jdbcType=BIGINT} )
      and is_read = 0
  </update>
</mapper>


