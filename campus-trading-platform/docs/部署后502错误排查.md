# 部署后 502 错误排查

## 问题现象

GitHub Actions 运行成功，但访问网站出现 502 错误。

## 立即排查步骤

在服务器上执行以下命令：

```bash
# 1. 检查容器状态
cd /opt/campus-trading-platform
sudo docker compose ps

# 2. 查看所有容器日志
sudo docker compose logs --tail=50

# 3. 查看前端日志（重点）
sudo docker compose logs --tail=50 frontend

# 4. 查看后端日志（重点）
sudo docker compose logs --tail=50 backend

# 5. 检查 nginx 配置是否正确
sudo docker compose exec frontend cat /etc/nginx/conf.d/default.conf

# 6. 测试后端是否可访问
sudo docker compose exec frontend wget -O- http://backend:8080 || echo "后端不可访问"
```

## 常见问题

### 问题 1: nginx 配置错误

如果 nginx.conf 文件有问题，前端容器可能无法启动。

**检查**：
```bash
sudo docker compose logs frontend | grep -i error
```

**解决**：检查 nginx.conf 文件语法是否正确。

### 问题 2: 前端容器启动失败

**检查**：
```bash
sudo docker compose ps frontend
# 如果状态不是 Up，说明启动失败
```

**查看详细错误**：
```bash
sudo docker compose logs frontend
```

### 问题 3: 后端容器未启动

**检查**：
```bash
sudo docker compose ps backend
```

**如果后端未启动，前端 nginx 代理会失败，导致 502**。

### 问题 4: 网络连接问题

**检查容器间网络**：
```bash
# 在前端容器中测试连接后端
sudo docker compose exec frontend ping -c 2 backend

# 测试 HTTP 连接
sudo docker compose exec frontend wget -O- http://backend:8080
```

## 快速修复命令

```bash
cd /opt/campus-trading-platform

# 1. 查看所有容器状态
sudo docker compose ps

# 2. 如果前端容器有问题，重启
sudo docker compose restart frontend

# 3. 如果后端容器有问题，重启
sudo docker compose restart backend

# 4. 查看实时日志
sudo docker compose logs -f
```

## 如果 nginx 配置有问题

检查 nginx 配置语法：

```bash
# 进入前端容器
sudo docker compose exec frontend sh

# 测试 nginx 配置
nginx -t

# 如果配置有错误，会显示错误信息
```

## 完整排查脚本

```bash
#!/bin/bash
cd /opt/campus-trading-platform

echo "=== 1. 容器状态 ==="
sudo docker compose ps

echo -e "\n=== 2. 前端日志（最后50行）==="
sudo docker compose logs --tail=50 frontend

echo -e "\n=== 3. 后端日志（最后50行）==="
sudo docker compose logs --tail=50 backend

echo -e "\n=== 4. 测试后端连接 ==="
sudo docker compose exec frontend wget -O- http://backend:8080 2>&1 | head -5 || echo "后端连接失败"

echo -e "\n=== 5. 检查 nginx 配置 ==="
sudo docker compose exec frontend nginx -t 2>&1 || echo "nginx 配置检查失败"
```

保存为 `check-502.sh`，然后执行：
```bash
chmod +x check-502.sh
./check-502.sh
```

