{"remainingRequest":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\babel-loader\\lib\\index.js!D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\cache-loader\\dist\\cjs.js??ref--0-0!D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\src\\components\\page\\chat.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\src\\components\\page\\chat.vue","mtime":1766055364645},{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1678197338000},{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\babel-loader\\lib\\index.js","mtime":1678197338000},{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1678197338000},{"path":"D:\\Git\\my_ruangong\\campus-trading-platform\\frontend\\node_modules\\vue-loader\\lib\\index.js","mtime":1678197338000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.number.constructor\";\nimport \"regenerator-runtime/runtime\";\nimport _asyncToGenerator from \"D:/Git/my_ruangong/campus-trading-platform/frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport \"core-js/modules/es6.regexp.to-string\";\nimport \"core-js/modules/es6.regexp.split\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport AppHead from \"../common/AppHeader.vue\";\nimport AppBody from \"../common/AppPageBody.vue\";\nimport AppFoot from \"../common/AppFoot.vue\";\nexport default {\n  name: \"chat\",\n  components: {\n    AppHead: AppHead,\n    AppBody: AppBody,\n    AppFoot: AppFoot\n  },\n  data: function data() {\n    return {\n      sessionList: [],\n      messageList: [],\n      inputContent: '',\n      currentUserId: null,\n      currentSessionKey: '',\n      currentTargetUserId: null,\n      currentIdleId: null,\n      currentChatTarget: null,\n      currentIdle: null\n    };\n  },\n  created: function created() {\n    var _this = this;\n\n    this.currentUserId = this.getCookie('shUserId');\n    var targetUserId = this.$route.query.targetUserId;\n    var idleId = this.$route.query.idleId;\n    this.loadSessionList().then(function () {\n      if (targetUserId) {\n        _this.openSessionByTarget(targetUserId, idleId);\n      }\n    });\n  },\n  methods: {\n    getCookie: function getCookie(cname) {\n      var name = cname + \"=\";\n      var ca = document.cookie.split(';');\n\n      for (var i = 0; i < ca.length; i++) {\n        var c = ca[i].trim();\n        if (c.indexOf(name) === 0) return c.substring(name.length, c.length);\n      }\n\n      return \"\";\n    },\n    formatTime: function formatTime(timeStr) {\n      if (!timeStr) return '';\n      return timeStr.toString().substring(0, 16);\n    },\n    getSessionKey: function getSessionKey(session) {\n      var from = session.fromUser;\n      var to = session.toUser;\n      var idleId = session.idleId || 0;\n      var small = from < to ? from : to;\n      var big = from < to ? to : from;\n      return \"\".concat(small, \"_\").concat(big, \"_\").concat(idleId);\n    },\n    getDisplayUser: function getDisplayUser(session) {\n      if (!session) return {};\n      if (!this.currentUserId) return session.toU || session.fromU || {};\n\n      if (session.fromUser == this.currentUserId) {\n        return session.toU || {};\n      }\n\n      return session.fromU || {};\n    },\n    loadSessionList: function () {\n      var _loadSessionList = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {\n        var res;\n        return regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.prev = 0;\n                _context.next = 3;\n                return this.$api.getChatSessionList();\n\n              case 3:\n                res = _context.sent;\n\n                if (res.status_code === 1 && res.data) {\n                  this.sessionList = res.data;\n                }\n\n                _context.next = 9;\n                break;\n\n              case 7:\n                _context.prev = 7;\n                _context.t0 = _context[\"catch\"](0);\n\n              case 9:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this, [[0, 7]]);\n      }));\n\n      function loadSessionList() {\n        return _loadSessionList.apply(this, arguments);\n      }\n\n      return loadSessionList;\n    }(),\n    loadSessionDetail: function () {\n      var _loadSessionDetail = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee2(targetUserId, idleId) {\n        var _this2 = this;\n\n        var res;\n        return regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.prev = 0;\n                _context2.next = 3;\n                return this.$api.getChatSessionDetail({\n                  targetUserId: targetUserId,\n                  idleId: idleId\n                });\n\n              case 3:\n                res = _context2.sent;\n\n                if (res.status_code === 1 && res.data) {\n                  this.messageList = res.data;\n                  this.$nextTick(function () {\n                    _this2.scrollToBottom();\n                  });\n                }\n\n                _context2.next = 9;\n                break;\n\n              case 7:\n                _context2.prev = 7;\n                _context2.t0 = _context2[\"catch\"](0);\n\n              case 9:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this, [[0, 7]]);\n      }));\n\n      function loadSessionDetail(_x, _x2) {\n        return _loadSessionDetail.apply(this, arguments);\n      }\n\n      return loadSessionDetail;\n    }(),\n    selectSession: function selectSession(session) {\n      this.currentSessionKey = this.getSessionKey(session);\n      this.currentTargetUserId = session.fromUser == this.currentUserId ? session.toUser : session.fromUser;\n      this.currentIdleId = session.idleId || null;\n      this.currentChatTarget = this.getDisplayUser(session);\n      this.currentIdle = session.idle || null;\n      this.loadSessionDetail(this.currentTargetUserId, this.currentIdleId);\n    },\n    openSessionByTarget: function openSessionByTarget(targetUserId, idleId) {\n      // 尝试在现有会话中找到\n      var found = null;\n\n      for (var i = 0; i < this.sessionList.length; i++) {\n        var s = this.sessionList[i];\n        var otherId = s.fromUser == this.currentUserId ? s.toUser : s.fromUser;\n        var idle = s.idleId || null;\n\n        if (otherId == targetUserId && (idleId == null || idle == idleId)) {\n          found = s;\n          break;\n        }\n      }\n\n      if (found) {\n        this.selectSession(found);\n      } else {\n        // 没有历史记录时，仅设置当前会话上下文，等待第一条消息发送\n        this.currentTargetUserId = Number(targetUserId);\n        this.currentIdleId = idleId ? Number(idleId) : null;\n        this.currentChatTarget = null;\n        this.currentIdle = null;\n        this.messageList = [];\n      }\n    },\n    scrollToBottom: function scrollToBottom() {\n      var box = this.$refs.messageListRef;\n\n      if (box) {\n        box.scrollTop = box.scrollHeight;\n      }\n    },\n    handleSend: function () {\n      var _handleSend = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee3() {\n        var content, contentList, html, i, res;\n        return regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                content = this.inputContent.trim();\n\n                if (content) {\n                  _context3.next = 4;\n                  break;\n                }\n\n                this.$message.error(\"发送内容不能为空！\");\n                return _context3.abrupt(\"return\");\n\n              case 4:\n                if (this.currentTargetUserId) {\n                  _context3.next = 7;\n                  break;\n                }\n\n                this.$message.error(\"请选择会话或从商品详情页发起私聊！\");\n                return _context3.abrupt(\"return\");\n\n              case 7:\n                _context3.prev = 7;\n                contentList = content.split(/\\r?\\n/);\n                html = contentList[0];\n\n                for (i = 1; i < contentList.length; i++) {\n                  html += '<br>' + contentList[i];\n                }\n\n                _context3.next = 13;\n                return this.$api.sendChatMessage({\n                  toUser: this.currentTargetUserId,\n                  idleId: this.currentIdleId,\n                  content: html\n                });\n\n              case 13:\n                res = _context3.sent;\n\n                if (!(res.status_code === 1)) {\n                  _context3.next = 22;\n                  break;\n                }\n\n                this.inputContent = '';\n                _context3.next = 18;\n                return this.loadSessionDetail(this.currentTargetUserId, this.currentIdleId);\n\n              case 18:\n                _context3.next = 20;\n                return this.loadSessionList();\n\n              case 20:\n                _context3.next = 23;\n                break;\n\n              case 22:\n                this.$message.error(\"发送失败：\" + res.msg);\n\n              case 23:\n                _context3.next = 28;\n                break;\n\n              case 25:\n                _context3.prev = 25;\n                _context3.t0 = _context3[\"catch\"](7);\n                this.$message.error(\"发送失败！\");\n\n              case 28:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this, [[7, 25]]);\n      }));\n\n      function handleSend() {\n        return _handleSend.apply(this, arguments);\n      }\n\n      return handleSend;\n    }()\n  }\n};",{"version":3,"sources":["chat.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\r\n    <div>\r\n        <app-head></app-head>\r\n        <app-body>\r\n            <div class=\"chat-container\">\r\n                <!-- 会话列表 -->\r\n                <div class=\"chat-session-list\">\r\n                    <div class=\"session-list-header\">\r\n                        <span>消息</span>\r\n                    </div>\r\n                    <div v-if=\"sessionList.length === 0\" class=\"session-empty\">\r\n                        暂无会话，去商品页发起私聊吧～\r\n                    </div>\r\n                    <div v-else>\r\n                        <div\r\n                                v-for=\"(session,index) in sessionList\"\r\n                                :key=\"session.id\"\r\n                                :class=\"['session-item', currentSessionKey === getSessionKey(session) ? 'active' : '']\"\r\n                                @click=\"selectSession(session)\"\r\n                        >\r\n                            <el-image\r\n                                    class=\"session-avatar\"\r\n                                    :src=\"getDisplayUser(session).avatar\"\r\n                                    fit=\"cover\"\r\n                            ></el-image>\r\n                            <div class=\"session-info\">\r\n                                <div class=\"session-top\">\r\n                                    <span class=\"session-name\">{{ getDisplayUser(session).nickname }}</span>\r\n                                    <span class=\"session-time\">{{ formatTime(session.createTime) }}</span>\r\n                                </div>\r\n                                <div class=\"session-bottom\">\r\n                                    <span class=\"session-last\">{{ session.content }}</span>\r\n                                    <span v-if=\"session.idle\" class=\"session-goods-name\">\r\n                                        · {{ session.idle.idleName }}\r\n                                    </span>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- 聊天窗口 -->\r\n                <div class=\"chat-session-panel\">\r\n                    <div class=\"chat-header\" v-if=\"currentChatTarget\">\r\n                        <div class=\"chat-header-left\">\r\n                            <el-avatar :size=\"40\" :src=\"currentChatTarget.avatar\"></el-avatar>\r\n                            <div class=\"chat-header-text\">\r\n                                <div class=\"chat-header-name\">{{ currentChatTarget.nickname }}</div>\r\n                                <div class=\"chat-header-sub\" v-if=\"currentIdle\">\r\n                                    正在沟通：{{ currentIdle.idleName }}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"chat-header\" v-else>\r\n                        <div class=\"chat-header-empty\">\r\n                            请选择左侧的会话或从商品详情页点击“私聊”发起会话\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div class=\"chat-message-list\" ref=\"messageListRef\">\r\n                        <div v-if=\"messageList.length === 0\" class=\"chat-message-empty\">\r\n                            暂无聊天记录\r\n                        </div>\r\n                        <div\r\n                                v-else\r\n                                v-for=\"msg in messageList\"\r\n                                :key=\"msg.id\"\r\n                                :class=\"['chat-message-row', msg.fromUser == currentUserId ? 'self' : 'other']\"\r\n                        >\r\n                            <el-avatar\r\n                                    :size=\"32\"\r\n                                    :src=\"msg.fromU && msg.fromU.avatar\"\r\n                                    class=\"chat-message-avatar\"\r\n                            ></el-avatar>\r\n                            <div class=\"chat-message-bubble\">\r\n                                <div class=\"chat-message-content\" v-html=\"msg.content\"></div>\r\n                                <div class=\"chat-message-time\">{{ formatTime(msg.createTime) }}</div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div class=\"chat-input-bar\">\r\n                        <el-input\r\n                                type=\"textarea\"\r\n                                :rows=\"3\"\r\n                                placeholder=\"请输入要发送的内容...\"\r\n                                v-model=\"inputContent\"\r\n                                maxlength=\"200\"\r\n                                show-word-limit\r\n                                @keyup.enter.native.exact.prevent=\"handleSend\"\r\n                        ></el-input>\r\n                        <div class=\"chat-input-actions\">\r\n                            <el-button type=\"primary\" icon=\"el-icon-s-promotion\" @click=\"handleSend\" :disabled=\"!currentTargetUserId\">\r\n                                发送\r\n                            </el-button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <app-foot></app-foot>\r\n        </app-body>\r\n    </div>\r\n</template>\r\n\r\n<script>\r\n    import AppHead from '../common/AppHeader.vue';\r\n    import AppBody from '../common/AppPageBody.vue';\r\n    import AppFoot from '../common/AppFoot.vue';\r\n\r\n    export default {\r\n        name: \"chat\",\r\n        components: {\r\n            AppHead,\r\n            AppBody,\r\n            AppFoot\r\n        },\r\n        data() {\r\n            return {\r\n                sessionList: [],\r\n                messageList: [],\r\n                inputContent: '',\r\n                currentUserId: null,\r\n                currentSessionKey: '',\r\n                currentTargetUserId: null,\r\n                currentIdleId: null,\r\n                currentChatTarget: null,\r\n                currentIdle: null\r\n            };\r\n        },\r\n        created() {\r\n            this.currentUserId = this.getCookie('shUserId');\r\n            const targetUserId = this.$route.query.targetUserId;\r\n            const idleId = this.$route.query.idleId;\r\n            this.loadSessionList().then(() => {\r\n                if (targetUserId) {\r\n                    this.openSessionByTarget(targetUserId, idleId);\r\n                }\r\n            });\r\n        },\r\n        methods: {\r\n            getCookie(cname) {\r\n                const name = cname + \"=\";\r\n                const ca = document.cookie.split(';');\r\n                for (let i = 0; i < ca.length; i++) {\r\n                    let c = ca[i].trim();\r\n                    if (c.indexOf(name) === 0) return c.substring(name.length, c.length);\r\n                }\r\n                return \"\";\r\n            },\r\n            formatTime(timeStr) {\r\n                if (!timeStr) return '';\r\n                return timeStr.toString().substring(0, 16);\r\n            },\r\n            getSessionKey(session) {\r\n                const from = session.fromUser;\r\n                const to = session.toUser;\r\n                const idleId = session.idleId || 0;\r\n                const small = from < to ? from : to;\r\n                const big = from < to ? to : from;\r\n                return `${small}_${big}_${idleId}`;\r\n            },\r\n            getDisplayUser(session) {\r\n                if (!session) return {};\r\n                if (!this.currentUserId) return session.toU || session.fromU || {};\r\n                if (session.fromUser == this.currentUserId) {\r\n                    return session.toU || {};\r\n                }\r\n                return session.fromU || {};\r\n            },\r\n            async loadSessionList() {\r\n                try {\r\n                    const res = await this.$api.getChatSessionList();\r\n                    if (res.status_code === 1 && res.data) {\r\n                        this.sessionList = res.data;\r\n                    }\r\n                } catch (e) {\r\n                }\r\n            },\r\n            async loadSessionDetail(targetUserId, idleId) {\r\n                try {\r\n                    const res = await this.$api.getChatSessionDetail({\r\n                        targetUserId: targetUserId,\r\n                        idleId: idleId\r\n                    });\r\n                    if (res.status_code === 1 && res.data) {\r\n                        this.messageList = res.data;\r\n                        this.$nextTick(() => {\r\n                            this.scrollToBottom();\r\n                        });\r\n                    }\r\n                } catch (e) {\r\n                }\r\n            },\r\n            selectSession(session) {\r\n                this.currentSessionKey = this.getSessionKey(session);\r\n                this.currentTargetUserId = (session.fromUser == this.currentUserId) ? session.toUser : session.fromUser;\r\n                this.currentIdleId = session.idleId || null;\r\n                this.currentChatTarget = this.getDisplayUser(session);\r\n                this.currentIdle = session.idle || null;\r\n                this.loadSessionDetail(this.currentTargetUserId, this.currentIdleId);\r\n            },\r\n            openSessionByTarget(targetUserId, idleId) {\r\n                // 尝试在现有会话中找到\r\n                let found = null;\r\n                for (let i = 0; i < this.sessionList.length; i++) {\r\n                    const s = this.sessionList[i];\r\n                    const otherId = (s.fromUser == this.currentUserId) ? s.toUser : s.fromUser;\r\n                    const idle = s.idleId || null;\r\n                    if (otherId == targetUserId && (idleId == null || idle == idleId)) {\r\n                        found = s;\r\n                        break;\r\n                    }\r\n                }\r\n                if (found) {\r\n                    this.selectSession(found);\r\n                } else {\r\n                    // 没有历史记录时，仅设置当前会话上下文，等待第一条消息发送\r\n                    this.currentTargetUserId = Number(targetUserId);\r\n                    this.currentIdleId = idleId ? Number(idleId) : null;\r\n                    this.currentChatTarget = null;\r\n                    this.currentIdle = null;\r\n                    this.messageList = [];\r\n                }\r\n            },\r\n            scrollToBottom() {\r\n                const box = this.$refs.messageListRef;\r\n                if (box) {\r\n                    box.scrollTop = box.scrollHeight;\r\n                }\r\n            },\r\n            async handleSend() {\r\n                const content = this.inputContent.trim();\r\n                if (!content) {\r\n                    this.$message.error(\"发送内容不能为空！\");\r\n                    return;\r\n                }\r\n                if (!this.currentTargetUserId) {\r\n                    this.$message.error(\"请选择会话或从商品详情页发起私聊！\");\r\n                    return;\r\n                }\r\n                try {\r\n                    const contentList = content.split(/\\r?\\n/);\r\n                    let html = contentList[0];\r\n                    for (let i = 1; i < contentList.length; i++) {\r\n                        html += '<br>' + contentList[i];\r\n                    }\r\n                    const res = await this.$api.sendChatMessage({\r\n                        toUser: this.currentTargetUserId,\r\n                        idleId: this.currentIdleId,\r\n                        content: html\r\n                    });\r\n                    if (res.status_code === 1) {\r\n                        this.inputContent = '';\r\n                        await this.loadSessionDetail(this.currentTargetUserId, this.currentIdleId);\r\n                        await this.loadSessionList();\r\n                    } else {\r\n                        this.$message.error(\"发送失败：\" + res.msg);\r\n                    }\r\n                } catch (e) {\r\n                    this.$message.error(\"发送失败！\");\r\n                }\r\n            }\r\n        }\r\n    }\r\n</script>\r\n\r\n<style scoped>\r\n    .chat-container {\r\n        min-height: 85vh;\r\n        display: flex;\r\n        border: 1px solid #ebeef5;\r\n        border-radius: 8px;\r\n        overflow: hidden;\r\n    }\r\n\r\n    .chat-session-list {\r\n        width: 320px;\r\n        border-right: 1px solid #ebeef5;\r\n        background-color: #fafafa;\r\n        display: flex;\r\n        flex-direction: column;\r\n    }\r\n\r\n    .session-list-header {\r\n        padding: 16px;\r\n        font-size: 16px;\r\n        font-weight: 600;\r\n        border-bottom: 1px solid #ebeef5;\r\n    }\r\n\r\n    .session-empty {\r\n        flex: 1;\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n        color: #909399;\r\n        font-size: 13px;\r\n    }\r\n\r\n    .session-item {\r\n        display: flex;\r\n        padding: 10px 16px;\r\n        cursor: pointer;\r\n        transition: background-color .2s;\r\n    }\r\n\r\n    .session-item:hover {\r\n        background-color: #f0f2f5;\r\n    }\r\n\r\n    .session-item.active {\r\n        background-color: #e6f7ff;\r\n    }\r\n\r\n    .session-avatar {\r\n        width: 46px;\r\n        height: 46px;\r\n        border-radius: 50%;\r\n    }\r\n\r\n    .session-info {\r\n        flex: 1;\r\n        margin-left: 10px;\r\n        display: flex;\r\n        flex-direction: column;\r\n    }\r\n\r\n    .session-top {\r\n        display: flex;\r\n        justify-content: space-between;\r\n        align-items: center;\r\n        margin-bottom: 4px;\r\n    }\r\n\r\n    .session-name {\r\n        font-size: 14px;\r\n        font-weight: 600;\r\n        color: #303133;\r\n        max-width: 140px;\r\n        overflow: hidden;\r\n        text-overflow: ellipsis;\r\n        white-space: nowrap;\r\n    }\r\n\r\n    .session-time {\r\n        font-size: 12px;\r\n        color: #909399;\r\n    }\r\n\r\n    .session-bottom {\r\n        font-size: 13px;\r\n        color: #606266;\r\n        display: flex;\r\n        align-items: center;\r\n    }\r\n\r\n    .session-last {\r\n        max-width: 170px;\r\n        overflow: hidden;\r\n        text-overflow: ellipsis;\r\n        white-space: nowrap;\r\n    }\r\n\r\n    .session-goods-name {\r\n        margin-left: 4px;\r\n        color: #909399;\r\n        max-width: 110px;\r\n        overflow: hidden;\r\n        text-overflow: ellipsis;\r\n        white-space: nowrap;\r\n    }\r\n\r\n    .chat-session-panel {\r\n        flex: 1;\r\n        display: flex;\r\n        flex-direction: column;\r\n        background-color: #ffffff;\r\n    }\r\n\r\n    .chat-header {\r\n        height: 60px;\r\n        border-bottom: 1px solid #ebeef5;\r\n        display: flex;\r\n        align-items: center;\r\n        padding: 0 20px;\r\n    }\r\n\r\n    .chat-header-left {\r\n        display: flex;\r\n        align-items: center;\r\n    }\r\n\r\n    .chat-header-text {\r\n        margin-left: 10px;\r\n    }\r\n\r\n    .chat-header-name {\r\n        font-size: 15px;\r\n        font-weight: 600;\r\n        color: #303133;\r\n    }\r\n\r\n    .chat-header-sub {\r\n        margin-top: 4px;\r\n        font-size: 13px;\r\n        color: #909399;\r\n    }\r\n\r\n    .chat-header-empty {\r\n        font-size: 13px;\r\n        color: #909399;\r\n    }\r\n\r\n    .chat-message-list {\r\n        flex: 1;\r\n        padding: 16px 20px;\r\n        overflow-y: auto;\r\n        background-color: #f5f7fa;\r\n    }\r\n\r\n    .chat-message-empty {\r\n        height: 100%;\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n        color: #909399;\r\n        font-size: 13px;\r\n    }\r\n\r\n    .chat-message-row {\r\n        display: flex;\r\n        margin-bottom: 12px;\r\n    }\r\n\r\n    .chat-message-row.self {\r\n        flex-direction: row-reverse;\r\n    }\r\n\r\n    .chat-message-avatar {\r\n        margin: 0 8px;\r\n    }\r\n\r\n    .chat-message-bubble {\r\n        max-width: 60%;\r\n        padding: 10px 12px;\r\n        border-radius: 4px;\r\n        background-color: #ffffff;\r\n        box-shadow: 0 1px 3px rgba(0, 0, 0, .06);\r\n    }\r\n\r\n    .chat-message-row.self .chat-message-bubble {\r\n        background-color: #c6e2ff;\r\n    }\r\n\r\n    .chat-message-content {\r\n        font-size: 14px;\r\n        color: #303133;\r\n        word-break: break-word;\r\n    }\r\n\r\n    .chat-message-time {\r\n        margin-top: 4px;\r\n        font-size: 11px;\r\n        color: #909399;\r\n        text-align: right;\r\n    }\r\n\r\n    .chat-input-bar {\r\n        border-top: 1px solid #ebeef5;\r\n        padding: 10px 16px;\r\n        background-color: #ffffff;\r\n    }\r\n\r\n    .chat-input-actions {\r\n        display: flex;\r\n        justify-content: flex-end;\r\n        margin-top: 6px;\r\n    }\r\n\r\n    @media (max-width: 900px) {\r\n        .chat-container {\r\n            flex-direction: column;\r\n        }\r\n\r\n        .chat-session-list {\r\n            width: 100%;\r\n            border-right: none;\r\n            border-bottom: 1px solid #ebeef5;\r\n        }\r\n    }\r\n</style>\r\n\r\n\r\n"],"sourceRoot":"src/components/page"}]}