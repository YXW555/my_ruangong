# 模块化重构迁移指南

## 概述

本指南提供详细的步骤说明，帮助您将项目从分层架构迁移到模块化架构。

## 前置准备

### 1. 备份代码
```bash
git checkout -b refactoring/modular-architecture
git add .
git commit -m "备份：重构前的代码状态"
```

### 2. 创建目录结构

#### 方法一：使用PowerShell脚本（推荐）
```powershell
cd backend
powershell -ExecutionPolicy Bypass -File create-module-structure.ps1
```

#### 方法二：手动创建
在 `backend/src/main/java/com/second/hand/trading/server/` 下创建：
- `common/config`, `common/dto`, `common/enums`, `common/exception`, `common/utils`, `common/interceptor`
- `user/controller`, `user/service`, `user/dao`, `user/entity`
- 其他模块类似...

在 `backend/src/main/resources/mapper/` 下创建：
- `user/`, `product/`, `order/`, `membership/`, `merchant/`, `message/`, `rating/`, `favorite/`, `address/`, `admin/`

## 迁移步骤

### 阶段一：迁移Common模块（基础，必须先完成）

#### 1. 迁移DTO类

**文件：** `dto/ResultVo.java` → `common/dto/ResultVo.java`

**步骤：**
1. 复制文件到新位置
2. 更新package：
   ```java
   // 旧
   package com.second.hand.trading.server.dto;
   
   // 新
   package com.second.hand.trading.server.common.dto;
   ```
3. 更新import（如果有）：
   ```java
   // 旧
   import com.second.hand.trading.server.enums.ErrorMsg;
   
   // 新
   import com.second.hand.trading.server.common.enums.ErrorMsg;
   ```

**文件：** `dto/PageVo.java` → `common/dto/PageVo.java`
- 同样更新package为 `com.second.hand.trading.server.common.dto`

#### 2. 迁移枚举类

**文件：** `enums/ErrorMsg.java` → `common/enums/ErrorMsg.java`

**步骤：**
1. 复制文件
2. 更新package为 `com.second.hand.trading.server.common.enums`

#### 3. 迁移异常类

**文件：** `exception/ParamException.java` → `common/exception/ParamException.java`
**文件：** `exception/Handler/GlobalExceptionHandler.java` → `common/exception/GlobalExceptionHandler.java`

**步骤：**
1. 复制文件
2. 更新package为 `com.second.hand.trading.server.common.exception`
3. 更新所有import语句

#### 4. 迁移工具类

**文件：** `utils/IdFactoryUtil.java` → `common/utils/IdFactoryUtil.java`
**文件：** `utils/OrderTask.java` → `common/utils/OrderTask.java`
**文件：** `utils/OrderTaskHandler.java` → `common/utils/OrderTaskHandler.java`

**步骤：**
1. 复制文件
2. 更新package为 `com.second.hand.trading.server.common.utils`
3. 更新所有import语句

#### 5. 迁移配置类

**文件：** `config/CorsConfig.java` → `common/config/CorsConfig.java`
**文件：** `config/WebMvcConfig.java` → `common/config/WebMvcConfig.java`

**步骤：**
1. 复制文件
2. 更新package为 `com.second.hand.trading.server.common.config`
3. 更新所有import语句

#### 6. 迁移拦截器

**文件：** `LogCostInterceptor.java` → `common/interceptor/LogCostInterceptor.java`

**步骤：**
1. 复制文件
2. 更新package为 `com.second.hand.trading.server.common.interceptor`
3. 更新所有import语句

#### 7. 更新所有引用

使用IDE的"查找和替换"功能，全局替换：
- `com.second.hand.trading.server.dto` → `com.second.hand.trading.server.common.dto`
- `com.second.hand.trading.server.enums` → `com.second.hand.trading.server.common.enums`
- `com.second.hand.trading.server.exception` → `com.second.hand.trading.server.common.exception`
- `com.second.hand.trading.server.utils` → `com.second.hand.trading.server.common.utils`
- `com.second.hand.trading.server.config` → `com.second.hand.trading.server.common.config`

#### 8. 测试编译
```bash
mvn clean compile
```

### 阶段二：迁移User模块（示例）

#### 1. 迁移Controller

**文件：** `controller/UserController.java` → `user/controller/UserController.java`

**步骤：**
1. 复制文件
2. 更新package：
   ```java
   package com.second.hand.trading.server.user.controller;
   ```
3. 更新import：
   ```java
   // 旧
   import com.second.hand.trading.server.service.UserService;
   import com.second.hand.trading.server.entity.UserModel;
   import com.second.hand.trading.server.dto.ResultVo;
   
   // 新
   import com.second.hand.trading.server.user.service.UserService;
   import com.second.hand.trading.server.user.entity.UserModel;
   import com.second.hand.trading.server.common.dto.ResultVo;
   ```

#### 2. 迁移Service

**文件：** `service/UserService.java` → `user/service/UserService.java`
**文件：** `service/impl/UserServiceImpl.java` → `user/service/UserServiceImpl.java`

**步骤：**
1. 复制文件
2. 更新package为 `com.second.hand.trading.server.user.service`
3. 更新所有import语句

#### 3. 迁移Dao

**文件：** `dao/UserDao.java` → `user/dao/UserDao.java`

**步骤：**
1. 复制文件
2. 更新package为 `com.second.hand.trading.server.user.dao`

#### 4. 迁移Entity

**文件：** `entity/UserModel.java` → `user/entity/UserModel.java`

**步骤：**
1. 复制文件
2. 更新package为 `com.second.hand.trading.server.user.entity`

#### 5. 迁移Mapper XML

**文件：** `resources/mapper/UserDao.xml` → `resources/mapper/user/UserDao.xml`

**步骤：**
1. 复制文件
2. 更新namespace：
   ```xml
   <!-- 旧 -->
   <mapper namespace="com.second.hand.trading.server.dao.UserDao">
   
   <!-- 新 -->
   <mapper namespace="com.second.hand.trading.server.user.dao.UserDao">
   ```

#### 6. 更新所有引用User模块的import

全局替换：
- `com.second.hand.trading.server.controller.UserController` → `com.second.hand.trading.server.user.controller.UserController`
- `com.second.hand.trading.server.service.UserService` → `com.second.hand.trading.server.user.service.UserService`
- `com.second.hand.trading.server.entity.UserModel` → `com.second.hand.trading.server.user.entity.UserModel`
- `com.second.hand.trading.server.dao.UserDao` → `com.second.hand.trading.server.user.dao.UserDao`

#### 7. 测试编译
```bash
mvn clean compile
```

### 阶段三：迁移其他模块

按照相同的步骤迁移其他模块，建议顺序：
1. product（商品模块）
2. address（地址模块）
3. favorite（收藏模块）
4. order（订单模块）
5. payment（支付模块）
6. membership（会员模块）
7. merchant（商家模块）
8. message（消息模块）
9. rating（评价模块）
10. admin（后台管理模块）
11. file（文件管理模块）

## 使用IDE重构功能（推荐）

### IntelliJ IDEA

1. **移动文件**
   - 右键文件 → Refactor → Move
   - 选择目标目录
   - 勾选"Search in comments and strings"
   - IDE会自动更新所有引用

2. **重命名包**
   - 右键包 → Refactor → Rename
   - 输入新包名
   - IDE会自动更新所有引用

3. **全局替换**
   - Ctrl+Shift+R（Windows）或 Cmd+Shift+R（Mac）
   - 输入旧包名和新包名
   - 预览更改后应用

### Eclipse

1. **移动文件**
   - 右键文件 → Refactor → Move
   - 选择目标包
   - Eclipse会自动更新引用

2. **重命名包**
   - 右键包 → Refactor → Rename
   - 输入新包名

## 迁移检查清单

每个模块迁移后，检查：

- [ ] 所有文件已移动到正确位置
- [ ] 所有package声明已更新
- [ ] 所有import语句已更新
- [ ] Mapper XML的namespace已更新
- [ ] Mapper XML文件已移动到正确位置
- [ ] 项目可以编译通过
- [ ] 相关功能可以正常运行

## 常见问题

### Q1: 编译错误：找不到类
**A:** 检查import语句是否正确，确保所有引用都已更新。

### Q2: MyBatis找不到Mapper
**A:** 检查：
1. Mapper XML的namespace是否正确
2. Mapper XML文件是否在正确位置
3. application.yml中的mapper-locations配置是否正确

### Q3: Spring找不到Bean
**A:** 检查：
1. @Component、@Service等注解是否正确
2. @SpringBootApplication的scanBasePackages是否包含新包路径

## 完成后的验证

1. **编译测试**
   ```bash
   mvn clean compile
   ```

2. **运行测试**
   ```bash
   mvn test
   ```

3. **启动应用**
   ```bash
   mvn spring-boot:run
   ```

4. **功能测试**
   - 测试所有主要功能
   - 确保没有功能回退

## 回滚方案

如果重构出现问题，可以回滚：
```bash
git checkout main
git branch -D refactoring/modular-architecture
```

或者回滚到特定提交：
```bash
git log  # 查看提交历史
git reset --hard <commit-hash>
```

## 总结

模块化重构是一个渐进的过程，建议：
1. 一个模块一个模块地迁移
2. 每个模块迁移后立即测试
3. 使用Git提交每个模块的迁移
4. 遇到问题及时回滚

祝重构顺利！

