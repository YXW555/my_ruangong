# 数据库初始化 - 详细说明

## 什么是数据库初始化？

### 简单理解

1. **数据库（Database）**：就像一个空的仓库
   - 你已经有了 `second_hand_trading` 这个数据库（仓库）

2. **表（Table）**：就像仓库里的货架
   - 你需要创建 `sh_idle_item`（商品表）、`sh_user`（用户表）等"货架"
   - 这些"货架"的结构定义在 SQL 文件中

3. **SQL 文件**：就像"货架设计图纸"
   - 包含创建表结构的语句（CREATE TABLE）
   - 告诉 MySQL 如何创建这些"货架"

### 当前情况

- ✅ 数据库 `second_hand_trading` 已存在（仓库已建好）
- ❌ 表不存在（货架还没创建）
- ❌ SQL 文件不在服务器上（设计图纸不在服务器上）

## 解决步骤

### 第 1 步：上传 SQL 文件到服务器

SQL 文件在你的本地项目中：`campus-trading-platform/backend/second_hand_trading.sql`

**在本地电脑执行**（Windows PowerShell 或 Git Bash）：

```bash
# 上传 SQL 文件到服务器
scp campus-trading-platform/backend/second_hand_trading.sql root@你的服务器IP:/opt/campus-trading-platform/init.sql
```

**或者使用其他方法**：
- 使用 FTP 工具（如 FileZilla）
- 使用 WinSCP
- 或者直接在服务器上创建文件并复制内容

### 第 2 步：在服务器上验证文件已上传

```bash
# 在服务器上执行
cd /opt/campus-trading-platform
ls -la init.sql
# 应该能看到文件
```

### 第 3 步：导入 SQL 文件到数据库

```bash
# 在服务器上执行
cd /opt/campus-trading-platform

# 导入 SQL 文件（执行建表语句）
sudo docker compose exec -i mysql mysql -u root -proot123456 second_hand_trading < init.sql
```

这个命令会：
1. 读取 `init.sql` 文件
2. 连接到 MySQL 数据库
3. 执行文件中的所有 SQL 语句（CREATE TABLE 等）
4. 创建所有需要的表

### 第 4 步：验证表是否创建成功

```bash
# 查看所有表
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "USE second_hand_trading; SHOW TABLES;"

# 应该能看到很多表，比如：
# - sh_idle_item（商品表）
# - sh_user（用户表）
# - sh_order（订单表）
# 等等
```

### 第 5 步：重启后端服务

```bash
# 重启后端，让它重新连接数据库
sudo docker compose restart backend

# 查看日志确认
sudo docker compose logs -f backend
```

## 完整操作流程

### 在本地电脑（Windows PowerShell）：

```powershell
# 1. 进入项目目录
cd D:\Git\my_ruangong\campus-trading-platform

# 2. 上传 SQL 文件到服务器
scp backend/second_hand_trading.sql root@你的服务器IP:/opt/campus-trading-platform/init.sql
```

### 在服务器上：

```bash
# 1. 进入项目目录
cd /opt/campus-trading-platform

# 2. 确认文件已上传
ls -la init.sql

# 3. 导入数据库
sudo docker compose exec -i mysql mysql -u root -proot123456 second_hand_trading < init.sql

# 4. 验证表是否创建
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "USE second_hand_trading; SHOW TABLES;"

# 5. 重启后端
sudo docker compose restart backend

# 6. 测试（应该不再有 500 错误）
curl http://localhost:8080/api/idle/lable?idleLabel=1&page=1&nums=8
```

## 为什么需要这样做？

### MySQL 容器的初始化机制

`docker-compose.prod.yml` 中配置了：
```yaml
volumes:
  - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
```

这意味着：
- MySQL 容器**首次启动时**会自动执行 `/docker-entrypoint-initdb.d/` 目录中的 SQL 文件
- 但如果容器已经启动过了，即使后来添加了 SQL 文件，也不会自动执行
- 所以需要手动导入

## 如果 SQL 文件很大

如果 SQL 文件很大，上传可能比较慢，可以：

```bash
# 使用压缩上传（更快）
# 在本地
tar czf init.sql.tar.gz backend/second_hand_trading.sql
scp init.sql.tar.gz root@你的服务器IP:/tmp/

# 在服务器上
cd /opt/campus-trading-platform
tar xzf /tmp/init.sql.tar.gz -C .
mv backend/second_hand_trading.sql init.sql
```

## 验证导入是否成功

```bash
# 检查表数量（应该有多个表）
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "USE second_hand_trading; SELECT COUNT(*) as table_count FROM information_schema.tables WHERE table_schema = 'second_hand_trading';"

# 检查关键表是否存在
sudo docker compose exec mysql mysql -u trading_user -ptrading123456 -e "USE second_hand_trading; SHOW TABLES LIKE 'sh_%';"
```

## 总结

1. **SQL 文件** = 建表语句的集合
2. **需要上传**到服务器
3. **导入到数据库**后，MySQL 会执行这些语句创建表
4. **表创建后**，后端才能正常查询数据

现在按照上面的步骤操作即可！

