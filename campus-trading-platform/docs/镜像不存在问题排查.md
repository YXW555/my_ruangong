# 镜像不存在问题排查（403 Forbidden）

## 问题现象

执行 `docker compose pull` 时，错误信息显示：
```
failed to resolve reference "docker.io/yxw555/campus-trading-backend:latest": 403 Forbidden
```

这说明：
1. ✅ 镜像名称已经正确（不再是 yourusername）
2. ❌ 但镜像在 Docker Hub 上不存在或无法访问

## 可能的原因

1. **镜像还没有被推送到 Docker Hub**
   - GitHub Actions 的构建和推送步骤可能失败了
   - 或者还没有运行过

2. **Docker Hub 用户名不对**
   - 确认你的 Docker Hub 用户名确实是 `yxw555`

3. **镜像需要登录才能访问**
   - 镜像可能是私有的

## 排查步骤

### 1. 检查镜像是否存在于 Docker Hub

**方法 A：在浏览器中访问**
```
https://hub.docker.com/r/yxw555/campus-trading-backend
https://hub.docker.com/r/yxw555/campus-trading-frontend
```

**方法 B：使用命令检查**
```bash
# 检查后端镜像
curl -s https://hub.docker.com/v2/repositories/yxw555/campus-trading-backend/tags/ | grep -o '"name":"[^"]*"' | head -1

# 检查前端镜像
curl -s https://hub.docker.com/v2/repositories/yxw555/campus-trading-frontend/tags/ | grep -o '"name":"[^"]*"' | head -1
```

### 2. 检查 GitHub Actions 是否成功

1. 进入你的 GitHub 仓库
2. 点击 **Actions** 标签
3. 查看最近的工作流运行记录
4. 检查 **Docker Build & Push** 步骤是否成功

**如果失败了**：
- 查看错误日志
- 检查 GitHub Secrets 中的 `DOCKER_USERNAME` 和 `DOCKER_PASSWORD` 是否正确

### 3. 手动构建并推送镜像（临时方案）

如果 GitHub Actions 还没有成功，可以手动构建和推送：

```bash
# 在本地项目目录执行

# 1. 登录 Docker Hub
docker login

# 2. 构建后端镜像
cd campus-trading-platform/backend
docker build -t yxw555/campus-trading-backend:latest .

# 3. 推送后端镜像
docker push yxw555/campus-trading-backend:latest

# 4. 构建前端镜像
cd ../frontend
docker build -t yxw555/campus-trading-frontend:latest .

# 5. 推送前端镜像
docker push yxw555/campus-trading-frontend:latest
```

### 4. 触发 GitHub Actions 重新运行

如果 GitHub Actions 配置正确，可以：

1. 推送一个空提交来触发工作流：
   ```bash
   git commit --allow-empty -m "触发 CI/CD 构建镜像"
   git push origin main
   ```

2. 或者在 GitHub 上手动触发：
   - 进入 Actions 标签
   - 选择工作流
   - 点击 "Run workflow"

## 解决方案

### 方案 1：等待 GitHub Actions 完成（推荐）

1. 确保 GitHub Actions 工作流配置正确
2. 确保 GitHub Secrets 已配置：
   - `DOCKER_USERNAME` = `yxw555`
   - `DOCKER_PASSWORD` = 你的 Docker Hub 密码或访问令牌
3. 推送代码触发构建
4. 等待构建完成后再在服务器上拉取

### 方案 2：手动构建和推送（临时）

如果急需部署，可以手动构建：

```bash
# 在本地电脑执行
cd D:/Git/my_ruangong/campus-trading-platform

# 登录 Docker Hub
docker login

# 构建并推送后端
cd backend
docker build -t yxw555/campus-trading-backend:latest .
docker push yxw555/campus-trading-backend:latest

# 构建并推送前端
cd ../frontend
docker build -t yxw555/campus-trading-frontend:latest .
docker push yxw555/campus-trading-frontend:latest
```

### 方案 3：检查并修复 GitHub Actions

如果 GitHub Actions 一直失败，检查：

1. **GitHub Secrets 是否正确**：
   - `DOCKER_USERNAME` 应该是 `yxw555`
   - `DOCKER_PASSWORD` 应该是你的 Docker Hub 密码或访问令牌

2. **工作流文件是否正确**：
   - 检查 `.github/workflows/ci-cd.yml`
   - 确保 Docker 构建和推送步骤存在

3. **查看错误日志**：
   - 在 GitHub Actions 中查看详细的错误信息

## 验证镜像是否存在

执行以下命令检查：

```bash
# 在服务器上检查镜像是否存在
curl -I https://hub.docker.com/v2/repositories/yxw555/campus-trading-backend/

# 如果返回 200，说明仓库存在
# 如果返回 404，说明仓库不存在，需要先推送镜像
```

## 推荐操作流程

1. **先检查 GitHub Actions**：
   - 进入 GitHub 仓库 → Actions
   - 查看最近的构建是否成功
   - 如果不成功，查看错误日志

2. **如果构建成功，但镜像还是拉取不到**：
   - 检查 Docker Hub 用户名是否正确
   - 尝试在服务器上登录 Docker Hub：
     ```bash
     sudo docker login
     # 输入用户名 yxw555 和密码
     sudo docker compose pull
     ```

3. **如果构建失败**：
   - 检查 GitHub Secrets
   - 手动构建和推送镜像（方案 2）
   - 或者修复 GitHub Actions 配置

## 快速检查清单

- [ ] 检查 GitHub Actions 是否成功构建并推送了镜像
- [ ] 检查 Docker Hub 上是否存在镜像：https://hub.docker.com/r/yxw555/campus-trading-backend
- [ ] 检查 GitHub Secrets 中的 `DOCKER_USERNAME` 和 `DOCKER_PASSWORD` 是否正确
- [ ] 如果镜像不存在，手动构建并推送，或修复 GitHub Actions

