<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MembershipServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">server</a> &gt; <a href="index.source.html" class="el_package">com.second.hand.trading.server.service.impl</a> &gt; <span class="el_source">MembershipServiceImpl.java</span></div><h1>MembershipServiceImpl.java</h1><pre class="source lang-java linenums">package com.second.hand.trading.server.service.impl;

import com.second.hand.trading.server.dao.IdleItemDao;
import com.second.hand.trading.server.dao.IdleItemPinDao;
import com.second.hand.trading.server.dao.MembershipOrderDao;
import com.second.hand.trading.server.dao.UserDao;
import com.second.hand.trading.server.entity.MembershipOrderModel;
import com.second.hand.trading.server.entity.UserModel;
import com.second.hand.trading.server.service.MembershipService;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.Resource;
import java.math.BigDecimal;
import java.util.*;

@Service
<span class="fc" id="L18">public class MembershipServiceImpl implements MembershipService {</span>

    @Resource
    private MembershipOrderDao membershipOrderDao;

    @Resource
    private UserDao userDao;

    @Resource
    private IdleItemDao idleItemDao;

    @Resource
    private IdleItemPinDao idleItemPinDao;

    // 会员价格配置
<span class="fc" id="L33">    private static final BigDecimal BASIC_MONTHLY_PRICE = new BigDecimal(&quot;9.90&quot;);</span>
<span class="fc" id="L34">    private static final BigDecimal BASIC_YEARLY_PRICE = new BigDecimal(&quot;99.00&quot;);</span>
<span class="fc" id="L35">    private static final BigDecimal PREMIUM_MONTHLY_PRICE = new BigDecimal(&quot;19.90&quot;);</span>
<span class="fc" id="L36">    private static final BigDecimal PREMIUM_YEARLY_PRICE = new BigDecimal(&quot;199.00&quot;);</span>

    // 权限配置
    private static final int NORMAL_PUBLISH_LIMIT = 10; // 普通用户每月发布限制
    private static final int BASIC_PUBLISH_LIMIT = 20; // 基础会员每月发布限制
    private static final int BASIC_PIN_LIMIT = 5; // 基础会员每月置顶限制
    private static final int PREMIUM_PIN_LIMIT = 15; // 高级会员每月置顶限制

    @Override
    public MembershipOrderModel createOrder(Long userId, Byte membershipType, Integer durationMonths) {
<span class="nc" id="L46">        MembershipOrderModel order = new MembershipOrderModel();</span>
<span class="nc" id="L47">        order.setUserId(userId);</span>
<span class="nc" id="L48">        order.setMembershipType(membershipType);</span>
<span class="nc" id="L49">        order.setDurationMonths(durationMonths);</span>

        // 计算价格
        BigDecimal amount;
<span class="nc bnc" id="L53" title="All 2 branches missed.">        if (membershipType == 1) { // 基础会员</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">            amount = durationMonths &gt;= 12 ? BASIC_YEARLY_PRICE : BASIC_MONTHLY_PRICE.multiply(new BigDecimal(durationMonths));</span>
        } else { // 高级会员
<span class="nc bnc" id="L56" title="All 2 branches missed.">            amount = durationMonths &gt;= 12 ? PREMIUM_YEARLY_PRICE : PREMIUM_MONTHLY_PRICE.multiply(new BigDecimal(durationMonths));</span>
        }
<span class="nc" id="L58">        order.setAmount(amount);</span>

        // 生成订单号
<span class="nc" id="L61">        String orderNumber = &quot;MEM&quot; + System.currentTimeMillis() + userId;</span>
<span class="nc" id="L62">        order.setOrderNumber(orderNumber);</span>
<span class="nc" id="L63">        order.setPaymentStatus((byte) 0); // 待支付</span>
<span class="nc" id="L64">        order.setCreateTime(new Date());</span>

<span class="nc" id="L66">        membershipOrderDao.insert(order);</span>
<span class="nc" id="L67">        return order;</span>
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean activateMembership(String orderNumber) {
<span class="nc" id="L73">        MembershipOrderModel order = membershipOrderDao.selectByOrderNumber(orderNumber);</span>
<span class="nc bnc" id="L74" title="All 4 branches missed.">        if (order == null || order.getPaymentStatus() != 0) {</span>
<span class="nc" id="L75">            return false;</span>
        }

        // 更新订单状态
<span class="nc" id="L79">        order.setPaymentStatus((byte) 1); // 已支付</span>
<span class="nc" id="L80">        order.setPaymentTime(new Date());</span>
<span class="nc" id="L81">        order.setPaymentWay(&quot;支付宝&quot;); // 可以根据实际情况设置</span>
<span class="nc" id="L82">        membershipOrderDao.updateByPrimaryKeySelective(order);</span>

        // 更新用户会员信息
<span class="nc" id="L85">        UserModel user = userDao.selectByPrimaryKey(order.getUserId());</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L87">            return false;</span>
        }

<span class="nc" id="L90">        Date currentExpireTime = user.getMembershipExpireTime();</span>
        Date newExpireTime;

        // 如果当前会员未过期，在现有到期时间基础上延长
<span class="nc bnc" id="L94" title="All 4 branches missed.">        if (currentExpireTime != null &amp;&amp; currentExpireTime.after(new Date())) {</span>
<span class="nc" id="L95">            Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L96">            cal.setTime(currentExpireTime);</span>
<span class="nc" id="L97">            cal.add(Calendar.MONTH, order.getDurationMonths());</span>
<span class="nc" id="L98">            newExpireTime = cal.getTime();</span>
<span class="nc" id="L99">        } else {</span>
            // 如果会员已过期或从未开通，从当前时间开始计算
<span class="nc" id="L101">            Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L102">            cal.add(Calendar.MONTH, order.getDurationMonths());</span>
<span class="nc" id="L103">            newExpireTime = cal.getTime();</span>
        }

<span class="nc" id="L106">        user.setMembershipType(order.getMembershipType());</span>
<span class="nc" id="L107">        user.setMembershipExpireTime(newExpireTime);</span>
<span class="nc" id="L108">        userDao.updateByPrimaryKeySelective(user);</span>

<span class="nc" id="L110">        return true;</span>
    }

    @Override
    public boolean isMembershipValid(Long userId) {
<span class="nc" id="L115">        UserModel user = userDao.selectByPrimaryKey(userId);</span>
<span class="nc bnc" id="L116" title="All 6 branches missed.">        if (user == null || user.getMembershipType() == null || user.getMembershipType() == 0) {</span>
<span class="nc" id="L117">            return false;</span>
        }
<span class="nc" id="L119">        Date expireTime = user.getMembershipExpireTime();</span>
<span class="nc bnc" id="L120" title="All 4 branches missed.">        return expireTime != null &amp;&amp; expireTime.after(new Date());</span>
    }

    @Override
    public Byte getMembershipType(Long userId) {
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (!isMembershipValid(userId)) {</span>
<span class="nc" id="L126">            return (byte) 0;</span>
        }
<span class="nc" id="L128">        UserModel user = userDao.selectByPrimaryKey(userId);</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">        return user != null ? user.getMembershipType() : (byte) 0;</span>
    }

    @Override
    public Date getMembershipExpireTime(Long userId) {
<span class="nc" id="L134">        UserModel user = userDao.selectByPrimaryKey(userId);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">        return user != null ? user.getMembershipExpireTime() : null;</span>
    }

    @Override
    public boolean canPublishItem(Long userId) {
<span class="nc" id="L140">        Byte membershipType = getMembershipType(userId);</span>
        
        // 高级会员无限制
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (membershipType == 2) {</span>
<span class="nc" id="L144">            return true;</span>
        }

        // 检查本月发布数量
<span class="nc" id="L148">        int publishedCount = getPublishedCountThisMonth(userId);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        int limit = membershipType == 1 ? BASIC_PUBLISH_LIMIT : NORMAL_PUBLISH_LIMIT;</span>
        
<span class="nc bnc" id="L151" title="All 2 branches missed.">        return publishedCount &lt; limit;</span>
    }

    @Override
    public boolean canPinItem(Long userId) {
<span class="nc" id="L156">        Byte membershipType = getMembershipType(userId);</span>
        
        // 普通用户不能置顶
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (membershipType == 0) {</span>
<span class="nc" id="L160">            return false;</span>
        }

        // 检查当前有效置顶数量
<span class="nc" id="L164">        int activePinCount = getActivePinCount(userId);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        int limit = membershipType == 2 ? PREMIUM_PIN_LIMIT : BASIC_PIN_LIMIT;</span>
        
<span class="nc bnc" id="L167" title="All 2 branches missed.">        return activePinCount &lt; limit;</span>
    }

    @Override
    public int getPublishedCountThisMonth(Long userId) {
<span class="nc" id="L172">        Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L173">        cal.set(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L174">        cal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L175">        cal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L176">        cal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L177">        cal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L178">        Date monthStart = cal.getTime();</span>

<span class="nc" id="L180">        return idleItemDao.countByUserIdAndTimeRange(userId, monthStart, new Date());</span>
    }

    @Override
    public int getActivePinCount(Long userId) {
<span class="nc" id="L185">        return idleItemPinDao.countActivePinsByUserId(userId, new Date());</span>
    }

    @Override
    public List&lt;MembershipOrderModel&gt; getUserOrders(Long userId) {
<span class="nc" id="L190">        return membershipOrderDao.selectByUserId(userId);</span>
    }

    @Override
    public Map&lt;String, Object&gt; getMembershipRevenueStats(Date startDate, Date endDate) {
<span class="nc" id="L195">        Map&lt;String, Object&gt; stats = new HashMap&lt;&gt;();</span>
        
        // 总收入
<span class="nc" id="L198">        BigDecimal totalRevenue = membershipOrderDao.sumAmountByDateRange(startDate, endDate, (byte) 1);</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">        stats.put(&quot;totalRevenue&quot;, totalRevenue != null ? totalRevenue : BigDecimal.ZERO);</span>
        
        // 基础会员和高级会员收入
<span class="nc" id="L202">        List&lt;MembershipOrderModel&gt; paidOrders = membershipOrderDao.selectByPaymentStatus((byte) 1);</span>
<span class="nc" id="L203">        BigDecimal basicRevenue = BigDecimal.ZERO;</span>
<span class="nc" id="L204">        BigDecimal premiumRevenue = BigDecimal.ZERO;</span>
<span class="nc" id="L205">        int basicCount = 0;</span>
<span class="nc" id="L206">        int premiumCount = 0;</span>
        
<span class="nc bnc" id="L208" title="All 2 branches missed.">        for (MembershipOrderModel order : paidOrders) {</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">            if (order.getPaymentTime() != null &amp;&amp; </span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                order.getPaymentTime().compareTo(startDate) &gt;= 0 &amp;&amp; </span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">                order.getPaymentTime().before(endDate)) {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                if (order.getMembershipType() == 1) {</span>
<span class="nc" id="L213">                    basicRevenue = basicRevenue.add(order.getAmount());</span>
<span class="nc" id="L214">                    basicCount++;</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">                } else if (order.getMembershipType() == 2) {</span>
<span class="nc" id="L216">                    premiumRevenue = premiumRevenue.add(order.getAmount());</span>
<span class="nc" id="L217">                    premiumCount++;</span>
                }
            }
<span class="nc" id="L220">        }</span>
        
<span class="nc" id="L222">        stats.put(&quot;basicRevenue&quot;, basicRevenue);</span>
<span class="nc" id="L223">        stats.put(&quot;premiumRevenue&quot;, premiumRevenue);</span>
<span class="nc" id="L224">        stats.put(&quot;basicOrderCount&quot;, basicCount);</span>
<span class="nc" id="L225">        stats.put(&quot;premiumOrderCount&quot;, premiumCount);</span>
        
<span class="nc" id="L227">        return stats;</span>
    }

    @Override
    public Map&lt;String, Object&gt; getMembershipCountStats() {
<span class="nc" id="L232">        Map&lt;String, Object&gt; stats = new HashMap&lt;&gt;();</span>
        
        // 统计有效会员数量
<span class="nc" id="L235">        List&lt;UserModel&gt; allUsers = userDao.getUserList();</span>
<span class="nc" id="L236">        int basicCount = 0;</span>
<span class="nc" id="L237">        int premiumCount = 0;</span>
<span class="nc" id="L238">        Date now = new Date();</span>
        
<span class="nc bnc" id="L240" title="All 2 branches missed.">        for (UserModel user : allUsers) {</span>
<span class="nc bnc" id="L241" title="All 4 branches missed.">            if (user.getMembershipType() != null &amp;&amp; user.getMembershipExpireTime() != null) {</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">                if (user.getMembershipExpireTime().after(now)) {</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                    if (user.getMembershipType() == 1) {</span>
<span class="nc" id="L244">                        basicCount++;</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">                    } else if (user.getMembershipType() == 2) {</span>
<span class="nc" id="L246">                        premiumCount++;</span>
                    }
                }
            }
<span class="nc" id="L250">        }</span>
        
<span class="nc" id="L252">        stats.put(&quot;basicMemberCount&quot;, basicCount);</span>
<span class="nc" id="L253">        stats.put(&quot;premiumMemberCount&quot;, premiumCount);</span>
<span class="nc" id="L254">        stats.put(&quot;totalMemberCount&quot;, basicCount + premiumCount);</span>
        
<span class="nc" id="L256">        return stats;</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>